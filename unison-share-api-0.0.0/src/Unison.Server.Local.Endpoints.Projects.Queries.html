<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Server.Local.Endpoints.Projects.Queries</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Server.Local.Endpoints.Projects.Queries.html#listProjects"><span class="hs-identifier">listProjects</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Unison.Server.Local.Endpoints.Projects.Queries.html#listProjectBranches"><span class="hs-identifier">listProjectBranches</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.DbId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ProjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Server.Local.Endpoints.Projects.Types.html"><span class="hs-identifier">Unison.Server.Local.Endpoints.Projects.Types</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="annot"><span class="hs-comment">-- | Load all project listings, optionally requiring an infix match with a query.</span></span><span>
</span><span id="line-13"></span><span class="annot"><a href="Unison.Server.Local.Endpoints.Projects.Queries.html#listProjects"><span class="hs-identifier hs-type">listProjects</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Server.Local.Endpoints.Projects.Types.html#ProjectListing"><span class="hs-identifier hs-type">ProjectListing</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-14"></span><span id="listProjects"><span class="annot"><span class="annottext">listProjects :: Maybe Text -&gt; Transaction [ProjectListing]
</span><a href="Unison.Server.Local.Endpoints.Projects.Queries.html#listProjects"><span class="hs-identifier hs-var hs-var">listProjects</span></a></span></span><span> </span><span id="local-6989586621680061359"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680061359"><span class="hs-identifier hs-var">mayUnsafeQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680061360"><span class="annot"><span class="annottext">mayQuery :: Maybe Text
</span><a href="#local-6989586621680061360"><span class="hs-identifier hs-var hs-var">mayQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Maybe Text -&gt; Maybe Text
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Text -&gt; Text
</span><span class="hs-identifier hs-var">likeEscape</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\\'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680061359"><span class="hs-identifier hs-var">mayUnsafeQuery</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><span class="annottext">Sql -&gt; Transaction [ProjectListing]
forall a. (FromRow a, HasCallStack) =&gt; Sql -&gt; Transaction [a]
</span><span class="hs-identifier hs-var">queryListRow</span></span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="">[sql|
      SELECT project.name, branch.name
      FROM project
        LEFT JOIN most_recent_branch mrb
          ON project.id = mrb.project_id
        LEFT JOIN project_branch branch
          ON mrb.branch_id = branch.branch_id
        WHERE (:mayQuery IS NULL OR project.name LIKE '%' || :mayQuery || '%' ESCAPE '\')
      ORDER BY branch.last_accessed DESC NULLS LAST, project.name ASC
    |]</span></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="annot"><span class="hs-comment">-- | Load all project listings, optionally requiring an infix match with a query.</span></span><span>
</span><span id="line-29"></span><span class="annot"><a href="Unison.Server.Local.Endpoints.Projects.Queries.html#listProjectBranches"><span class="hs-identifier hs-type">listProjectBranches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Server.Local.Endpoints.Projects.Types.html#ProjectBranchListing"><span class="hs-identifier hs-type">ProjectBranchListing</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-30"></span><span id="listProjectBranches"><span class="annot"><span class="annottext">listProjectBranches :: ProjectId -&gt; Maybe Text -&gt; Transaction [ProjectBranchListing]
</span><a href="Unison.Server.Local.Endpoints.Projects.Queries.html#listProjectBranches"><span class="hs-identifier hs-var hs-var">listProjectBranches</span></a></span></span><span> </span><span id="local-6989586621680061366"><span class="annot"><span class="annottext">ProjectId
</span><a href="#local-6989586621680061366"><span class="hs-identifier hs-var">projectId</span></a></span></span><span> </span><span id="local-6989586621680061367"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680061367"><span class="hs-identifier hs-var">mayUnsafeQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680061368"><span class="annot"><span class="annottext">mayQuery :: Maybe Text
</span><a href="#local-6989586621680061368"><span class="hs-identifier hs-var hs-var">mayQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Maybe Text -&gt; Maybe Text
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Text -&gt; Text
</span><span class="hs-identifier hs-var">likeEscape</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\\'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680061367"><span class="hs-identifier hs-var">mayUnsafeQuery</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><span class="annottext">Sql -&gt; Transaction [ProjectBranchListing]
forall a. (FromRow a, HasCallStack) =&gt; Sql -&gt; Transaction [a]
</span><span class="hs-identifier hs-var">queryListRow</span></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><span class="">[sql|
        SELECT project_branch.name
        FROM project_branch
        WHERE project_branch.project_id = :projectId
          AND (:mayQuery IS NULL OR project_branch.name LIKE '%' || :mayQuery || '%' ESCAPE '\')
        ORDER BY project_branch.last_accessed DESC NULLS LAST, project_branch.name ASC
      |]</span></span><span>
</span><span id="line-40"></span></pre></body></html>