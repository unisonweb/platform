<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Share.SyncV2</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#syncFromFile"><span class="hs-identifier">syncFromFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Unison.Share.SyncV2.html#syncToFile"><span class="hs-identifier">syncToFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Unison.Share.SyncV2.html#syncFromCodebase"><span class="hs-identifier">syncFromCodebase</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Unison.Share.SyncV2.html#syncFromCodeserver"><span class="hs-identifier">syncFromCodeserver</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Codec.Serialise</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Conduit</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ConduitT</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Conduit</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ask</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.ST</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ST</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">stToIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Attoparsec.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Attoparsec.ByteString.Char8</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A8</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Conduit.Attoparsec</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Conduit.Combinators</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Conduit.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CL</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Conduit.Zlib</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Foldable</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Graph</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Graph</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Proxy</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text.Lazy</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Lazy.Encoding</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text.Lazy</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Vector</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Vector</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Client</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Http.Client</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Types</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant.API</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Servant</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant.Client.Streaming</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Servant</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant.Conduit</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant.Types.SourceT</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Servant</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Console.Regions</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Console.Regions</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.HashTags</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">CausalHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Queries</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.TempEntity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TempEntity</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.V2.HashHandle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">v2HashHandle</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Auth.HTTPClient.html"><span class="hs-identifier">Unison.Auth.HTTPClient</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Auth</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html"><span class="hs-identifier">Unison.Cli.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier">Cli</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html"><span class="hs-identifier">Unison.Cli.Monad</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cli</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Codebase</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash32</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash32</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Share.API.Hash</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Share</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Share.ExpectedHashMismatches.html"><span class="hs-identifier">Unison.Share.ExpectedHashMismatches</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.ExpectedHashMismatches.html#expectedCausalHashMismatches"><span class="hs-identifier">expectedCausalHashMismatches</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Share.ExpectedHashMismatches.html#expectedComponentHashMismatches"><span class="hs-identifier">expectedComponentHashMismatches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Share.Sync.Types.html"><span class="hs-identifier">Unison.Share.Sync.Types</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sync.Common</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">causalHashToHash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">hash32ToCausalHash</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tempEntityToEntity</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sync.Common</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sync</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sync.EntityValidation</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EV</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sync.Types</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Share</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sync.Types</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sync</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.SyncV2.API</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Routes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">downloadEntitiesStream</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.SyncV2.API</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SyncV2</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.SyncV2.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">CBORBytes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">CBORStream</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DependencyType</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.SyncV2.Types</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SyncV2</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Servant.CBOR</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Timing</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Timing</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IO</span></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">type</span><span> </span><span id="Stream"><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span></span><span> </span><span id="local-6989586621681053543"><span class="annot"><a href="#local-6989586621681053543"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span id="local-6989586621681053544"><span class="annot"><a href="#local-6989586621681053544"><span class="hs-identifier hs-type">o</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConduitT</span></span><span> </span><span class="annot"><a href="#local-6989586621681053543"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053544"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">type</span><span> </span><span id="SyncErr"><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-var">SyncErr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-type">SyncError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.PullError</span></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- The base monad we use within the conduit pipeline.</span><span>
</span><span id="line-77"></span><span class="hs-keyword">type</span><span> </span><span id="StreamM"><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-var">StreamM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-type">SyncErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.ResourceT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">-- | The number of entities to process in a single transaction.</span><span>
</span><span id="line-80"></span><span class="hs-comment">--</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- SQLite transactions have some fixed overhead, so setting this too low can really slow things down,</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- but going too high here means we may be waiting on the network to get a full batch when we could be starting work.</span><span>
</span><span id="line-83"></span><span class="annot"><a href="Unison.Share.SyncV2.html#batchSize"><span class="hs-identifier hs-type">batchSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-84"></span><span id="batchSize"><span class="annot"><span class="annottext">batchSize :: Int
</span><a href="Unison.Share.SyncV2.html#batchSize"><span class="hs-identifier hs-var hs-var">batchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5000</span></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- Main methods</span><span>
</span><span id="line-88"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="annot"><span class="hs-comment">-- | Sync a given causal hash and its dependencies to a sync-file.</span></span><span>
</span><span id="line-91"></span><span id="local-6989586621681052848"><span id="local-6989586621681052849"><span class="annot"><a href="Unison.Share.SyncV2.html#syncToFile"><span class="hs-identifier hs-type">syncToFile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052848"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052849"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Root hash to sync</span></span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Optional name of the branch begin synced</span></span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.BranchRef</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Location of the sync-file</span></span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-type">SyncErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-100"></span><span id="syncToFile"><span class="annot"><span class="annottext">syncToFile :: forall v a.
Codebase IO v a
-&gt; CausalHash
-&gt; Maybe BranchRef
-&gt; FilePath
-&gt; IO (Either SyncErr ())
</span><a href="Unison.Share.SyncV2.html#syncToFile"><span class="hs-identifier hs-var hs-var">syncToFile</span></a></span></span><span> </span><span id="local-6989586621681053564"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053564"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621681053565"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053565"><span class="hs-identifier hs-var">rootHash</span></a></span></span><span> </span><span id="local-6989586621681053566"><span class="annot"><span class="annottext">Maybe BranchRef
</span><a href="#local-6989586621681053566"><span class="hs-identifier hs-var">mayBranchRef</span></a></span></span><span> </span><span id="local-6989586621681053567"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681053567"><span class="hs-identifier hs-var">destFilePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; IO (Either SyncErr ()))
-&gt; IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a -&gt; forall x. (Connection -&gt; IO x) -&gt; IO x
forall (m :: * -&gt; *) v a.
Codebase m v a -&gt; forall x. (Connection -&gt; m x) -&gt; m x
</span><span class="hs-identifier hs-var">Codebase.withConnection</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053564"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053570"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621681053570"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall (m :: * -&gt; *) a. MonadUnliftIO m =&gt; ResourceT m a -&gt; m a
</span><span class="hs-identifier hs-var">C.runResourceT</span></span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr ()) -&gt; IO (Either SyncErr ()))
-&gt; ResourceT IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><span class="annottext">Connection
-&gt; CausalHash
-&gt; Maybe BranchRef
-&gt; (Int
    -&gt; Stream () DownloadEntitiesChunk
    -&gt; ResourceT IO (Either SyncErr ()))
-&gt; ResourceT IO (Either SyncErr ())
forall (m :: * -&gt; *) r.
MonadIO m =&gt;
Connection
-&gt; CausalHash
-&gt; Maybe BranchRef
-&gt; (Int -&gt; Stream () DownloadEntitiesChunk -&gt; m r)
-&gt; m r
</span><a href="Unison.Share.SyncV2.html#withCodebaseEntityStream"><span class="hs-identifier hs-var">withCodebaseEntityStream</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621681053570"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053565"><span class="hs-identifier hs-var">rootHash</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BranchRef
</span><a href="#local-6989586621681053566"><span class="hs-identifier hs-var">mayBranchRef</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053573"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681053573"><span class="hs-identifier hs-var">mayTotal</span></a></span></span><span> </span><span id="local-6989586621681053574"><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681053574"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
-&gt; (ConduitT
      DownloadEntitiesChunk
      DownloadEntitiesChunk
      (ExceptT SyncErr (ResourceT IO))
      ()
    -&gt; ResourceT IO (Either SyncErr ()))
-&gt; ResourceT IO (Either SyncErr ())
forall (m :: * -&gt; *) (n :: * -&gt; *) i a.
(MonadIO m, MonadUnliftIO n) =&gt;
Maybe Int -&gt; (ConduitT i i m () -&gt; n a) -&gt; n a
</span><a href="Unison.Share.SyncV2.html#withStreamProgressCallback"><span class="hs-identifier hs-var">withStreamProgressCallback</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681053573"><span class="hs-identifier hs-var">mayTotal</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053576"><span class="annot"><span class="annottext">ConduitT
  DownloadEntitiesChunk
  DownloadEntitiesChunk
  (ExceptT SyncErr (ResourceT IO))
  ()
</span><a href="#local-6989586621681053576"><span class="hs-identifier hs-var">countC</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr (ResourceT IO) ()
-&gt; ResourceT IO (Either SyncErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-105"></span><span>          </span><span class="annot"><span class="annottext">ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall (m :: * -&gt; *) r. Monad m =&gt; ConduitT () Void m r -&gt; m r
</span><span class="hs-identifier hs-var">C.runConduit</span></span><span> </span><span class="annot"><span class="annottext">(ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
 -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-106"></span><span>            </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681053574"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-107"></span><span>              </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
-&gt; ConduitT
     DownloadEntitiesChunk Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  DownloadEntitiesChunk
  DownloadEntitiesChunk
  (ExceptT SyncErr (ResourceT IO))
  ()
</span><a href="#local-6989586621681053576"><span class="hs-identifier hs-var">countC</span></a></span><span>
</span><span id="line-108"></span><span>              </span><span class="annot"><span class="annottext">ConduitT
  DownloadEntitiesChunk
  DownloadEntitiesChunk
  (ExceptT SyncErr (ResourceT IO))
  ()
-&gt; ConduitT
     DownloadEntitiesChunk Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT
     DownloadEntitiesChunk Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">(DownloadEntitiesChunk -&gt; ByteString)
-&gt; ConduitT
     DownloadEntitiesChunk
     ByteString
     (ExceptT SyncErr (ResourceT IO))
     ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; ConduitT a b m ()
</span><span class="hs-identifier hs-var">C.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BL.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (DownloadEntitiesChunk -&gt; ByteString)
-&gt; DownloadEntitiesChunk
-&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesChunk -&gt; ByteString
forall a. Serialise a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">CBOR.serialise</span></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>              </span><span class="annot"><span class="annottext">ConduitT
  DownloadEntitiesChunk
  ByteString
  (ExceptT SyncErr (ResourceT IO))
  ()
-&gt; ConduitT ByteString Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT
     DownloadEntitiesChunk Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">(forall a. IO a -&gt; ExceptT SyncErr (ResourceT IO) a)
-&gt; ConduitT ByteString ByteString IO ()
-&gt; ConduitT
     ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) (n :: * -&gt; *) i o r.
Monad m =&gt;
(forall a. m a -&gt; n a) -&gt; ConduitT i o m r -&gt; ConduitT i o n r
</span><span class="hs-identifier hs-var">C.transPipe</span></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; ExceptT SyncErr (ResourceT IO) a
forall a. IO a -&gt; ExceptT SyncErr (ResourceT IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString ByteString IO ()
forall (m :: * -&gt; *).
(MonadThrow m, PrimMonad m) =&gt;
ConduitT ByteString ByteString m ()
</span><span class="hs-identifier hs-var">C.gzip</span></span><span>
</span><span id="line-110"></span><span>              </span><span class="annot"><span class="annottext">ConduitT ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT ByteString Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT ByteString Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">FilePath
-&gt; ConduitT ByteString Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) o.
MonadResource m =&gt;
FilePath -&gt; ConduitT ByteString o m ()
</span><span class="hs-identifier hs-var">C.sinkFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681053567"><span class="hs-identifier hs-var">destFilePath</span></a></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="annot"><a href="Unison.Share.SyncV2.html#syncFromFile"><span class="hs-identifier hs-type">syncFromFile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Whether to validate entities as they're imported.</span></span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Location of the sync-file</span></span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier hs-type">Cli</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-type">SyncError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.PullError</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span id="syncFromFile"><span class="annot"><span class="annottext">syncFromFile :: Bool -&gt; FilePath -&gt; Cli (Either SyncErr CausalHash)
</span><a href="Unison.Share.SyncV2.html#syncFromFile"><span class="hs-identifier hs-var hs-var">syncFromFile</span></a></span></span><span> </span><span id="local-6989586621681053588"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053588"><span class="hs-identifier hs-var">shouldValidate</span></a></span></span><span> </span><span id="local-6989586621681053589"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681053589"><span class="hs-identifier hs-var">syncFilePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><a href="Unison.Cli.Monad.html#Env"><span class="hs-identifier hs-type">Cli.Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621681053591"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
</span><a href="#local-6989586621681053591"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-comment">-- Every insert into SQLite checks the temp entity tables, but syncv2 doesn't actually use them, so it's faster</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-comment">-- if we clear them out before starting a sync.</span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><span class="annottext">Transaction () -&gt; Cli ()
forall a. Transaction a -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#runTransaction"><span class="hs-identifier hs-var">Cli.runTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.clearTempEntityTables</span></span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><span class="annottext">ExceptT SyncErr Cli CausalHash -&gt; Cli (Either SyncErr CausalHash)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either SyncErr CausalHash) -&gt; Cli (Either SyncErr CausalHash))
-&gt; ExceptT SyncErr IO CausalHash -&gt; ExceptT SyncErr Cli CausalHash
forall (m :: * -&gt; *) e a (n :: * -&gt; *) e' b.
(m (Either e a) -&gt; n (Either e' b))
-&gt; ExceptT e m a -&gt; ExceptT e' n b
</span><span class="hs-identifier hs-var">mapExceptT</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr CausalHash) -&gt; Cli (Either SyncErr CausalHash)
forall a. IO a -&gt; Cli a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr IO CausalHash -&gt; ExceptT SyncErr Cli CausalHash)
-&gt; ExceptT SyncErr IO CausalHash -&gt; ExceptT SyncErr Cli CausalHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath
-&gt; ExceptT SyncErr IO CausalHash -&gt; ExceptT SyncErr IO CausalHash
forall (m :: * -&gt; *) a. MonadIO m =&gt; FilePath -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Timing.time</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;File Sync&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr IO CausalHash -&gt; ExceptT SyncErr IO CausalHash)
-&gt; ExceptT SyncErr IO CausalHash -&gt; ExceptT SyncErr IO CausalHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>      </span><span id="local-6989586621681053597"><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053597"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr StreamInitInfo)
 -&gt; IO (Either SyncErr StreamInitInfo))
-&gt; ExceptT SyncErr (ResourceT IO) StreamInitInfo
-&gt; ExceptT SyncErr IO StreamInitInfo
forall (m :: * -&gt; *) e a (n :: * -&gt; *) e' b.
(m (Either e a) -&gt; n (Either e' b))
-&gt; ExceptT e m a -&gt; ExceptT e' n b
</span><span class="hs-identifier hs-var">mapExceptT</span></span><span> </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr StreamInitInfo)
-&gt; IO (Either SyncErr StreamInitInfo)
forall (m :: * -&gt; *) a. MonadUnliftIO m =&gt; ResourceT m a -&gt; m a
</span><span class="hs-identifier hs-var">C.runResourceT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ResourceT IO) StreamInitInfo
 -&gt; ExceptT SyncErr IO StreamInitInfo)
-&gt; ExceptT SyncErr (ResourceT IO) StreamInitInfo
-&gt; ExceptT SyncErr IO StreamInitInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053598"><span class="annot"><span class="annottext">stream :: Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681053598"><span class="hs-identifier hs-var hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
-&gt; ConduitT () ByteString (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) i.
MonadResource m =&gt;
FilePath -&gt; ConduitT i ByteString m ()
</span><span class="hs-identifier hs-var">C.sourceFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681053589"><span class="hs-identifier hs-var">syncFilePath</span></a></span><span> </span><span class="annot"><span class="annottext">ConduitT () ByteString (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT
     ByteString
     DownloadEntitiesChunk
     (ExceptT SyncErr (ResourceT IO))
     ()
-&gt; Stream () DownloadEntitiesChunk
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *).
(PrimMonad m, MonadThrow m) =&gt;
ConduitT ByteString ByteString m ()
</span><span class="hs-identifier hs-var">C.ungzip</span></span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT
     ByteString
     DownloadEntitiesChunk
     (ExceptT SyncErr (ResourceT IO))
     ()
-&gt; ConduitT
     ByteString
     DownloadEntitiesChunk
     (ExceptT SyncErr (ResourceT IO))
     ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  ByteString
  DownloadEntitiesChunk
  (ExceptT SyncErr (ResourceT IO))
  ()
forall a. Serialise a =&gt; Stream ByteString a
</span><a href="Unison.Share.SyncV2.html#decodeUnframedEntities"><span class="hs-identifier hs-var">decodeUnframedEntities</span></a></span><span>
</span><span id="line-127"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681053602"><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053602"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053603"><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053603"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
</span><a href="Unison.Share.SyncV2.html#initializeStream"><span class="hs-identifier hs-var">initializeStream</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681053598"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-128"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; Codebase IO Symbol Ann
-&gt; StreamInitInfo
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall v a.
Bool
-&gt; Codebase IO v a
-&gt; StreamInitInfo
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#streamIntoCodebase"><span class="hs-identifier hs-var">streamIntoCodebase</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053588"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621681053591"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053602"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053603"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053602"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-130"></span><span>      </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann -&gt; Hash32 -&gt; ExceptT SyncErr IO ()
forall v a. Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr IO ()
</span><a href="Unison.Share.SyncV2.html#afterSyncChecks"><span class="hs-identifier hs-var">afterSyncChecks</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621681053591"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamInitInfo -&gt; Hash32
</span><span class="hs-identifier hs-var">SyncV2.rootCausalHash</span></span><span> </span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053597"><span class="hs-identifier hs-var">header</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><span class="annottext">CausalHash -&gt; ExceptT SyncErr IO CausalHash
forall a. a -&gt; ExceptT SyncErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(CausalHash -&gt; ExceptT SyncErr IO CausalHash)
-&gt; (Hash32 -&gt; CausalHash)
-&gt; Hash32
-&gt; ExceptT SyncErr IO CausalHash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; CausalHash
</span><span class="hs-identifier hs-var">hash32ToCausalHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash32 -&gt; ExceptT SyncErr IO CausalHash)
-&gt; Hash32 -&gt; ExceptT SyncErr IO CausalHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StreamInitInfo -&gt; Hash32
</span><span class="hs-identifier hs-var">SyncV2.rootCausalHash</span></span><span> </span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053597"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span id="local-6989586621681052932"><span id="local-6989586621681052933"><span class="annot"><a href="Unison.Share.SyncV2.html#syncFromCodebase"><span class="hs-identifier hs-type">syncFromCodebase</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The codebase to sync from.</span></span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052932"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052933"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The hash to sync.</span></span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-type">SyncError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.PullError</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-141"></span><span id="syncFromCodebase"><span class="annot"><span class="annottext">syncFromCodebase :: forall v a.
Bool
-&gt; Connection
-&gt; Codebase IO v a
-&gt; CausalHash
-&gt; IO (Either SyncErr ())
</span><a href="Unison.Share.SyncV2.html#syncFromCodebase"><span class="hs-identifier hs-var hs-var">syncFromCodebase</span></a></span></span><span> </span><span id="local-6989586621681053619"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053619"><span class="hs-identifier hs-var">shouldValidate</span></a></span></span><span> </span><span id="local-6989586621681053620"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621681053620"><span class="hs-identifier hs-var">srcConn</span></a></span></span><span> </span><span id="local-6989586621681053621"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053621"><span class="hs-identifier hs-var">destCodebase</span></a></span></span><span> </span><span id="local-6989586621681053622"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053622"><span class="hs-identifier hs-var">causalHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-comment">-- Every insert into SQLite checks the temp entity tables, but syncv2 doesn't actually use them, so it's faster</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-comment">-- if we clear them out before starting a sync.</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">Connection -&gt; Transaction () -&gt; IO ()
forall (m :: * -&gt; *) a.
(MonadIO m, HasCallStack) =&gt;
Connection -&gt; Transaction a -&gt; m a
</span><span class="hs-identifier hs-var">Sqlite.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621681053620"><span class="hs-identifier hs-var">srcConn</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.clearTempEntityTables</span></span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; IO (Either SyncErr ()))
-&gt; (ExceptT SyncErr (ResourceT IO) () -&gt; IO (Either SyncErr ()))
-&gt; ExceptT SyncErr (ResourceT IO) ()
-&gt; IO (Either SyncErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall (m :: * -&gt; *) a. MonadUnliftIO m =&gt; ResourceT m a -&gt; m a
</span><span class="hs-identifier hs-var">C.runResourceT</span></span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr ()) -&gt; IO (Either SyncErr ()))
-&gt; (ExceptT SyncErr (ResourceT IO) ()
    -&gt; ResourceT IO (Either SyncErr ()))
-&gt; ExceptT SyncErr (ResourceT IO) ()
-&gt; IO (Either SyncErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr (ResourceT IO) ()
-&gt; ResourceT IO (Either SyncErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ResourceT IO) () -&gt; IO (Either SyncErr ()))
-&gt; ExceptT SyncErr (ResourceT IO) () -&gt; IO (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Connection
-&gt; CausalHash
-&gt; Maybe BranchRef
-&gt; (Int
    -&gt; Stream () DownloadEntitiesChunk
    -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall (m :: * -&gt; *) r.
MonadIO m =&gt;
Connection
-&gt; CausalHash
-&gt; Maybe BranchRef
-&gt; (Int -&gt; Stream () DownloadEntitiesChunk -&gt; m r)
-&gt; m r
</span><a href="Unison.Share.SyncV2.html#withCodebaseEntityStream"><span class="hs-identifier hs-var">withCodebaseEntityStream</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621681053620"><span class="hs-identifier hs-var">srcConn</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053622"><span class="hs-identifier hs-var">causalHash</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BranchRef
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053624"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681053624"><span class="hs-identifier hs-var">_total</span></a></span></span><span> </span><span id="local-6989586621681053625"><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681053625"><span class="hs-identifier hs-var">entityStream</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681053626"><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053626"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053627"><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053627"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
</span><a href="Unison.Share.SyncV2.html#initializeStream"><span class="hs-identifier hs-var">initializeStream</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681053625"><span class="hs-identifier hs-var">entityStream</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; Codebase IO v a
-&gt; StreamInitInfo
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall v a.
Bool
-&gt; Codebase IO v a
-&gt; StreamInitInfo
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#streamIntoCodebase"><span class="hs-identifier hs-var">streamIntoCodebase</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053619"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053621"><span class="hs-identifier hs-var">destCodebase</span></a></span><span> </span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053626"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053627"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; ResourceT IO (Either SyncErr ()))
-&gt; ExceptT SyncErr IO () -&gt; ExceptT SyncErr (ResourceT IO) ()
forall (m :: * -&gt; *) e a (n :: * -&gt; *) e' b.
(m (Either e a) -&gt; n (Either e' b))
-&gt; ExceptT e m a -&gt; ExceptT e' n b
</span><span class="hs-identifier hs-var">mapExceptT</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; ResourceT IO (Either SyncErr ())
forall a. IO a -&gt; ResourceT IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr IO ()
forall v a. Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr IO ()
</span><a href="Unison.Share.SyncV2.html#afterSyncChecks"><span class="hs-identifier hs-var">afterSyncChecks</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053621"><span class="hs-identifier hs-var">destCodebase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; Hash32
</span><span class="hs-identifier hs-var">causalHashToHash32</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053622"><span class="hs-identifier hs-var">causalHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="annot"><a href="Unison.Share.SyncV2.html#syncFromCodeserver"><span class="hs-identifier hs-type">syncFromCodeserver</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The Unison Share URL.</span></span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Servant.BaseUrl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The branch to download from.</span></span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.BranchRef</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The hash to download.</span></span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Share.HashJWT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Callback that's given a number of entities we just downloaded.</span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier hs-type">Cli</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-type">SyncError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.PullError</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span id="syncFromCodeserver"><span class="annot"><span class="annottext">syncFromCodeserver :: Bool
-&gt; BaseUrl
-&gt; BranchRef
-&gt; HashJWT
-&gt; (Int -&gt; IO ())
-&gt; Cli (Either SyncErr ())
</span><a href="Unison.Share.SyncV2.html#syncFromCodeserver"><span class="hs-identifier hs-var hs-var">syncFromCodeserver</span></a></span></span><span> </span><span id="local-6989586621681053628"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053628"><span class="hs-identifier hs-var">shouldValidate</span></a></span></span><span> </span><span id="local-6989586621681053629"><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681053629"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span></span><span> </span><span id="local-6989586621681053630"><span class="annot"><span class="annottext">BranchRef
</span><a href="#local-6989586621681053630"><span class="hs-identifier hs-var">branchRef</span></a></span></span><span> </span><span id="local-6989586621681053631"><span class="annot"><span class="annottext">HashJWT
</span><a href="#local-6989586621681053631"><span class="hs-identifier hs-var">hashJwt</span></a></span></span><span> </span><span id="local-6989586621681053632"><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621681053632"><span class="hs-identifier hs-var">_downloadedCallback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><a href="Unison.Cli.Monad.html#Env"><span class="hs-identifier hs-type">Cli.Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621681053633"><span class="annot"><span class="annottext">AuthenticatedHttpClient
authHTTPClient :: AuthenticatedHttpClient
$sel:authHTTPClient:Env :: Env -&gt; AuthenticatedHttpClient
</span><a href="#local-6989586621681053633"><span class="hs-identifier hs-var hs-var">authHTTPClient</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053635"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
</span><a href="Unison.Cli.Monad.html#%24sel%3Acodebase%3AEnv"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-comment">-- Every insert into SQLite checks the temp entity tables, but syncv2 doesn't actually use them, so it's faster</span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-comment">-- if we clear them out before starting a sync.</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">Transaction () -&gt; Cli ()
forall a. Transaction a -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#runTransaction"><span class="hs-identifier hs-var">Cli.runTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.clearTempEntityTables</span></span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><span class="annottext">ExceptT SyncErr Cli () -&gt; Cli (Either SyncErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621681053636"><span class="annot"><span class="annottext">Set Hash32
</span><a href="#local-6989586621681053636"><span class="hs-identifier hs-var">knownHashes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli (Either SyncErr (Set Hash32))
-&gt; ExceptT SyncErr Cli (Set Hash32)
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ExceptT</span></span><span> </span><span class="annot"><span class="annottext">(Cli (Either SyncErr (Set Hash32))
 -&gt; ExceptT SyncErr Cli (Set Hash32))
-&gt; Cli (Either SyncErr (Set Hash32))
-&gt; ExceptT SyncErr Cli (Set Hash32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BaseUrl
-&gt; BranchRef -&gt; HashJWT -&gt; Cli (Either SyncErr (Set Hash32))
</span><a href="Unison.Share.SyncV2.html#negotiateKnownCausals"><span class="hs-identifier hs-var">negotiateKnownCausals</span></a></span><span> </span><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681053629"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span><span> </span><span class="annot"><span class="annottext">BranchRef
</span><a href="#local-6989586621681053630"><span class="hs-identifier hs-var">branchRef</span></a></span><span> </span><span class="annot"><span class="annottext">HashJWT
</span><a href="#local-6989586621681053631"><span class="hs-identifier hs-var">hashJwt</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053639"><span class="annot"><span class="annottext">hash :: Hash32
</span><a href="#local-6989586621681053639"><span class="hs-identifier hs-var hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashJWT -&gt; Hash32
</span><span class="hs-identifier hs-var">Share.hashJWTHash</span></span><span> </span><span class="annot"><span class="annottext">HashJWT
</span><a href="#local-6989586621681053631"><span class="hs-identifier hs-var">hashJwt</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">Cli (Either SyncErr ()) -&gt; ExceptT SyncErr Cli ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ExceptT</span></span><span> </span><span class="annot"><span class="annottext">(Cli (Either SyncErr ()) -&gt; ExceptT SyncErr Cli ())
-&gt; Cli (Either SyncErr ()) -&gt; ExceptT SyncErr Cli ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transaction (Maybe EntityLocation) -&gt; Cli (Maybe EntityLocation)
forall a. Transaction a -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#runTransaction"><span class="hs-identifier hs-var">Cli.runTransaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32 -&gt; Transaction (Maybe EntityLocation)
</span><span class="hs-identifier hs-var">Q.entityLocation</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053639"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cli (Maybe EntityLocation)
-&gt; (Maybe EntityLocation -&gt; Cli (Either SyncErr ()))
-&gt; Cli (Either SyncErr ())
forall a b. Cli a -&gt; (a -&gt; Cli b) -&gt; Cli b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-171"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityLocation
</span><span class="hs-identifier hs-var">Q.EntityInMainStorage</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SyncErr () -&gt; Cli (Either SyncErr ())
forall a. a -&gt; Cli a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SyncErr () -&gt; Cli (Either SyncErr ()))
-&gt; Either SyncErr () -&gt; Cli (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either SyncErr ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>        </span><span class="annot"><span class="annottext">Maybe EntityLocation
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; Cli (Either SyncErr ()) -&gt; Cli (Either SyncErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; FilePath -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Timing.time</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Entity Download&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Cli (Either SyncErr ()) -&gt; Cli (Either SyncErr ()))
-&gt; Cli (Either SyncErr ()) -&gt; Cli (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>            </span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; Cli (Either SyncErr ())
forall a. IO a -&gt; Cli a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; Cli (Either SyncErr ()))
-&gt; (ExceptT SyncErr (ResourceT IO) () -&gt; IO (Either SyncErr ()))
-&gt; ExceptT SyncErr (ResourceT IO) ()
-&gt; Cli (Either SyncErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall (m :: * -&gt; *) a. MonadUnliftIO m =&gt; ResourceT m a -&gt; m a
</span><span class="hs-identifier hs-var">C.runResourceT</span></span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr ()) -&gt; IO (Either SyncErr ()))
-&gt; (ExceptT SyncErr (ResourceT IO) ()
    -&gt; ResourceT IO (Either SyncErr ()))
-&gt; ExceptT SyncErr (ResourceT IO) ()
-&gt; IO (Either SyncErr ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr (ResourceT IO) ()
-&gt; ResourceT IO (Either SyncErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ResourceT IO) () -&gt; Cli (Either SyncErr ()))
-&gt; ExceptT SyncErr (ResourceT IO) () -&gt; Cli (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AuthenticatedHttpClient
-&gt; BaseUrl
-&gt; DownloadEntitiesRequest
-&gt; (StreamInitInfo
    -&gt; Stream () EntityChunk -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#httpStreamEntities"><span class="hs-identifier hs-var">httpStreamEntities</span></a></span><span>
</span><span id="line-175"></span><span>              </span><span class="annot"><span class="annottext">AuthenticatedHttpClient
</span><a href="#local-6989586621681053633"><span class="hs-identifier hs-var">authHTTPClient</span></a></span><span>
</span><span id="line-176"></span><span>              </span><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681053629"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span><span>
</span><span id="line-177"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesRequest</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">BranchRef
branchRef :: BranchRef
$sel:branchRef:DownloadEntitiesRequest :: BranchRef
</span><a href="#local-6989586621681053630"><span class="hs-identifier hs-var hs-var">branchRef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:causalHash:DownloadEntitiesRequest :: HashJWT
</span><span class="hs-identifier hs-var">causalHash</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashJWT
</span><a href="#local-6989586621681053631"><span class="hs-identifier hs-var">hashJwt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set Hash32
knownHashes :: Set Hash32
$sel:knownHashes:DownloadEntitiesRequest :: Set Hash32
</span><a href="#local-6989586621681053636"><span class="hs-identifier hs-var hs-var">knownHashes</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-178"></span><span>              </span><span class="hs-glyph">\</span><span id="local-6989586621681053648"><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053648"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621681053649"><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053649"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-179"></span><span>                </span><span class="annot"><span class="annottext">Bool
-&gt; Codebase IO Symbol Ann
-&gt; StreamInitInfo
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall v a.
Bool
-&gt; Codebase IO v a
-&gt; StreamInitInfo
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#streamIntoCodebase"><span class="hs-identifier hs-var">streamIntoCodebase</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053628"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621681053635"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681053648"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053649"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; Cli (Either SyncErr ()))
-&gt; ExceptT SyncErr IO () -&gt; ExceptT SyncErr Cli ()
forall (m :: * -&gt; *) e a (n :: * -&gt; *) e' b.
(m (Either e a) -&gt; n (Either e' b))
-&gt; ExceptT e m a -&gt; ExceptT e' n b
</span><span class="hs-identifier hs-var">mapExceptT</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; Cli (Either SyncErr ())
forall a. IO a -&gt; Cli a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO Symbol Ann -&gt; Hash32 -&gt; ExceptT SyncErr IO ()
forall v a. Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr IO ()
</span><a href="Unison.Share.SyncV2.html#afterSyncChecks"><span class="hs-identifier hs-var">afterSyncChecks</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621681053635"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053639"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- Helpers</span><span>
</span><span id="line-184"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="annot"><span class="hs-comment">-- | Validate that the provided entities match their expected hashes, and if so, save them to the codebase.</span></span><span>
</span><span id="line-187"></span><span id="local-6989586621681052953"><span id="local-6989586621681052954"><span class="annot"><a href="Unison.Share.SyncV2.html#validateAndSave"><span class="hs-identifier hs-type">validateAndSave</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052953"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052954"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-188"></span><span id="validateAndSave"><span class="annot"><span class="annottext">validateAndSave :: forall v a.
Bool
-&gt; Codebase IO v a
-&gt; Vector (Hash32, TempEntity)
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#validateAndSave"><span class="hs-identifier hs-var hs-var">validateAndSave</span></a></span></span><span> </span><span id="local-6989586621681053670"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053670"><span class="hs-identifier hs-var">shouldValidate</span></a></span></span><span> </span><span id="local-6989586621681053671"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053671"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621681053672"><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053672"><span class="hs-identifier hs-var">entities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053673"><span class="annot"><span class="annottext">validateEntities :: IO (Either SyncErr ())
</span><a href="#local-6989586621681053673"><span class="hs-identifier hs-var hs-var">validateEntities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="annottext">ExceptT SyncErr IO () -&gt; IO (Either SyncErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr IO () -&gt; IO (Either SyncErr ()))
-&gt; ExceptT SyncErr IO () -&gt; IO (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT SyncErr IO () -&gt; ExceptT SyncErr IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053670"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity) -&gt; ExceptT SyncErr IO ()
</span><a href="Unison.Share.SyncV2.html#batchValidateEntities"><span class="hs-identifier hs-var">batchValidateEntities</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053672"><span class="hs-identifier hs-var">entities</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-comment">-- Validation is slow, so we run it in parallel with insertion (which can also be slow),</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-comment">-- but we don't commit the transaction until we're done validation to avoid inserting invalid entities.</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr ())
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr ())
 -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; (IO (Either SyncErr ()) -&gt; ResourceT IO (Either SyncErr ()))
-&gt; IO (Either SyncErr ())
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; ResourceT IO (Either SyncErr ())
forall a. IO a -&gt; ResourceT IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; IO (Either SyncErr ()) -&gt; ExceptT SyncErr (ResourceT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr ())
-&gt; (Async (Either SyncErr ()) -&gt; IO (Either SyncErr ()))
-&gt; IO (Either SyncErr ())
forall (m :: * -&gt; *) a b.
MonadUnliftIO m =&gt;
m a -&gt; (Async a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">IO.withAsync</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr ())
</span><a href="#local-6989586621681053673"><span class="hs-identifier hs-var">validateEntities</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053677"><span class="annot"><span class="annottext">Async (Either SyncErr ())
</span><a href="#local-6989586621681053677"><span class="hs-identifier hs-var">validationTask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">FilePath -&gt; IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; FilePath -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Timing.time</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Inserting entities&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; IO (Either SyncErr ()))
-&gt; IO (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
-&gt; ExceptT SyncErr Transaction () -&gt; IO (Either SyncErr ())
forall (m :: * -&gt; *) v a e b.
MonadIO m =&gt;
Codebase m v a -&gt; ExceptT e Transaction b -&gt; m (Either e b)
</span><span class="hs-identifier hs-var">Codebase.runTransactionExceptT</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053671"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>      </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
-&gt; ((Hash32, TempEntity) -&gt; ExceptT SyncErr Transaction ())
-&gt; ExceptT SyncErr Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053672"><span class="hs-identifier hs-var">entities</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681053680"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053680"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053681"><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053681"><span class="hs-identifier hs-var">entity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>        </span><span class="annot"><span class="annottext">ExceptT SyncErr Transaction (Either CausalHashId ObjectId)
-&gt; ExceptT SyncErr Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr Transaction (Either CausalHashId ObjectId)
 -&gt; ExceptT SyncErr Transaction ())
-&gt; (Transaction (Either CausalHashId ObjectId)
    -&gt; ExceptT SyncErr Transaction (Either CausalHashId ObjectId))
-&gt; Transaction (Either CausalHashId ObjectId)
-&gt; ExceptT SyncErr Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction (Either CausalHashId ObjectId)
-&gt; ExceptT SyncErr Transaction (Either CausalHashId ObjectId)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT SyncErr m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Either CausalHashId ObjectId)
 -&gt; ExceptT SyncErr Transaction ())
-&gt; Transaction (Either CausalHashId ObjectId)
-&gt; ExceptT SyncErr Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
-&gt; Hash32
-&gt; TempEntity
-&gt; Transaction (Either CausalHashId ObjectId)
</span><span class="hs-identifier hs-var">Q.saveTempEntityInMain</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053680"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053681"><span class="hs-identifier hs-var">entity</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><span class="annottext">Transaction (Either SyncErr ())
-&gt; ExceptT SyncErr Transaction (Either SyncErr ())
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT SyncErr m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; Transaction (Either SyncErr ())
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async (Either SyncErr ()) -&gt; IO (Either SyncErr ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; Async a -&gt; m a
</span><span class="hs-identifier hs-var">IO.wait</span></span><span> </span><span class="annot"><span class="annottext">Async (Either SyncErr ())
</span><a href="#local-6989586621681053677"><span class="hs-identifier hs-var">validationTask</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr Transaction (Either SyncErr ())
-&gt; (Either SyncErr () -&gt; ExceptT SyncErr Transaction ())
-&gt; ExceptT SyncErr Transaction ()
forall a b.
ExceptT SyncErr Transaction a
-&gt; (a -&gt; ExceptT SyncErr Transaction b)
-&gt; ExceptT SyncErr Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681053687"><span class="annot"><span class="annottext">SyncErr
</span><a href="#local-6989586621681053687"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr Transaction ()
forall a. SyncErr -&gt; ExceptT SyncErr Transaction a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">SyncErr
</span><a href="#local-6989586621681053687"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT SyncErr Transaction ()
forall a. a -&gt; ExceptT SyncErr Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="annot"><span class="hs-comment">-- | Validate that a batch of entities matches the hashes they're keyed by, throwing an error if any of them fail validation.</span></span><span>
</span><span id="line-202"></span><span class="annot"><a href="Unison.Share.SyncV2.html#batchValidateEntities"><span class="hs-identifier hs-type">batchValidateEntities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-type">SyncErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span id="batchValidateEntities"><span class="annot"><span class="annottext">batchValidateEntities :: Vector (Hash32, TempEntity) -&gt; ExceptT SyncErr IO ()
</span><a href="Unison.Share.SyncV2.html#batchValidateEntities"><span class="hs-identifier hs-var hs-var">batchValidateEntities</span></a></span></span><span> </span><span id="local-6989586621681053689"><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053689"><span class="hs-identifier hs-var">entities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>  </span><span id="local-6989586621681053690"><span class="annot"><span class="annottext">Vector EntityValidationError
</span><a href="#local-6989586621681053690"><span class="hs-identifier hs-var">mismatches</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Vector (Maybe EntityValidationError)
 -&gt; Vector EntityValidationError)
-&gt; ExceptT SyncErr IO (Vector (Maybe EntityValidationError))
-&gt; ExceptT SyncErr IO (Vector EntityValidationError)
forall a b.
(a -&gt; b) -&gt; ExceptT SyncErr IO a -&gt; ExceptT SyncErr IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Vector (Maybe EntityValidationError)
-&gt; Vector EntityValidationError
forall a. Vector (Maybe a) -&gt; Vector a
</span><span class="hs-identifier hs-var">Vector.catMaybes</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr IO (Vector (Maybe EntityValidationError))
 -&gt; ExceptT SyncErr IO (Vector EntityValidationError))
-&gt; ExceptT SyncErr IO (Vector (Maybe EntityValidationError))
-&gt; ExceptT SyncErr IO (Vector EntityValidationError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Vector (Maybe EntityValidationError))
-&gt; ExceptT SyncErr IO (Vector (Maybe EntityValidationError))
forall a. IO a -&gt; ExceptT SyncErr IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Vector (Maybe EntityValidationError))
 -&gt; ExceptT SyncErr IO (Vector (Maybe EntityValidationError)))
-&gt; IO (Vector (Maybe EntityValidationError))
-&gt; ExceptT SyncErr IO (Vector (Maybe EntityValidationError))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
-&gt; ((Hash32, TempEntity) -&gt; IO (Maybe EntityValidationError))
-&gt; IO (Vector (Maybe EntityValidationError))
forall (m :: * -&gt; *) (t :: * -&gt; *) a b.
(MonadUnliftIO m, Traversable t) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">IO.pooledForConcurrently</span></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053689"><span class="hs-identifier hs-var">entities</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681053693"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053693"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053694"><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053694"><span class="hs-identifier hs-var">entity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">Maybe EntityValidationError -&gt; IO (Maybe EntityValidationError)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">IO.evaluate</span></span><span> </span><span class="annot"><span class="annottext">(Maybe EntityValidationError -&gt; IO (Maybe EntityValidationError))
-&gt; Maybe EntityValidationError -&gt; IO (Maybe EntityValidationError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; TempEntity -&gt; Maybe EntityValidationError
</span><span class="hs-identifier hs-var">EV.validateTempEntity</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053693"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053694"><span class="hs-identifier hs-var">entity</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><span class="annottext">Vector EntityValidationError
-&gt; (EntityValidationError -&gt; ExceptT SyncErr IO ())
-&gt; ExceptT SyncErr IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">Vector EntityValidationError
</span><a href="#local-6989586621681053690"><span class="hs-identifier hs-var">mismatches</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621681053697"><span class="annot"><span class="annottext">err :: EntityValidationError
</span><a href="#local-6989586621681053697"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Share.EntityHashMismatch</span></span><span> </span><span id="local-6989586621681053699"><span class="annot"><span class="annottext">EntityType
</span><a href="#local-6989586621681053699"><span class="hs-identifier hs-var">et</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Share.HashMismatchForEntity</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621681053701"><span class="annot"><span class="annottext">Hash32
supplied :: Hash32
$sel:supplied:HashMismatchForEntity :: HashMismatchForEntity -&gt; Hash32
</span><a href="#local-6989586621681053701"><span class="hs-identifier hs-var hs-var">supplied</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053703"><span class="annot"><span class="annottext">Hash32
computed :: Hash32
$sel:computed:HashMismatchForEntity :: HashMismatchForEntity -&gt; Hash32
</span><a href="#local-6989586621681053703"><span class="hs-identifier hs-var hs-var">computed</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053705"><span class="annot"><span class="annottext">expectedMismatches :: Map Hash32 Hash32
</span><a href="#local-6989586621681053705"><span class="hs-identifier hs-var hs-var">expectedMismatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EntityType
</span><a href="#local-6989586621681053699"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-209"></span><span>            </span><span class="annot"><span class="annottext">EntityType
</span><span class="hs-identifier hs-var">Share.TermComponentType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map Hash32 Hash32
</span><a href="Unison.Share.ExpectedHashMismatches.html#expectedComponentHashMismatches"><span class="hs-identifier hs-var">expectedComponentHashMismatches</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="annot"><span class="annottext">EntityType
</span><span class="hs-identifier hs-var">Share.DeclComponentType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map Hash32 Hash32
</span><a href="Unison.Share.ExpectedHashMismatches.html#expectedComponentHashMismatches"><span class="hs-identifier hs-var">expectedComponentHashMismatches</span></a></span><span>
</span><span id="line-211"></span><span>            </span><span class="annot"><span class="annottext">EntityType
</span><span class="hs-identifier hs-var">Share.CausalType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map Hash32 Hash32
</span><a href="Unison.Share.ExpectedHashMismatches.html#expectedCausalHashMismatches"><span class="hs-identifier hs-var">expectedCausalHashMismatches</span></a></span><span>
</span><span id="line-212"></span><span>            </span><span class="annot"><span class="annottext">EntityType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map Hash32 Hash32
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-213"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; Map Hash32 Hash32 -&gt; Maybe Hash32
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053701"><span class="hs-identifier hs-var">supplied</span></a></span><span> </span><span class="annot"><span class="annottext">Map Hash32 Hash32
</span><a href="#local-6989586621681053705"><span class="hs-identifier hs-var">expectedMismatches</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-214"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681053710"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053710"><span class="hs-identifier hs-var">expected</span></a></span></span><span>
</span><span id="line-215"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053710"><span class="hs-identifier hs-var">expected</span></a></span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; Hash32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053703"><span class="hs-identifier hs-var">computed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT SyncErr IO ()
forall a. a -&gt; ExceptT SyncErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>            </span><span class="annot"><span class="annottext">Maybe Hash32
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>              </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr IO ()
forall a. SyncErr -&gt; ExceptT SyncErr IO a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ExceptT SyncErr IO ())
-&gt; (EntityValidationError -&gt; SyncErr)
-&gt; EntityValidationError
-&gt; ExceptT SyncErr IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (EntityValidationError -&gt; PullError)
-&gt; EntityValidationError
-&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'DownloadEntities</span></span><span> </span><span class="annot"><span class="annottext">(DownloadEntitiesError -&gt; PullError)
-&gt; (EntityValidationError -&gt; DownloadEntitiesError)
-&gt; EntityValidationError
-&gt; PullError
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EntityValidationError -&gt; DownloadEntitiesError
</span><span class="hs-identifier hs-var">SyncV2.DownloadEntitiesEntityValidationFailure</span></span><span> </span><span class="annot"><span class="annottext">(EntityValidationError -&gt; ExceptT SyncErr IO ())
-&gt; EntityValidationError -&gt; ExceptT SyncErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityValidationError
</span><a href="#local-6989586621681053697"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621681053714"><span class="annot"><span class="annottext">EntityValidationError
</span><a href="#local-6989586621681053714"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr IO ()
forall a. SyncErr -&gt; ExceptT SyncErr IO a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ExceptT SyncErr IO ())
-&gt; (EntityValidationError -&gt; SyncErr)
-&gt; EntityValidationError
-&gt; ExceptT SyncErr IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (EntityValidationError -&gt; PullError)
-&gt; EntityValidationError
-&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'DownloadEntities</span></span><span> </span><span class="annot"><span class="annottext">(DownloadEntitiesError -&gt; PullError)
-&gt; (EntityValidationError -&gt; DownloadEntitiesError)
-&gt; EntityValidationError
-&gt; PullError
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EntityValidationError -&gt; DownloadEntitiesError
</span><span class="hs-identifier hs-var">SyncV2.DownloadEntitiesEntityValidationFailure</span></span><span> </span><span class="annot"><span class="annottext">(EntityValidationError -&gt; ExceptT SyncErr IO ())
-&gt; EntityValidationError -&gt; ExceptT SyncErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityValidationError
</span><a href="#local-6989586621681053714"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><span class="hs-comment">-- | Syncs a stream which could send entities in any order.</span></span><span>
</span><span id="line-222"></span><span id="local-6989586621681053006"><span id="local-6989586621681053007"><span class="annot"><a href="Unison.Share.SyncV2.html#syncUnsortedStream"><span class="hs-identifier hs-type">syncUnsortedStream</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053006"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053007"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-227"></span><span id="syncUnsortedStream"><span class="annot"><span class="annottext">syncUnsortedStream :: forall v a.
Bool
-&gt; Codebase IO v a
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#syncUnsortedStream"><span class="hs-identifier hs-var hs-var">syncUnsortedStream</span></a></span></span><span> </span><span id="local-6989586621681053750"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053750"><span class="hs-identifier hs-var">shouldValidate</span></a></span></span><span> </span><span id="local-6989586621681053751"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053751"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621681053752"><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053752"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>  </span><span id="local-6989586621681053753"><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053753"><span class="hs-identifier hs-var">allEntities</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">ConduitT
  ()
  Void
  (ExceptT SyncErr (ResourceT IO))
  (Vector (Hash32, TempEntity))
-&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) r. Monad m =&gt; ConduitT () Void m r -&gt; m r
</span><span class="hs-identifier hs-var">C.runConduit</span></span><span> </span><span class="annot"><span class="annottext">(ConduitT
   ()
   Void
   (ExceptT SyncErr (ResourceT IO))
   (Vector (Hash32, TempEntity))
 -&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity)))
-&gt; ConduitT
     ()
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
-&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-230"></span><span>      </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053752"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-231"></span><span>        </span><span class="annot"><span class="annottext">Stream () EntityChunk
-&gt; ConduitT
     EntityChunk
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
-&gt; ConduitT
     ()
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; ConduitT
     EntityChunk [EntityChunk] (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a. Monad m =&gt; Int -&gt; ConduitT a [a] m ()
</span><span class="hs-identifier hs-var">CL.chunksOf</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Unison.Share.SyncV2.html#batchSize"><span class="hs-identifier hs-var">batchSize</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">ConduitT
  EntityChunk [EntityChunk] (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT
     [EntityChunk]
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
-&gt; ConduitT
     EntityChunk
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
-&gt; Stream [EntityChunk] (Vector (Hash32, TempEntity))
forall v a.
Codebase IO v a
-&gt; Stream [EntityChunk] (Vector (Hash32, TempEntity))
</span><a href="Unison.Share.SyncV2.html#unpackChunks"><span class="hs-identifier hs-var">unpackChunks</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053751"><span class="hs-identifier hs-var">codebase</span></a></span><span>
</span><span id="line-233"></span><span>        </span><span class="annot"><span class="annottext">Stream [EntityChunk] (Vector (Hash32, TempEntity))
-&gt; ConduitT
     (Vector (Hash32, TempEntity))
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
-&gt; ConduitT
     [EntityChunk]
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">Stream (Vector (Hash32, TempEntity)) (Vector (Hash32, TempEntity))
</span><a href="#local-6989586621681053756"><span class="hs-identifier hs-var">validateBatch</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">Stream (Vector (Hash32, TempEntity)) (Vector (Hash32, TempEntity))
-&gt; ConduitT
     (Vector (Hash32, TempEntity))
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
-&gt; ConduitT
     (Vector (Hash32, TempEntity))
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  (Vector (Hash32, TempEntity))
  (Hash32, TempEntity)
  (ExceptT SyncErr (ResourceT IO))
  ()
ConduitT
  (Vector (Hash32, TempEntity))
  (Element (Vector (Hash32, TempEntity)))
  (ExceptT SyncErr (ResourceT IO))
  ()
forall (m :: * -&gt; *) mono.
(Monad m, MonoFoldable mono) =&gt;
ConduitT mono (Element mono) m ()
</span><span class="hs-identifier hs-var">C.concat</span></span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">ConduitT
  (Vector (Hash32, TempEntity))
  (Hash32, TempEntity)
  (ExceptT SyncErr (ResourceT IO))
  ()
-&gt; ConduitT
     (Hash32, TempEntity)
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
-&gt; ConduitT
     (Vector (Hash32, TempEntity))
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">forall (v :: * -&gt; *) a (m :: * -&gt; *) o.
(Vector v a, PrimMonad m) =&gt;
ConduitT a o m (v a)
</span><span class="hs-identifier hs-var">C.sinkVector</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053759"><span class="annot"><span class="annottext">sortedEntities :: [(Hash32, TempEntity)]
</span><a href="#local-6989586621681053759"><span class="hs-identifier hs-var hs-var">sortedEntities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity) -&gt; [(Hash32, TempEntity)]
forall (f :: * -&gt; *).
(Foldable f, Functor f) =&gt;
f (Hash32, TempEntity) -&gt; [(Hash32, TempEntity)]
</span><a href="Unison.Share.SyncV2.html#sortDependencyFirst"><span class="hs-identifier hs-var">sortDependencyFirst</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053753"><span class="hs-identifier hs-var">allEntities</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT SyncErr (ResourceT IO) ()
forall a. IO a -&gt; ExceptT SyncErr (ResourceT IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; IO () -&gt; ExceptT SyncErr (ResourceT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; ((Int -&gt; IO ()) -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
Maybe Int -&gt; ((Int -&gt; m ()) -&gt; m a) -&gt; m a
</span><a href="Unison.Share.SyncV2.html#withEntitySavingCallback"><span class="hs-identifier hs-var">withEntitySavingCallback</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity) -&gt; Int
forall a. Vector a -&gt; Int
</span><span class="hs-identifier hs-var">Vector.length</span></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053753"><span class="hs-identifier hs-var">allEntities</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053763"><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621681053763"><span class="hs-identifier hs-var">countC</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Transaction () -&gt; IO ()
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053751"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; IO ()) -&gt; Transaction () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Hash32, TempEntity)]
-&gt; ((Hash32, TempEntity)
    -&gt; Transaction (Either CausalHashId ObjectId))
-&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(Hash32, TempEntity)]
</span><a href="#local-6989586621681053759"><span class="hs-identifier hs-var">sortedEntities</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681053765"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053765"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053766"><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053766"><span class="hs-identifier hs-var">entity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>      </span><span id="local-6989586621681053767"><span class="annot"><span class="annottext">Either CausalHashId ObjectId
</span><a href="#local-6989586621681053767"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashHandle
-&gt; Hash32
-&gt; TempEntity
-&gt; Transaction (Either CausalHashId ObjectId)
</span><span class="hs-identifier hs-var">Q.saveTempEntityInMain</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053765"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053766"><span class="hs-identifier hs-var">entity</span></a></span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ()) -&gt; IO () -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621681053763"><span class="hs-identifier hs-var">countC</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-241"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">Either CausalHashId ObjectId
</span><a href="#local-6989586621681053767"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><a href="#local-6989586621681053756"><span class="hs-identifier hs-type">validateBatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>    </span><span id="local-6989586621681053756"><span class="annot"><span class="annottext">validateBatch :: Stream (Vector (Hash32, TempEntity)) (Vector (Hash32, TempEntity))
</span><a href="#local-6989586621681053756"><span class="hs-identifier hs-var hs-var">validateBatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Vector (Hash32, TempEntity) -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; Stream
     (Vector (Hash32, TempEntity)) (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) a. Monad m =&gt; (a -&gt; m ()) -&gt; ConduitT a a m ()
</span><span class="hs-identifier hs-var">C.iterM</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053769"><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053769"><span class="hs-identifier hs-var">entities</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT SyncErr (ResourceT IO) ()
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053750"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IO (Either SyncErr ()) -&gt; ResourceT IO (Either SyncErr ()))
-&gt; ExceptT SyncErr IO () -&gt; ExceptT SyncErr (ResourceT IO) ()
forall (m :: * -&gt; *) e a (n :: * -&gt; *) e' b.
(m (Either e a) -&gt; n (Either e' b))
-&gt; ExceptT e m a -&gt; ExceptT e' n b
</span><span class="hs-identifier hs-var">mapExceptT</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr ()) -&gt; ResourceT IO (Either SyncErr ())
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ResourceT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr IO () -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ExceptT SyncErr IO () -&gt; ExceptT SyncErr (ResourceT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity) -&gt; ExceptT SyncErr IO ()
</span><a href="Unison.Share.SyncV2.html#batchValidateEntities"><span class="hs-identifier hs-var">batchValidateEntities</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053769"><span class="hs-identifier hs-var">entities</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">-- | Syncs a stream which sends entities which are already sorted in dependency order.</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- This allows us to stream them directly into the codebase as they're received.</span><span>
</span><span id="line-249"></span><span id="local-6989586621681053770"><span id="local-6989586621681053771"><span class="annot"><a href="Unison.Share.SyncV2.html#syncSortedStream"><span class="hs-identifier hs-type">syncSortedStream</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053770"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053771"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-254"></span><span id="syncSortedStream"><span class="annot"><span class="annottext">syncSortedStream :: forall v a.
Bool
-&gt; Codebase IO v a
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#syncSortedStream"><span class="hs-identifier hs-var hs-var">syncSortedStream</span></a></span></span><span> </span><span id="local-6989586621681053778"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053778"><span class="hs-identifier hs-var">shouldValidate</span></a></span></span><span> </span><span id="local-6989586621681053779"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053779"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621681053780"><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053780"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053037"><span class="annot"><a href="#local-6989586621681053781"><span class="hs-identifier hs-type">handler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681053037"><span class="hs-identifier hs-type">o</span></a></span></span><span>
</span><span id="line-256"></span><span>      </span><span id="local-6989586621681053781"><span class="annot"><span class="annottext">handler :: forall o. Stream (Vector (Hash32, TempEntity)) o
</span><a href="#local-6989586621681053781"><span class="hs-identifier hs-var hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Vector (Hash32, TempEntity) -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ConduitT
     (Vector (Hash32, TempEntity)) o (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a o.
Monad m =&gt;
(a -&gt; m ()) -&gt; ConduitT a o m ()
</span><span class="hs-identifier hs-var">C.mapM_C</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053784"><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053784"><span class="hs-identifier hs-var">entityBatch</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; Codebase IO v a
-&gt; Vector (Hash32, TempEntity)
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall v a.
Bool
-&gt; Codebase IO v a
-&gt; Vector (Hash32, TempEntity)
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#validateAndSave"><span class="hs-identifier hs-var">validateAndSave</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053778"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053779"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Hash32, TempEntity)
</span><a href="#local-6989586621681053784"><span class="hs-identifier hs-var">entityBatch</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall (m :: * -&gt; *) r. Monad m =&gt; ConduitT () Void m r -&gt; m r
</span><span class="hs-identifier hs-var">C.runConduit</span></span><span> </span><span class="annot"><span class="annottext">(ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
 -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053780"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-260"></span><span>      </span><span class="annot"><span class="annottext">Stream () EntityChunk
-&gt; ConduitT EntityChunk Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT () Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; ConduitT
     EntityChunk [EntityChunk] (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a. Monad m =&gt; Int -&gt; ConduitT a [a] m ()
</span><span class="hs-identifier hs-var">CL.chunksOf</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Unison.Share.SyncV2.html#batchSize"><span class="hs-identifier hs-var">batchSize</span></a></span><span>
</span><span id="line-261"></span><span>      </span><span class="annot"><span class="annottext">ConduitT
  EntityChunk [EntityChunk] (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT [EntityChunk] Void (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT EntityChunk Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
-&gt; Stream [EntityChunk] (Vector (Hash32, TempEntity))
forall v a.
Codebase IO v a
-&gt; Stream [EntityChunk] (Vector (Hash32, TempEntity))
</span><a href="Unison.Share.SyncV2.html#unpackChunks"><span class="hs-identifier hs-var">unpackChunks</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053779"><span class="hs-identifier hs-var">codebase</span></a></span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">Stream [EntityChunk] (Vector (Hash32, TempEntity))
-&gt; ConduitT
     (Vector (Hash32, TempEntity))
     Void
     (ExceptT SyncErr (ResourceT IO))
     ()
-&gt; ConduitT [EntityChunk] Void (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  (Vector (Hash32, TempEntity))
  Void
  (ExceptT SyncErr (ResourceT IO))
  ()
forall o. Stream (Vector (Hash32, TempEntity)) o
</span><a href="#local-6989586621681053781"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="annot"><span class="hs-comment">-- | Topologically sort entities based on their dependencies, returning a list in dependency-first order.</span></span><span>
</span><span id="line-265"></span><span id="local-6989586621681053025"><span class="annot"><a href="Unison.Share.SyncV2.html#sortDependencyFirst"><span class="hs-identifier hs-type">sortDependencyFirst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621681053025"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="#local-6989586621681053025"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053025"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-266"></span><span id="sortDependencyFirst"><span class="annot"><span class="annottext">sortDependencyFirst :: forall (f :: * -&gt; *).
(Foldable f, Functor f) =&gt;
f (Hash32, TempEntity) -&gt; [(Hash32, TempEntity)]
</span><a href="Unison.Share.SyncV2.html#sortDependencyFirst"><span class="hs-identifier hs-var hs-var">sortDependencyFirst</span></a></span></span><span> </span><span id="local-6989586621681053799"><span class="annot"><span class="annottext">f (Hash32, TempEntity)
</span><a href="#local-6989586621681053799"><span class="hs-identifier hs-var">entities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053800"><span class="annot"><span class="annottext">adjList :: f ((Hash32, TempEntity), Hash32, [Hash32])
</span><a href="#local-6989586621681053800"><span class="hs-identifier hs-var hs-var">adjList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">f (Hash32, TempEntity)
</span><a href="#local-6989586621681053799"><span class="hs-identifier hs-var">entities</span></a></span><span> </span><span class="annot"><span class="annottext">f (Hash32, TempEntity)
-&gt; ((Hash32, TempEntity)
    -&gt; ((Hash32, TempEntity), Hash32, [Hash32]))
-&gt; f ((Hash32, TempEntity), Hash32, [Hash32])
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681053802"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053802"><span class="hs-identifier hs-var">hash32</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053803"><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053803"><span class="hs-identifier hs-var">entity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053802"><span class="hs-identifier hs-var">hash32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053803"><span class="hs-identifier hs-var">entity</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053802"><span class="hs-identifier hs-var">hash32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set Hash32 -&gt; [Hash32]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set Hash32 -&gt; [Hash32]) -&gt; Set Hash32 -&gt; [Hash32]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Entity Text Hash32 Hash32 -&gt; Set Hash32
forall hash text noSyncHash.
Ord hash =&gt;
Entity text noSyncHash hash -&gt; Set hash
</span><span class="hs-identifier hs-var">Share.entityDependencies</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TempEntity -&gt; Entity Text Hash32 Hash32
</span><span class="hs-identifier hs-var">tempEntityToEntity</span></span><span> </span><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053803"><span class="hs-identifier hs-var">entity</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681053806"><span class="annot"><span class="annottext">Graph
</span><a href="#local-6989586621681053806"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053807"><span class="annot"><span class="annottext">Int -&gt; ((Hash32, TempEntity), Hash32, [Hash32])
</span><a href="#local-6989586621681053807"><span class="hs-identifier hs-var">vertexInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053808"><span class="annot"><span class="annottext">Hash32 -&gt; Maybe Int
</span><a href="#local-6989586621681053808"><span class="hs-identifier hs-var">_vertexForKey</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[((Hash32, TempEntity), Hash32, [Hash32])]
-&gt; (Graph, Int -&gt; ((Hash32, TempEntity), Hash32, [Hash32]),
    Hash32 -&gt; Maybe Int)
forall key node.
Ord key =&gt;
[(node, key, [key])]
-&gt; (Graph, Int -&gt; (node, key, [key]), key -&gt; Maybe Int)
</span><span class="hs-identifier hs-var">Graph.graphFromEdges</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f ((Hash32, TempEntity), Hash32, [Hash32])
-&gt; [((Hash32, TempEntity), Hash32, [Hash32])]
forall a. f a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">Foldable.toList</span></span><span> </span><span class="annot"><span class="annottext">f ((Hash32, TempEntity), Hash32, [Hash32])
</span><a href="#local-6989586621681053800"><span class="hs-identifier hs-var">adjList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Graph -&gt; [Int]
</span><span class="hs-identifier hs-var">Graph.reverseTopSort</span></span><span> </span><span class="annot"><span class="annottext">Graph
</span><a href="#local-6989586621681053806"><span class="hs-identifier hs-var">graph</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; (Hash32, TempEntity)) -&gt; [(Hash32, TempEntity)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053812"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681053812"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting
  (Hash32, TempEntity)
  ((Hash32, TempEntity), Hash32, [Hash32])
  (Hash32, TempEntity)
-&gt; ((Hash32, TempEntity), Hash32, [Hash32]) -&gt; (Hash32, TempEntity)
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Hash32, TempEntity)
  ((Hash32, TempEntity), Hash32, [Hash32])
  (Hash32, TempEntity)
forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens
  ((Hash32, TempEntity), Hash32, [Hash32])
  ((Hash32, TempEntity), Hash32, [Hash32])
  (Hash32, TempEntity)
  (Hash32, TempEntity)
</span><span class="hs-identifier hs-var">_1</span></span><span> </span><span class="annot"><span class="annottext">(((Hash32, TempEntity), Hash32, [Hash32]) -&gt; (Hash32, TempEntity))
-&gt; ((Hash32, TempEntity), Hash32, [Hash32]) -&gt; (Hash32, TempEntity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ((Hash32, TempEntity), Hash32, [Hash32])
</span><a href="#local-6989586621681053807"><span class="hs-identifier hs-var">vertexInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681053812"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="annot"><span class="hs-comment">-- | Unpack a single entity chunk, returning the entity if it's not already in the codebase, Nothing otherwise.</span></span><span>
</span><span id="line-272"></span><span class="annot"><a href="Unison.Share.SyncV2.html#unpackChunk"><span class="hs-identifier hs-type">unpackChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-type">SyncErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span id="unpackChunk"><span class="annot"><span class="annottext">unpackChunk :: EntityChunk
-&gt; ExceptT SyncErr Transaction (Maybe (Hash32, TempEntity))
</span><a href="Unison.Share.SyncV2.html#unpackChunk"><span class="hs-identifier hs-var hs-var">unpackChunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621681053817"><span class="annot"><span class="annottext">Hash32
hash :: Hash32
$sel:hash:EntityChunk :: EntityChunk -&gt; Hash32
</span><a href="#local-6989586621681053817"><span class="hs-identifier hs-var hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:entityCBOR:EntityChunk :: EntityChunk -&gt; CBORBytes TempEntity
</span><span class="hs-identifier hs-var">entityCBOR</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681053820"><span class="annot"><span class="annottext">CBORBytes TempEntity
</span><a href="#local-6989586621681053820"><span class="hs-identifier hs-var">entityBytes</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-comment">-- Only want entities we don't already have</span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Maybe EntityLocation)
-&gt; ExceptT SyncErr Transaction (Maybe EntityLocation)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT SyncErr m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32 -&gt; Transaction (Maybe EntityLocation)
</span><span class="hs-identifier hs-var">Q.entityLocation</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053817"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr Transaction (Maybe EntityLocation)
-&gt; (Maybe EntityLocation
    -&gt; ExceptT SyncErr Transaction (Maybe (Hash32, TempEntity)))
-&gt; ExceptT SyncErr Transaction (Maybe (Hash32, TempEntity))
forall a b.
ExceptT SyncErr Transaction a
-&gt; (a -&gt; ExceptT SyncErr Transaction b)
-&gt; ExceptT SyncErr Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-277"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityLocation
</span><span class="hs-identifier hs-var">Q.EntityInMainStorage</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Hash32, TempEntity)
-&gt; ExceptT SyncErr Transaction (Maybe (Hash32, TempEntity))
forall a. a -&gt; ExceptT SyncErr Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Hash32, TempEntity)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="annottext">Maybe EntityLocation
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Hash32, TempEntity) -&gt; Maybe (Hash32, TempEntity)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((Hash32, TempEntity) -&gt; Maybe (Hash32, TempEntity))
-&gt; (TempEntity -&gt; (Hash32, TempEntity))
-&gt; TempEntity
-&gt; Maybe (Hash32, TempEntity)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053817"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TempEntity -&gt; Maybe (Hash32, TempEntity))
-&gt; ExceptT SyncErr Transaction TempEntity
-&gt; ExceptT SyncErr Transaction (Maybe (Hash32, TempEntity))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CBORBytes TempEntity -&gt; ExceptT SyncErr Transaction TempEntity
</span><a href="#local-6989586621681053822"><span class="hs-identifier hs-var">unpackEntity</span></a></span><span> </span><span class="annot"><span class="annottext">CBORBytes TempEntity
</span><a href="#local-6989586621681053820"><span class="hs-identifier hs-var">entityBytes</span></a></span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><a href="#local-6989586621681053822"><span class="hs-identifier hs-type">unpackEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBORBytes</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-type">SyncErr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span>
</span><span id="line-282"></span><span>      </span><span id="local-6989586621681053822"><span class="annot"><span class="annottext">unpackEntity :: CBORBytes TempEntity -&gt; ExceptT SyncErr Transaction TempEntity
</span><a href="#local-6989586621681053822"><span class="hs-identifier hs-var hs-var">unpackEntity</span></a></span></span><span> </span><span id="local-6989586621681053823"><span class="annot"><span class="annottext">CBORBytes TempEntity
</span><a href="#local-6989586621681053823"><span class="hs-identifier hs-var">entityBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-283"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CBORBytes TempEntity -&gt; Either DeserialiseFailure TempEntity
forall t. Serialise t =&gt; CBORBytes t -&gt; Either DeserialiseFailure t
</span><span class="hs-identifier hs-var">CBOR.deserialiseOrFailCBORBytes</span></span><span> </span><span class="annot"><span class="annottext">CBORBytes TempEntity
</span><a href="#local-6989586621681053823"><span class="hs-identifier hs-var">entityBytes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681053825"><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681053825"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr Transaction TempEntity
forall a. SyncErr -&gt; ExceptT SyncErr Transaction a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ExceptT SyncErr Transaction TempEntity)
-&gt; SyncErr -&gt; ExceptT SyncErr Transaction TempEntity
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; SyncErr) -&gt; SyncError -&gt; SyncErr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorDeserializationFailure</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681053825"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681053828"><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053828"><span class="hs-identifier hs-var">entity</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TempEntity -&gt; ExceptT SyncErr Transaction TempEntity
forall a. a -&gt; ExceptT SyncErr Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053828"><span class="hs-identifier hs-var">entity</span></a></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span id="local-6989586621681053016"><span id="local-6989586621681053017"><span class="annot"><a href="Unison.Share.SyncV2.html#unpackChunks"><span class="hs-identifier hs-type">unpackChunks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053016"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053017"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TempEntity</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-288"></span><span id="unpackChunks"><span class="annot"><span class="annottext">unpackChunks :: forall v a.
Codebase IO v a
-&gt; Stream [EntityChunk] (Vector (Hash32, TempEntity))
</span><a href="Unison.Share.SyncV2.html#unpackChunks"><span class="hs-identifier hs-var hs-var">unpackChunks</span></a></span></span><span> </span><span id="local-6989586621681053838"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053838"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([EntityChunk]
 -&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity)))
-&gt; Stream [EntityChunk] (Vector (Hash32, TempEntity))
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; ConduitT a b m ()
</span><span class="hs-identifier hs-var">C.mapM</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053840"><span class="annot"><span class="annottext">[EntityChunk]
</span><a href="#local-6989586621681053840"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr (Vector (Hash32, TempEntity)))
-&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity))
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr (Vector (Hash32, TempEntity)))
 -&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity)))
-&gt; (ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
    -&gt; ResourceT IO (Either SyncErr (Vector (Hash32, TempEntity))))
-&gt; ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
-&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr (Vector (Hash32, TempEntity)))
-&gt; ResourceT IO (Either SyncErr (Vector (Hash32, TempEntity)))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ResourceT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr (Vector (Hash32, TempEntity)))
 -&gt; ResourceT IO (Either SyncErr (Vector (Hash32, TempEntity))))
-&gt; (ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
    -&gt; IO (Either SyncErr (Vector (Hash32, TempEntity))))
-&gt; ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
-&gt; ResourceT IO (Either SyncErr (Vector (Hash32, TempEntity)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
-&gt; ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
-&gt; IO (Either SyncErr (Vector (Hash32, TempEntity)))
forall (m :: * -&gt; *) v a e b.
MonadIO m =&gt;
Codebase m v a -&gt; ExceptT e Transaction b -&gt; m (Either e b)
</span><span class="hs-identifier hs-var">Codebase.runTransactionExceptT</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053838"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
 -&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity)))
-&gt; ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
-&gt; ExceptT SyncErr (ResourceT IO) (Vector (Hash32, TempEntity))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><span class="annottext">[EntityChunk]
-&gt; (EntityChunk
    -&gt; ExceptT SyncErr Transaction (Maybe (Hash32, TempEntity)))
-&gt; ExceptT SyncErr Transaction [Maybe (Hash32, TempEntity)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[EntityChunk]
</span><a href="#local-6989586621681053840"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">EntityChunk
-&gt; ExceptT SyncErr Transaction (Maybe (Hash32, TempEntity))
</span><a href="Unison.Share.SyncV2.html#unpackChunk"><span class="hs-identifier hs-var">unpackChunk</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><span class="annottext">ExceptT SyncErr Transaction [Maybe (Hash32, TempEntity)]
-&gt; ([Maybe (Hash32, TempEntity)] -&gt; [(Hash32, TempEntity)])
-&gt; ExceptT SyncErr Transaction [(Hash32, TempEntity)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Hash32, TempEntity)] -&gt; [(Hash32, TempEntity)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span>
</span><span id="line-291"></span><span>    </span><span class="annot"><span class="annottext">ExceptT SyncErr Transaction [(Hash32, TempEntity)]
-&gt; ([(Hash32, TempEntity)] -&gt; Vector (Hash32, TempEntity))
-&gt; ExceptT SyncErr Transaction (Vector (Hash32, TempEntity))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Hash32, TempEntity)] -&gt; Vector (Hash32, TempEntity)
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">Vector.fromList</span></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="annot"><span class="hs-comment">-- | Stream entities from one codebase into another.</span></span><span>
</span><span id="line-294"></span><span id="local-6989586621681052926"><span id="local-6989586621681052927"><span class="annot"><a href="Unison.Share.SyncV2.html#streamIntoCodebase"><span class="hs-identifier hs-type">streamIntoCodebase</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Whether to validate entities as they're imported.</span></span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052926"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052927"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.StreamInitInfo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-301"></span><span id="streamIntoCodebase"><span class="annot"><span class="annottext">streamIntoCodebase :: forall v a.
Bool
-&gt; Codebase IO v a
-&gt; StreamInitInfo
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#streamIntoCodebase"><span class="hs-identifier hs-var hs-var">streamIntoCodebase</span></a></span></span><span> </span><span id="local-6989586621681053860"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053860"><span class="hs-identifier hs-var">shouldValidate</span></a></span></span><span> </span><span id="local-6989586621681053861"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053861"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.StreamInitInfo</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621681053863"><span class="annot"><span class="annottext">Version
version :: Version
$sel:version:StreamInitInfo :: StreamInitInfo -&gt; Version
</span><a href="#local-6989586621681053863"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053865"><span class="annot"><span class="annottext">EntitySorting
entitySorting :: EntitySorting
$sel:entitySorting:StreamInitInfo :: StreamInitInfo -&gt; EntitySorting
</span><a href="#local-6989586621681053865"><span class="hs-identifier hs-var hs-var">entitySorting</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:numEntities:StreamInitInfo :: StreamInitInfo -&gt; Maybe Word64
</span><span class="hs-identifier hs-var">numEntities</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681053868"><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621681053868"><span class="hs-identifier hs-var">numEntities</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621681053869"><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053869"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr ())
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><span class="annottext">Maybe Int
-&gt; (ConduitT
      EntityChunk EntityChunk (ExceptT SyncErr (ResourceT IO)) ()
    -&gt; ResourceT IO (Either SyncErr ()))
-&gt; ResourceT IO (Either SyncErr ())
forall (m :: * -&gt; *) (n :: * -&gt; *) i a.
(MonadIO m, MonadUnliftIO n) =&gt;
Maybe Int -&gt; (ConduitT i i m () -&gt; n a) -&gt; n a
</span><a href="Unison.Share.SyncV2.html#withStreamProgressCallback"><span class="hs-identifier hs-var">withStreamProgressCallback</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Int) -&gt; Maybe Word64 -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621681053868"><span class="hs-identifier hs-var">numEntities</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053870"><span class="annot"><span class="annottext">ConduitT
  EntityChunk EntityChunk (ExceptT SyncErr (ResourceT IO)) ()
</span><a href="#local-6989586621681053870"><span class="hs-identifier hs-var">countC</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr (ResourceT IO) ()
-&gt; ResourceT IO (Either SyncErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-comment">-- Add a counter to the stream to track how many entities we've processed.</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053871"><span class="annot"><span class="annottext">stream' :: Stream () EntityChunk
</span><a href="#local-6989586621681053871"><span class="hs-identifier hs-var hs-var">stream'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053869"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
-&gt; ConduitT
     EntityChunk EntityChunk (ExceptT SyncErr (ResourceT IO)) ()
-&gt; Stream () EntityChunk
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  EntityChunk EntityChunk (ExceptT SyncErr (ResourceT IO)) ()
</span><a href="#local-6989586621681053870"><span class="hs-identifier hs-var">countC</span></a></span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621681053863"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SyncV2.Version</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT SyncErr (ResourceT IO) ()
forall a. a -&gt; ExceptT SyncErr (ResourceT IO) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>      </span><span id="local-6989586621681053873"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621681053873"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr (ResourceT IO) ()
forall a. SyncErr -&gt; ExceptT SyncErr (ResourceT IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; SyncError -&gt; ExceptT SyncErr (ResourceT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorUnsupportedVersion</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621681053873"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EntitySorting
</span><a href="#local-6989586621681053865"><span class="hs-identifier hs-var">entitySorting</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-310"></span><span>      </span><span class="annot"><span class="annottext">EntitySorting
</span><span class="hs-identifier hs-var">SyncV2.DependenciesFirst</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; Codebase IO v a
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall v a.
Bool
-&gt; Codebase IO v a
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#syncSortedStream"><span class="hs-identifier hs-var">syncSortedStream</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053860"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053861"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053871"><span class="hs-identifier hs-var">stream'</span></a></span><span>
</span><span id="line-311"></span><span>      </span><span class="annot"><span class="annottext">EntitySorting
</span><span class="hs-identifier hs-var">SyncV2.Unsorted</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; Codebase IO v a
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall v a.
Bool
-&gt; Codebase IO v a
-&gt; Stream () EntityChunk
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#syncUnsortedStream"><span class="hs-identifier hs-var">syncUnsortedStream</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681053860"><span class="hs-identifier hs-var">shouldValidate</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053861"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681053871"><span class="hs-identifier hs-var">stream'</span></a></span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="annot"><span class="hs-comment">-- | A sanity-check to verify that the hash we expected to import from the stream was successfully loaded into the codebase.</span></span><span>
</span><span id="line-314"></span><span id="local-6989586621681052928"><span id="local-6989586621681052929"><span class="annot"><a href="Unison.Share.SyncV2.html#afterSyncChecks"><span class="hs-identifier hs-type">afterSyncChecks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052928"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-type">SyncError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.PullError</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-315"></span><span id="afterSyncChecks"><span class="annot"><span class="annottext">afterSyncChecks :: forall v a. Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr IO ()
</span><a href="Unison.Share.SyncV2.html#afterSyncChecks"><span class="hs-identifier hs-var hs-var">afterSyncChecks</span></a></span></span><span> </span><span id="local-6989586621681053885"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053885"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621681053886"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053886"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><span class="annottext">IO Bool -&gt; ExceptT SyncErr IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT SyncErr m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Hash32 -&gt; IO Bool
forall v a. Codebase IO v a -&gt; Hash32 -&gt; IO Bool
</span><a href="#local-6989586621681053887"><span class="hs-identifier hs-var">didCausalSuccessfullyImport</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053885"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053886"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr IO Bool
-&gt; (Bool -&gt; ExceptT SyncErr IO ()) -&gt; ExceptT SyncErr IO ()
forall a b.
ExceptT SyncErr IO a
-&gt; (a -&gt; ExceptT SyncErr IO b) -&gt; ExceptT SyncErr IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>      </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr IO ()
forall a. SyncErr -&gt; ExceptT SyncErr IO a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; PullError)
-&gt; (Hash32 -&gt; SyncError) -&gt; Hash32 -&gt; PullError
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorExpectedResultNotInMain</span></span><span> </span><span class="annot"><span class="annottext">(CausalHash -&gt; SyncError)
-&gt; (Hash32 -&gt; CausalHash) -&gt; Hash32 -&gt; SyncError
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; CausalHash
</span><span class="hs-identifier hs-var">hash32ToCausalHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash32 -&gt; PullError) -&gt; Hash32 -&gt; PullError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053886"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT SyncErr IO ()
forall a. a -&gt; ExceptT SyncErr IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="annottext">ExceptT SyncErr IO Bool -&gt; ExceptT SyncErr IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr IO Bool -&gt; ExceptT SyncErr IO ())
-&gt; ExceptT SyncErr IO Bool -&gt; ExceptT SyncErr IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; ExceptT SyncErr IO Bool
forall a. IO a -&gt; ExceptT SyncErr IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO v a -&gt; forall x. (Connection -&gt; IO x) -&gt; IO x
forall (m :: * -&gt; *) v a.
Codebase m v a -&gt; forall x. (Connection -&gt; m x) -&gt; m x
</span><span class="hs-identifier hs-var">Codebase.withConnection</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053885"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO Bool
</span><span class="hs-identifier hs-var">Sqlite.vacuum</span></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">-- Verify that the expected hash made it into main storage.</span><span>
</span><span id="line-323"></span><span>    </span><span id="local-6989586621681053099"><span id="local-6989586621681053100"><span class="annot"><a href="#local-6989586621681053887"><span class="hs-identifier hs-type">didCausalSuccessfullyImport</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053099"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053100"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-324"></span><span>    </span><span id="local-6989586621681053887"><span class="annot"><span class="annottext">didCausalSuccessfullyImport :: forall v a. Codebase IO v a -&gt; Hash32 -&gt; IO Bool
</span><a href="#local-6989586621681053887"><span class="hs-identifier hs-var hs-var">didCausalSuccessfullyImport</span></a></span></span><span> </span><span id="local-6989586621681053892"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053892"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621681053893"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053893"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053894"><span class="annot"><span class="annottext">expectedHash :: CausalHash
</span><a href="#local-6989586621681053894"><span class="hs-identifier hs-var hs-var">expectedHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; CausalHash
</span><span class="hs-identifier hs-var">hash32ToCausalHash</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053893"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><span class="annottext">Maybe (CausalHashId, BranchHashId) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (CausalHashId, BranchHashId) -&gt; Bool)
-&gt; IO (Maybe (CausalHashId, BranchHashId)) -&gt; IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO v a
-&gt; Transaction (Maybe (CausalHashId, BranchHashId))
-&gt; IO (Maybe (CausalHashId, BranchHashId))
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681053892"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe (CausalHashId, BranchHashId))
 -&gt; IO (Maybe (CausalHashId, BranchHashId)))
-&gt; Transaction (Maybe (CausalHashId, BranchHashId))
-&gt; IO (Maybe (CausalHashId, BranchHashId))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; Transaction (Maybe (CausalHashId, BranchHashId))
</span><span class="hs-identifier hs-var">Q.loadCausalByCausalHash</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053894"><span class="hs-identifier hs-var">expectedHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span class="annot"><span class="hs-comment">-- | Load and stream entities for a given causal hash from a codebase into a stream.</span></span><span>
</span><span id="line-329"></span><span id="local-6989586621681052871"><span id="local-6989586621681052872"><span class="annot"><a href="Unison.Share.SyncV2.html#withCodebaseEntityStream"><span class="hs-identifier hs-type">withCodebaseEntityStream</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052871"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-331"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-332"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.BranchRef</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Callback to call with the total count of entities and the stream.</span></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681052871"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052872"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><a href="#local-6989586621681052871"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052872"><span class="hs-identifier hs-type">r</span></a></span></span></span><span>
</span><span id="line-337"></span><span id="withCodebaseEntityStream"><span class="annot"><span class="annottext">withCodebaseEntityStream :: forall (m :: * -&gt; *) r.
MonadIO m =&gt;
Connection
-&gt; CausalHash
-&gt; Maybe BranchRef
-&gt; (Int -&gt; Stream () DownloadEntitiesChunk -&gt; m r)
-&gt; m r
</span><a href="Unison.Share.SyncV2.html#withCodebaseEntityStream"><span class="hs-identifier hs-var hs-var">withCodebaseEntityStream</span></a></span></span><span> </span><span id="local-6989586621681053961"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621681053961"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621681053962"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053962"><span class="hs-identifier hs-var">rootHash</span></a></span></span><span> </span><span id="local-6989586621681053963"><span class="annot"><span class="annottext">Maybe BranchRef
</span><a href="#local-6989586621681053963"><span class="hs-identifier hs-var">mayBranchRef</span></a></span></span><span> </span><span id="local-6989586621681053964"><span class="annot"><span class="annottext">Int -&gt; Stream () DownloadEntitiesChunk -&gt; m r
</span><a href="#local-6989586621681053964"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-338"></span><span>  </span><span id="local-6989586621681053965"><span class="annot"><span class="annottext">Map Hash32 (Entity Text Hash32 Hash32)
</span><a href="#local-6989586621681053965"><span class="hs-identifier hs-var">entities</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Map Hash32 (Entity Text Hash32 Hash32))
-&gt; m (Map Hash32 (Entity Text Hash32 Hash32))
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Map Hash32 (Entity Text Hash32 Hash32))
 -&gt; m (Map Hash32 (Entity Text Hash32 Hash32)))
-&gt; IO (Map Hash32 (Entity Text Hash32 Hash32))
-&gt; m (Map Hash32 (Entity Text Hash32 Hash32))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO (Map Hash32 (Entity Text Hash32 Hash32)))
-&gt; IO (Map Hash32 (Entity Text Hash32 Hash32))
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
((Int -&gt; m ()) -&gt; m a) -&gt; m a
</span><a href="Unison.Share.SyncV2.html#withEntityLoadingCallback"><span class="hs-identifier hs-var">withEntityLoadingCallback</span></a></span><span> </span><span class="annot"><span class="annottext">(((Int -&gt; IO ()) -&gt; IO (Map Hash32 (Entity Text Hash32 Hash32)))
 -&gt; IO (Map Hash32 (Entity Text Hash32 Hash32)))
-&gt; ((Int -&gt; IO ()) -&gt; IO (Map Hash32 (Entity Text Hash32 Hash32)))
-&gt; IO (Map Hash32 (Entity Text Hash32 Hash32))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681053967"><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621681053967"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>    </span><span class="annot"><span class="annottext">Connection
-&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32))
-&gt; IO (Map Hash32 (Entity Text Hash32 Hash32))
forall (m :: * -&gt; *) a.
(MonadIO m, HasCallStack) =&gt;
Connection -&gt; Transaction a -&gt; m a
</span><span class="hs-identifier hs-var">Sqlite.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621681053961"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash
-&gt; (Int -&gt; IO ())
-&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32))
</span><a href="#local-6989586621681053968"><span class="hs-identifier hs-var">depsForCausal</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053962"><span class="hs-identifier hs-var">rootHash</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621681053967"><span class="hs-identifier hs-var">counter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">Text.hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><span class="hs-identifier hs-var">IO.stderr</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; Text -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Finished loading entities, writing sync-file.&quot;</span></span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053971"><span class="annot"><span class="annottext">totalEntities :: Int
</span><a href="#local-6989586621681053971"><span class="hs-identifier hs-var hs-var">totalEntities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Hash32 (Entity Text Hash32 Hash32) -&gt; Int
forall k a. Map k a -&gt; Int
</span><span class="hs-identifier hs-var">Map.size</span></span><span> </span><span class="annot"><span class="annottext">Map Hash32 (Entity Text Hash32 Hash32)
</span><a href="#local-6989586621681053965"><span class="hs-identifier hs-var">entities</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053973"><span class="annot"><span class="annottext">initialChunk :: DownloadEntitiesChunk
</span><a href="#local-6989586621681053973"><span class="hs-identifier hs-var hs-var">initialChunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-343"></span><span>        </span><span class="annot"><span class="annottext">StreamInitInfo -&gt; DownloadEntitiesChunk
</span><span class="hs-identifier hs-var">SyncV2.InitialC</span></span><span>
</span><span id="line-344"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.StreamInitInfo</span></span><span>
</span><span id="line-345"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:rootCausalHash:StreamInitInfo :: Hash32
</span><span class="hs-identifier hs-var">rootCausalHash</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; Hash32
</span><span class="hs-identifier hs-var">causalHashToHash32</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053962"><span class="hs-identifier hs-var">rootHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>                </span><span class="annot"><span class="annottext">$sel:version:StreamInitInfo :: Version
</span><span class="hs-identifier hs-var">version</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Version
</span><span class="hs-identifier hs-var">SyncV2.Version</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span>
</span><span id="line-347"></span><span>                </span><span class="annot"><span class="annottext">$sel:entitySorting:StreamInitInfo :: EntitySorting
</span><span class="hs-identifier hs-var">entitySorting</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntitySorting
</span><span class="hs-identifier hs-var">SyncV2.DependenciesFirst</span></span><span class="hs-special">,</span><span>
</span><span id="line-348"></span><span>                </span><span class="annot"><span class="annottext">$sel:numEntities:StreamInitInfo :: Maybe Word64
</span><span class="hs-identifier hs-var">numEntities</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Maybe Word64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Maybe Word64) -&gt; Word64 -&gt; Maybe Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681053971"><span class="hs-identifier hs-var">totalEntities</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-349"></span><span>                </span><span class="annot"><span class="annottext">$sel:rootBranchRef:StreamInitInfo :: Maybe BranchRef
</span><span class="hs-identifier hs-var">rootBranchRef</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe BranchRef
</span><a href="#local-6989586621681053963"><span class="hs-identifier hs-var">mayBranchRef</span></a></span><span>
</span><span id="line-350"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-351"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053976"><span class="annot"><span class="annottext">contents :: [DownloadEntitiesChunk]
</span><a href="#local-6989586621681053976"><span class="hs-identifier hs-var hs-var">contents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">Map Hash32 (Entity Text Hash32 Hash32)
</span><a href="#local-6989586621681053965"><span class="hs-identifier hs-var">entities</span></a></span><span>
</span><span id="line-354"></span><span>          </span><span class="annot"><span class="annottext">Map Hash32 (Entity Text Hash32 Hash32)
-&gt; (Map Hash32 (Entity Text Hash32 Hash32)
    -&gt; Map Hash32 TempEntity)
-&gt; Map Hash32 TempEntity
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Entity Text Hash32 Hash32 -&gt; TempEntity)
-&gt; Map Hash32 (Entity Text Hash32 Hash32) -&gt; Map Hash32 TempEntity
forall a b. (a -&gt; b) -&gt; Map Hash32 a -&gt; Map Hash32 b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Hash32 -&gt; Hash32) -&gt; Entity Text Hash32 Hash32 -&gt; TempEntity
forall hash.
(hash -&gt; Hash32) -&gt; Entity Text Hash32 hash -&gt; TempEntity
</span><span class="hs-identifier hs-var">Sync.entityToTempEntity</span></span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; Hash32
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>          </span><span class="annot"><span class="annottext">Map Hash32 TempEntity
-&gt; (Map Hash32 TempEntity -&gt; [(Hash32, TempEntity)])
-&gt; [(Hash32, TempEntity)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map Hash32 TempEntity -&gt; [(Hash32, TempEntity)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span>
</span><span id="line-356"></span><span>          </span><span class="annot"><span class="annottext">[(Hash32, TempEntity)]
-&gt; ([(Hash32, TempEntity)] -&gt; [(Hash32, TempEntity)])
-&gt; [(Hash32, TempEntity)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(Hash32, TempEntity)] -&gt; [(Hash32, TempEntity)]
forall (f :: * -&gt; *).
(Foldable f, Functor f) =&gt;
f (Hash32, TempEntity) -&gt; [(Hash32, TempEntity)]
</span><a href="Unison.Share.SyncV2.html#sortDependencyFirst"><span class="hs-identifier hs-var">sortDependencyFirst</span></a></span><span>
</span><span id="line-357"></span><span>          </span><span class="annot"><span class="annottext">[(Hash32, TempEntity)]
-&gt; ([(Hash32, TempEntity)] -&gt; [DownloadEntitiesChunk])
-&gt; [DownloadEntitiesChunk]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">((Hash32, TempEntity) -&gt; DownloadEntitiesChunk)
-&gt; [(Hash32, TempEntity)] -&gt; [DownloadEntitiesChunk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681053981"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053981"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681053982"><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053982"><span class="hs-identifier hs-var">entity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053983"><span class="annot"><span class="annottext">entityCBOR :: CBORBytes TempEntity
</span><a href="#local-6989586621681053983"><span class="hs-identifier hs-var hs-var">entityCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TempEntity -&gt; CBORBytes TempEntity
forall t. Serialise t =&gt; t -&gt; CBORBytes t
</span><span class="hs-identifier hs-var">CBOR.serialiseCBORBytes</span></span><span> </span><span class="annot"><span class="annottext">TempEntity
</span><a href="#local-6989586621681053982"><span class="hs-identifier hs-var">entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EntityChunk -&gt; DownloadEntitiesChunk
</span><span class="hs-identifier hs-var">SyncV2.EntityC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">Hash32
$sel:hash:EntityChunk :: Hash32
hash :: Hash32
</span><span class="hs-identifier hs-var hs-var">hash</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CBORBytes TempEntity
$sel:entityCBOR:EntityChunk :: CBORBytes TempEntity
entityCBOR :: CBORBytes TempEntity
</span><span class="hs-identifier hs-var hs-var">entityCBOR</span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>          </span><span class="annot"><span class="annottext">[DownloadEntitiesChunk]
-&gt; ([DownloadEntitiesChunk] -&gt; [DownloadEntitiesChunk])
-&gt; [DownloadEntitiesChunk]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DownloadEntitiesChunk
</span><a href="#local-6989586621681053973"><span class="hs-identifier hs-var">initialChunk</span></a></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesChunk
-&gt; [DownloadEntitiesChunk] -&gt; [DownloadEntitiesChunk]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681053986"><span class="annot"><span class="annottext">stream :: ConduitT
  ()
  (Element [DownloadEntitiesChunk])
  (ExceptT SyncErr (ResourceT IO))
  ()
</span><a href="#local-6989586621681053986"><span class="hs-identifier hs-var hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DownloadEntitiesChunk]
-&gt; ConduitT
     ()
     (Element [DownloadEntitiesChunk])
     (ExceptT SyncErr (ResourceT IO))
     ()
forall (m :: * -&gt; *) mono i.
(Monad m, MonoFoldable mono) =&gt;
mono -&gt; ConduitT i (Element mono) m ()
</span><span class="hs-identifier hs-var">C.yieldMany</span></span><span> </span><span class="annot"><span class="annottext">[DownloadEntitiesChunk]
</span><a href="#local-6989586621681053976"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-363"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Stream () DownloadEntitiesChunk -&gt; m r
</span><a href="#local-6989586621681053964"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681053971"><span class="hs-identifier hs-var">totalEntities</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681053986"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-comment">-- Collect all dependencies of a given causal hash.</span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><a href="#local-6989586621681053968"><span class="hs-identifier hs-type">depsForCausal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.Entity</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621681053968"><span class="annot"><span class="annottext">depsForCausal :: CausalHash
-&gt; (Int -&gt; IO ())
-&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32))
</span><a href="#local-6989586621681053968"><span class="hs-identifier hs-var hs-var">depsForCausal</span></a></span></span><span> </span><span id="local-6989586621681053988"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053988"><span class="hs-identifier hs-var">causalHash</span></a></span></span><span> </span><span id="local-6989586621681053989"><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621681053989"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-368"></span><span>      </span><span class="annot"><span class="annottext">(StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
 -&gt; Map Hash32 (Entity Text Hash32 Hash32)
 -&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32)))
-&gt; Map Hash32 (Entity Text Hash32 Hash32)
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
-&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
-&gt; Map Hash32 (Entity Text Hash32 Hash32)
-&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32))
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">execStateT</span></span><span> </span><span class="annot"><span class="annottext">Map Hash32 (Entity Text Hash32 Hash32)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
 -&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32)))
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
-&gt; Transaction (Map Hash32 (Entity Text Hash32 Hash32))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Hash32
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
</span><a href="#local-6989586621681053992"><span class="hs-identifier hs-var">expandEntities</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; Hash32
</span><span class="hs-identifier hs-var">causalHashToHash32</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621681053988"><span class="hs-identifier hs-var">causalHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-370"></span><span>        </span><span class="annot"><a href="#local-6989586621681053992"><span class="hs-identifier hs-type">expandEntities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.Entity</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>        </span><span id="local-6989586621681053992"><span class="annot"><span class="annottext">expandEntities :: Hash32
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
</span><a href="#local-6989586621681053992"><span class="hs-identifier hs-var hs-var">expandEntities</span></a></span></span><span> </span><span id="local-6989586621681053993"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053993"><span class="hs-identifier hs-var">hash32</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>          </span><span class="annot"><span class="annottext">(Map Hash32 (Entity Text Hash32 Hash32) -&gt; Bool)
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction Bool
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32 -&gt; Map Hash32 (Entity Text Hash32 Hash32) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.member</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053993"><span class="hs-identifier hs-var">hash32</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction Bool
-&gt; (Bool
    -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ())
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
forall a b.
StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction a
-&gt; (a
    -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction b)
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-373"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">()
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
forall a.
a -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>              </span><span id="local-6989586621681053996"><span class="annot"><span class="annottext">Entity Text Hash32 Hash32
</span><a href="#local-6989586621681053996"><span class="hs-identifier hs-var">entity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (Entity Text Hash32 Hash32)
-&gt; StateT
     (Map Hash32 (Entity Text Hash32 Hash32))
     Transaction
     (Entity Text Hash32 Hash32)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Entity Text Hash32 Hash32)
 -&gt; StateT
      (Map Hash32 (Entity Text Hash32 Hash32))
      Transaction
      (Entity Text Hash32 Hash32))
-&gt; Transaction (Entity Text Hash32 Hash32)
-&gt; StateT
     (Map Hash32 (Entity Text Hash32 Hash32))
     Transaction
     (Entity Text Hash32 Hash32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; Transaction (Entity Text Hash32 Hash32)
</span><span class="hs-identifier hs-var">Sync.expectEntity</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053993"><span class="hs-identifier hs-var">hash32</span></a></span><span>
</span><span id="line-376"></span><span>              </span><span class="annot"><span class="annottext">(Map Hash32 (Entity Text Hash32 Hash32)
 -&gt; Map Hash32 (Entity Text Hash32 Hash32))
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32
-&gt; Entity Text Hash32 Hash32
-&gt; Map Hash32 (Entity Text Hash32 Hash32)
-&gt; Map Hash32 (Entity Text Hash32 Hash32)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681053993"><span class="hs-identifier hs-var">hash32</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Text Hash32 Hash32
</span><a href="#local-6989586621681053996"><span class="hs-identifier hs-var">entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>              </span><span class="annot"><span class="annottext">Transaction ()
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ())
-&gt; (IO () -&gt; Transaction ())
-&gt; IO ()
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ()
 -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ())
-&gt; IO ()
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621681053989"><span class="hs-identifier hs-var">counter</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-378"></span><span>              </span><span class="annot"><span class="annottext">Getting
  (Traversed
     () (StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction))
  (Entity Text Hash32 Hash32)
  Hash32
-&gt; (Hash32
    -&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ())
-&gt; Entity Text Hash32 Hash32
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
forall (f :: * -&gt; *) r s a.
Functor f =&gt;
Getting (Traversed r f) s a -&gt; (a -&gt; f r) -&gt; s -&gt; f ()
</span><span class="hs-identifier hs-var">traverseOf_</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Traversed
     () (StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction))
  (Entity Text Hash32 Hash32)
  Hash32
forall (m :: * -&gt; *) hash' hash text noSyncHash.
(Applicative m, Ord hash') =&gt;
(hash -&gt; m hash')
-&gt; Entity text noSyncHash hash -&gt; m (Entity text noSyncHash hash')
</span><span class="hs-identifier hs-var">Sync.entityHashes_</span></span><span> </span><span class="annot"><span class="annottext">Hash32
-&gt; StateT (Map Hash32 (Entity Text Hash32 Hash32)) Transaction ()
</span><a href="#local-6989586621681053992"><span class="hs-identifier hs-var">expandEntities</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Text Hash32 Hash32
</span><a href="#local-6989586621681053996"><span class="hs-identifier hs-var">entity</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="annot"><span class="hs-comment">-- | Gets the framed chunks from a NetString framed stream.</span></span><span>
</span><span id="line-381"></span><span class="annot"><a href="Unison.Share.SyncV2.html#_unNetString"><span class="hs-identifier hs-type">_unNetString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConduitT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span id="_unNetString"><span class="annot"><span class="annottext">_unNetString :: ConduitT ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ()
</span><a href="Unison.Share.SyncV2.html#_unNetString"><span class="hs-identifier hs-var hs-var">_unNetString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>  </span><span id="local-6989586621681054003"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054003"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Parser ByteString ByteString
-&gt; ConduitT
     ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ByteString
forall a (m :: * -&gt; *) b o.
(AttoparsecInput a, MonadThrow m) =&gt;
Parser a b -&gt; ConduitT a o m b
</span><span class="hs-identifier hs-var">C.sinkParser</span></span><span> </span><span class="annot"><span class="annottext">(Parser ByteString ByteString
 -&gt; ConduitT
      ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ByteString)
-&gt; Parser ByteString ByteString
-&gt; ConduitT
     ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>    </span><span id="local-6989586621681054005"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054005"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Parser Int
forall a. Integral a =&gt; Parser a
</span><span class="hs-identifier hs-var">A8.decimal</span></span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Parser Char
</span><span class="hs-identifier hs-var">A8.char</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">':'</span></span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621681054008"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054008"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Parser ByteString ByteString
</span><span class="hs-identifier hs-var">A.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054005"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Parser Char
</span><span class="hs-identifier hs-var">A8.char</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">','</span></span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054008"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="annot"><span class="annottext">ByteString
-&gt; ConduitT
     ByteString ByteString (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) o i. Monad m =&gt; o -&gt; ConduitT i o m ()
</span><span class="hs-identifier hs-var">C.yield</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054003"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span class="annot"><a href="Unison.Share.SyncV2.html#_decodeFramedEntity"><span class="hs-identifier hs-type">_decodeFramedEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesChunk</span></span><span>
</span><span id="line-392"></span><span id="_decodeFramedEntity"><span class="annot"><span class="annottext">_decodeFramedEntity :: ByteString -&gt; StreamM DownloadEntitiesChunk
</span><a href="Unison.Share.SyncV2.html#_decodeFramedEntity"><span class="hs-identifier hs-var hs-var">_decodeFramedEntity</span></a></span></span><span> </span><span id="local-6989586621681054012"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054012"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either DeserialiseFailure DownloadEntitiesChunk
forall a. Serialise a =&gt; ByteString -&gt; Either DeserialiseFailure a
</span><span class="hs-identifier hs-var">CBOR.deserialiseOrFail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BL.fromStrict</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054012"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-394"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681054015"><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054015"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; StreamM DownloadEntitiesChunk
forall a. SyncErr -&gt; ExceptT SyncErr (ResourceT IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; StreamM DownloadEntitiesChunk)
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; StreamM DownloadEntitiesChunk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; StreamM DownloadEntitiesChunk)
-&gt; SyncError -&gt; StreamM DownloadEntitiesChunk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorDeserializationFailure</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054015"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681054016"><span class="annot"><span class="annottext">DownloadEntitiesChunk
</span><a href="#local-6989586621681054016"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesChunk -&gt; StreamM DownloadEntitiesChunk
forall a. a -&gt; ExceptT SyncErr (ResourceT IO) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesChunk
</span><a href="#local-6989586621681054016"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-396"></span><span>
</span><span id="line-397"></span><span class="annot"><span class="hs-comment">-- | Unpacks a stream of tightly-packed CBOR entities without any framing/separators.</span></span><span>
</span><span id="line-398"></span><span class="annot"><a href="Unison.Share.SyncV2.html#decodeUnframedEntities"><span class="hs-identifier hs-type">decodeUnframedEntities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681052923"><span class="annot"><a href="#local-6989586621681052923"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBOR.Serialise</span></span><span> </span><span class="annot"><a href="#local-6989586621681052923"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><a href="#local-6989586621681052923"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-399"></span><span id="decodeUnframedEntities"><span class="annot"><span class="annottext">decodeUnframedEntities :: forall a. Serialise a =&gt; Stream ByteString a
</span><a href="Unison.Share.SyncV2.html#decodeUnframedEntities"><span class="hs-identifier hs-var hs-var">decodeUnframedEntities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall a.
 ExceptT SyncErr (ST RealWorld) a
 -&gt; ExceptT SyncErr (ResourceT IO) a)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) ()
-&gt; ConduitT ByteString a (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) (n :: * -&gt; *) i o r.
Monad m =&gt;
(forall a. m a -&gt; n a) -&gt; ConduitT i o m r -&gt; ConduitT i o n r
</span><span class="hs-identifier hs-var">C.transPipe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ST RealWorld (Either SyncErr a)
 -&gt; ResourceT IO (Either SyncErr a))
-&gt; ExceptT SyncErr (ST RealWorld) a
-&gt; ExceptT SyncErr (ResourceT IO) a
forall (m :: * -&gt; *) e a (n :: * -&gt; *) e' b.
(m (Either e a) -&gt; n (Either e' b))
-&gt; ExceptT e m a -&gt; ExceptT e' n b
</span><span class="hs-identifier hs-var">mapExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Either SyncErr a) -&gt; ResourceT IO (Either SyncErr a)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ResourceT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr a) -&gt; ResourceT IO (Either SyncErr a))
-&gt; (ST RealWorld (Either SyncErr a) -&gt; IO (Either SyncErr a))
-&gt; ST RealWorld (Either SyncErr a)
-&gt; ResourceT IO (Either SyncErr a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ST RealWorld (Either SyncErr a) -&gt; IO (Either SyncErr a)
forall a. ST RealWorld a -&gt; IO a
</span><span class="hs-identifier hs-var">stToIO</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) ()
 -&gt; ConduitT ByteString a (ExceptT SyncErr (ResourceT IO)) ())
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) ()
-&gt; ConduitT ByteString a (ExceptT SyncErr (ResourceT IO)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><span class="annottext">ConduitT
  ByteString a (ExceptT SyncErr (ST RealWorld)) (Maybe ByteString)
forall (m :: * -&gt; *) i o. Monad m =&gt; ConduitT i o m (Maybe i)
</span><span class="hs-identifier hs-var">C.await</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  ByteString a (ExceptT SyncErr (ST RealWorld)) (Maybe ByteString)
-&gt; (Maybe ByteString
    -&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) ())
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) ()
forall a b.
ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) a
-&gt; (a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) b)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-401"></span><span>    </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) ()
forall a.
a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681054029"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054029"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-403"></span><span>      </span><span id="local-6989586621681054030"><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST RealWorld (IDecode RealWorld a)
</span><a href="#local-6989586621681054030"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConduitT
  ByteString
  a
  (ExceptT SyncErr (ST RealWorld))
  (Maybe ByteString -&gt; ST RealWorld (IDecode RealWorld a))
forall s.
ConduitT
  ByteString
  a
  (ExceptT SyncErr (ST s))
  (Maybe ByteString -&gt; ST s (IDecode s a))
</span><a href="#local-6989586621681054031"><span class="hs-identifier hs-var">newDecoder</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><span class="annottext">ByteString
-&gt; (Maybe ByteString -&gt; ST RealWorld (IDecode RealWorld a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST RealWorld)) ()
forall s.
ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
</span><a href="#local-6989586621681054032"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054029"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST RealWorld (IDecode RealWorld a)
</span><a href="#local-6989586621681054030"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621681053185"><span class="annot"><a href="#local-6989586621681054031"><span class="hs-identifier hs-type">newDecoder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConduitT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><a href="#local-6989586621681052923"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-type">SyncErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621681053185"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621681053185"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBOR.IDecode</span></span><span> </span><span class="annot"><a href="#local-6989586621681053185"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052923"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621681054031"><span class="annot"><span class="annottext">newDecoder :: forall s.
ConduitT
  ByteString
  a
  (ExceptT SyncErr (ST s))
  (Maybe ByteString -&gt; ST s (IDecode s a))
</span><a href="#local-6989586621681054031"><span class="hs-identifier hs-var hs-var">newDecoder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-408"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT SyncErr (ST s) (IDecode s a)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ConduitT ByteString a m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ST s) (IDecode s a)
 -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a))
-&gt; (ST s (IDecode s a) -&gt; ExceptT SyncErr (ST s) (IDecode s a))
-&gt; ST s (IDecode s a)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ST s (IDecode s a) -&gt; ExceptT SyncErr (ST s) (IDecode s a)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT SyncErr m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ST s (IDecode s a)
forall a s. Serialise a =&gt; ST s (IDecode s a)
</span><span class="hs-identifier hs-var">CBOR.deserialiseIncremental</span></span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
-&gt; (IDecode s a
    -&gt; ConduitT
         ByteString
         a
         (ExceptT SyncErr (ST s))
         (Maybe ByteString -&gt; ST s (IDecode s a)))
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall a b.
ConduitT ByteString a (ExceptT SyncErr (ST s)) a
-&gt; (a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-409"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Done</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteOffset
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall a.
SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr
 -&gt; ConduitT
      ByteString
      a
      (ExceptT SyncErr (ST s))
      (Maybe ByteString -&gt; ST s (IDecode s a)))
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError
 -&gt; ConduitT
      ByteString
      a
      (ExceptT SyncErr (ST s))
      (Maybe ByteString -&gt; ST s (IDecode s a)))
-&gt; SyncError
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorStreamFailure</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Invalid initial decoder&quot;</span></span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Fail</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681054051"><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054051"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall a.
SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr
 -&gt; ConduitT
      ByteString
      a
      (ExceptT SyncErr (ST s))
      (Maybe ByteString -&gt; ST s (IDecode s a)))
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError
 -&gt; ConduitT
      ByteString
      a
      (ExceptT SyncErr (ST s))
      (Maybe ByteString -&gt; ST s (IDecode s a)))
-&gt; SyncError
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorDeserializationFailure</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054051"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-411"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Partial</span></span><span> </span><span id="local-6989586621681054053"><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054053"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT
     ByteString
     a
     (ExceptT SyncErr (ST s))
     (Maybe ByteString -&gt; ST s (IDecode s a))
forall a. a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054053"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-412"></span><span>    </span><span id="local-6989586621681053186"><span class="annot"><a href="#local-6989586621681054032"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621681053186"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBOR.IDecode</span></span><span> </span><span class="annot"><a href="#local-6989586621681053186"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052923"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConduitT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><a href="#local-6989586621681052923"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncErr"><span class="hs-identifier hs-type">SyncErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621681053186"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-413"></span><span>    </span><span id="local-6989586621681054032"><span class="annot"><span class="annottext">loop :: forall s.
ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
</span><a href="#local-6989586621681054032"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621681054080"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054080"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681054081"><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054081"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT SyncErr (ST s) (IDecode s a)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ConduitT ByteString a m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ST s) (IDecode s a)
 -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a))
-&gt; (ST s (IDecode s a) -&gt; ExceptT SyncErr (ST s) (IDecode s a))
-&gt; ST s (IDecode s a)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ST s (IDecode s a) -&gt; ExceptT SyncErr (ST s) (IDecode s a)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT SyncErr m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054081"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054080"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
-&gt; (IDecode s a
    -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a b.
ConduitT ByteString a (ExceptT SyncErr (ST s)) a
-&gt; (a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-415"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Fail</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681054082"><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054082"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a.
SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; SyncError -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorDeserializationFailure</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054082"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-416"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Partial</span></span><span> </span><span id="local-6989586621681054083"><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054083"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-417"></span><span>          </span><span class="hs-comment">-- We need more input, try to get some</span><span>
</span><span id="line-418"></span><span>          </span><span id="local-6989586621681054084"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621681054084"><span class="hs-identifier hs-var">nextBS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString a (ExceptT SyncErr (ST s)) (Maybe ByteString)
forall (m :: * -&gt; *) i o. Monad m =&gt; ConduitT i o m (Maybe i)
</span><span class="hs-identifier hs-var">C.await</span></span><span>
</span><span id="line-419"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621681054084"><span class="hs-identifier hs-var">nextBS</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-420"></span><span>            </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>              </span><span class="hs-comment">-- No more input, try to finish up the decoder.</span><span>
</span><span id="line-422"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT SyncErr (ST s) (IDecode s a)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ConduitT ByteString a m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ST s) (IDecode s a)
 -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a))
-&gt; (ST s (IDecode s a) -&gt; ExceptT SyncErr (ST s) (IDecode s a))
-&gt; ST s (IDecode s a)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ST s (IDecode s a) -&gt; ExceptT SyncErr (ST s) (IDecode s a)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT SyncErr m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054083"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString a (ExceptT SyncErr (ST s)) (IDecode s a)
-&gt; (IDecode s a
    -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a b.
ConduitT ByteString a (ExceptT SyncErr (ST s)) a
-&gt; (a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-423"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Done</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681054085"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681054085"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall (m :: * -&gt; *) o i. Monad m =&gt; o -&gt; ConduitT i o m ()
</span><span class="hs-identifier hs-var">C.yield</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681054085"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-424"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Fail</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681054086"><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054086"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a.
SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; SyncError -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorDeserializationFailure</span></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621681054086"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-425"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Partial</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a.
SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; SyncError -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorStreamFailure</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Unexpected end of input&quot;</span></span><span>
</span><span id="line-426"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681054087"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054087"><span class="hs-identifier hs-var">bs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-427"></span><span>              </span><span class="hs-comment">-- Have some input, keep going.</span><span>
</span><span id="line-428"></span><span>              </span><span class="annot"><span class="annottext">ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall s.
ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
</span><a href="#local-6989586621681054032"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054087"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054083"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-429"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Done</span></span><span> </span><span id="local-6989586621681054088"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054088"><span class="hs-identifier hs-var">rem</span></a></span></span><span> </span><span class="annot"><span class="annottext">ByteOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681054089"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681054089"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>          </span><span class="annot"><span class="annottext">a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall (m :: * -&gt; *) o i. Monad m =&gt; o -&gt; ConduitT i o m ()
</span><span class="hs-identifier hs-var">C.yield</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681054089"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-431"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054088"><span class="hs-identifier hs-var">rem</span></a></span><span>
</span><span id="line-432"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-433"></span><span>              </span><span class="hs-comment">-- If we had no leftovers, we can check if there's any input left.</span><span>
</span><span id="line-434"></span><span>              </span><span class="annot"><span class="annottext">ConduitT ByteString a (ExceptT SyncErr (ST s)) (Maybe ByteString)
forall (m :: * -&gt; *) i o. Monad m =&gt; ConduitT i o m (Maybe i)
</span><span class="hs-identifier hs-var">C.await</span></span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString a (ExceptT SyncErr (ST s)) (Maybe ByteString)
-&gt; (Maybe ByteString
    -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ())
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a b.
ConduitT ByteString a (ExceptT SyncErr (ST s)) a
-&gt; (a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b)
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-435"></span><span>                </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall a. a -&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681054091"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054091"><span class="hs-identifier hs-var">bs''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>                  </span><span class="hs-comment">-- If we have input left, start up a new decoder.</span><span>
</span><span id="line-438"></span><span>                  </span><span id="local-6989586621681054092"><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054092"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConduitT
  ByteString
  a
  (ExceptT SyncErr (ST s))
  (Maybe ByteString -&gt; ST s (IDecode s a))
forall s.
ConduitT
  ByteString
  a
  (ExceptT SyncErr (ST s))
  (Maybe ByteString -&gt; ST s (IDecode s a))
</span><a href="#local-6989586621681054031"><span class="hs-identifier hs-var">newDecoder</span></a></span><span>
</span><span id="line-439"></span><span>                  </span><span class="annot"><span class="annottext">ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall s.
ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
</span><a href="#local-6989586621681054032"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054091"><span class="hs-identifier hs-var">bs''</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054092"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-440"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-441"></span><span>              </span><span class="hs-comment">-- We have leftovers, start a new decoder and use those.</span><span>
</span><span id="line-442"></span><span>              </span><span id="local-6989586621681054093"><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054093"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConduitT
  ByteString
  a
  (ExceptT SyncErr (ST s))
  (Maybe ByteString -&gt; ST s (IDecode s a))
forall s.
ConduitT
  ByteString
  a
  (ExceptT SyncErr (ST s))
  (Maybe ByteString -&gt; ST s (IDecode s a))
</span><a href="#local-6989586621681054031"><span class="hs-identifier hs-var">newDecoder</span></a></span><span>
</span><span id="line-443"></span><span>              </span><span class="annot"><span class="annottext">ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
forall s.
ByteString
-&gt; (Maybe ByteString -&gt; ST s (IDecode s a))
-&gt; ConduitT ByteString a (ExceptT SyncErr (ST s)) ()
</span><a href="#local-6989586621681054032"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681054088"><span class="hs-identifier hs-var">rem</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; ST s (IDecode s a)
</span><a href="#local-6989586621681054093"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- Servant stuff</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-keyword">type</span><span> </span><span id="SyncAPI"><span class="annot"><a href="Unison.Share.SyncV2.html#SyncAPI"><span class="hs-identifier hs-var">SyncAPI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;ucm&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">Servant.:&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;v2&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">Servant.:&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;sync&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">Servant.:&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.API</span></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="annot"><a href="Unison.Share.SyncV2.html#syncAPI"><span class="hs-identifier hs-type">syncAPI</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncAPI"><span class="hs-identifier hs-type">SyncAPI</span></a></span><span>
</span><span id="line-451"></span><span id="syncAPI"><span class="annot"><span class="annottext">syncAPI :: Proxy SyncAPI
</span><a href="Unison.Share.SyncV2.html#syncAPI"><span class="hs-identifier hs-var hs-var">syncAPI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Unison.Share.SyncV2.html#SyncAPI"><span class="hs-identifier hs-type">SyncAPI</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="annot"><a href="Unison.Share.SyncV2.html#downloadEntitiesStreamClientM"><span class="hs-identifier hs-type">downloadEntitiesStreamClientM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesRequest</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Servant.ClientM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Servant.SourceT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBORStream</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesChunk</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span class="annot"><a href="Unison.Share.SyncV2.html#causalDependenciesStreamClientM"><span class="hs-identifier hs-type">causalDependenciesStreamClientM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.CausalDependenciesRequest</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Servant.ClientM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Servant.SourceT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBORStream</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.CausalDependenciesChunk</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span class="annot"><span class="hs-identifier hs-type">SyncV2.Routes</span></span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:downloadEntitiesStream:Routes :: forall mode.
Routes mode
-&gt; mode :- (&quot;entities&quot; :&gt; (&quot;download&quot; :&gt; DownloadEntitiesStream))
</span><span class="hs-identifier hs-var">downloadEntitiesStream</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="downloadEntitiesStreamClientM"><span class="annot"><span class="annottext">AsClientT ClientM
:- (&quot;entities&quot; :&gt; (&quot;download&quot; :&gt; DownloadEntitiesStream))
DownloadEntitiesRequest
-&gt; ClientM (SourceIO (CBORStream DownloadEntitiesChunk))
</span><a href="Unison.Share.SyncV2.html#downloadEntitiesStreamClientM"><span class="hs-identifier hs-var">downloadEntitiesStreamClientM</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-457"></span><span>    </span><span class="annot"><span class="annottext">$sel:causalDependenciesStream:Routes :: forall mode.
Routes mode
-&gt; mode
   :- (&quot;entities&quot; :&gt; (&quot;dependencies&quot; :&gt; CausalDependenciesStream))
</span><span class="hs-identifier hs-var">causalDependenciesStream</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="causalDependenciesStreamClientM"><span class="annot"><span class="annottext">AsClientT ClientM
:- (&quot;entities&quot; :&gt; (&quot;dependencies&quot; :&gt; CausalDependenciesStream))
CausalDependenciesRequest
-&gt; ClientM (SourceIO (CBORStream CausalDependenciesChunk))
</span><a href="Unison.Share.SyncV2.html#causalDependenciesStreamClientM"><span class="hs-identifier hs-var">causalDependenciesStreamClientM</span></a></span></span><span>
</span><span id="line-458"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy SyncAPI -&gt; Client ClientM SyncAPI
forall api.
HasClient ClientM api =&gt;
Proxy api -&gt; Client ClientM api
</span><span class="hs-identifier hs-var">Servant.client</span></span><span> </span><span class="annot"><span class="annottext">Proxy SyncAPI
</span><a href="Unison.Share.SyncV2.html#syncAPI"><span class="hs-identifier hs-var">syncAPI</span></a></span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">-- | Helper for running clientM that returns a stream of entities.</span><span>
</span><span id="line-461"></span><span class="hs-comment">-- You MUST consume the stream within the callback, it will be closed when the callback returns.</span><span>
</span><span id="line-462"></span><span class="annot"><a href="Unison.Share.SyncV2.html#withConduit"><span class="hs-identifier hs-type">withConduit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681053269"><span class="annot"><a href="#local-6989586621681053269"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621681053267"><span class="annot"><a href="#local-6989586621681053267"><span class="hs-identifier hs-type">chunk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBOR.Serialise</span></span><span> </span><span class="annot"><a href="#local-6989586621681053267"><span class="hs-identifier hs-type">chunk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Servant.ClientEnv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681053267"><span class="hs-identifier hs-type">chunk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053269"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Servant.ClientM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Servant.SourceIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBORStream</span></span><span> </span><span class="annot"><a href="#local-6989586621681053267"><span class="hs-identifier hs-type">chunk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053269"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-463"></span><span id="withConduit"><span class="annot"><span class="annottext">withConduit :: forall r chunk.
Serialise chunk =&gt;
ClientEnv
-&gt; (Stream () chunk -&gt; StreamM r)
-&gt; ClientM (SourceIO (CBORStream chunk))
-&gt; StreamM r
</span><a href="Unison.Share.SyncV2.html#withConduit"><span class="hs-identifier hs-var hs-var">withConduit</span></a></span></span><span> </span><span id="local-6989586621681054165"><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054165"><span class="hs-identifier hs-var">clientEnv</span></a></span></span><span> </span><span id="local-6989586621681054166"><span class="annot"><span class="annottext">Stream () chunk -&gt; StreamM r
</span><a href="#local-6989586621681054166"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621681054167"><span class="annot"><span class="annottext">ClientM (SourceIO (CBORStream chunk))
</span><a href="#local-6989586621681054167"><span class="hs-identifier hs-var">clientM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-464"></span><span>  </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr r) -&gt; StreamM r
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">ExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr r) -&gt; StreamM r)
-&gt; ResourceT IO (Either SyncErr r) -&gt; StreamM r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((forall a. ResourceT IO a -&gt; IO a) -&gt; IO (Either SyncErr r))
-&gt; ResourceT IO (Either SyncErr r)
forall b.
((forall a. ResourceT IO a -&gt; IO a) -&gt; IO b) -&gt; ResourceT IO b
forall (m :: * -&gt; *) b.
MonadUnliftIO m =&gt;
((forall a. m a -&gt; IO a) -&gt; IO b) -&gt; m b
</span><span class="hs-identifier hs-var">withRunInIO</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054169"><span class="annot"><span class="annottext">forall a. ResourceT IO a -&gt; IO a
</span><a href="#local-6989586621681054169"><span class="hs-identifier hs-var">runInIO</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-465"></span><span>    </span><span class="annot"><span class="annottext">ClientM (SourceIO (CBORStream chunk))
-&gt; ClientEnv
-&gt; (Either ClientError (SourceIO (CBORStream chunk))
    -&gt; IO (Either SyncErr r))
-&gt; IO (Either SyncErr r)
forall a b.
ClientM a -&gt; ClientEnv -&gt; (Either ClientError a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">Servant.withClientM</span></span><span> </span><span class="annot"><span class="annottext">ClientM (SourceIO (CBORStream chunk))
</span><a href="#local-6989586621681054167"><span class="hs-identifier hs-var">clientM</span></a></span><span> </span><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054165"><span class="hs-identifier hs-var">clientEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((Either ClientError (SourceIO (CBORStream chunk))
  -&gt; IO (Either SyncErr r))
 -&gt; IO (Either SyncErr r))
-&gt; (Either ClientError (SourceIO (CBORStream chunk))
    -&gt; IO (Either SyncErr r))
-&gt; IO (Either SyncErr r)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-466"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681054171"><span class="annot"><span class="annottext">ClientError
</span><a href="#local-6989586621681054171"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SyncErr r -&gt; IO (Either SyncErr r)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SyncErr r -&gt; IO (Either SyncErr r))
-&gt; (CodeserverTransportError -&gt; Either SyncErr r)
-&gt; CodeserverTransportError
-&gt; IO (Either SyncErr r)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; Either SyncErr r
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; Either SyncErr r)
-&gt; (CodeserverTransportError -&gt; SyncErr)
-&gt; CodeserverTransportError
-&gt; Either SyncErr r
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CodeserverTransportError -&gt; SyncErr
forall e. CodeserverTransportError -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#TransportError"><span class="hs-identifier hs-var">TransportError</span></a></span><span> </span><span class="annot"><span class="annottext">(CodeserverTransportError -&gt; IO (Either SyncErr r))
-&gt; CodeserverTransportError -&gt; IO (Either SyncErr r)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientEnv -&gt; ClientError -&gt; CodeserverTransportError
</span><a href="Unison.Share.SyncV2.html#handleClientError"><span class="hs-identifier hs-var">handleClientError</span></a></span><span> </span><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054165"><span class="hs-identifier hs-var">clientEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ClientError
</span><a href="#local-6989586621681054171"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681054174"><span class="annot"><span class="annottext">SourceIO (CBORStream chunk)
</span><a href="#local-6989586621681054174"><span class="hs-identifier hs-var">sourceT</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-468"></span><span>        </span><span id="local-6989586621681054175"><span class="annot"><span class="annottext">ConduitT () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ()
</span><a href="#local-6989586621681054175"><span class="hs-identifier hs-var">conduit</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  (ConduitT
     () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ())
-&gt; IO
     (ConduitT
        () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ())
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO
   (ConduitT
      () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ())
 -&gt; IO
      (ConduitT
         () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ()))
-&gt; IO
     (ConduitT
        () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ())
-&gt; IO
     (ConduitT
        () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceIO (CBORStream chunk)
-&gt; IO
     (ConduitT
        () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ())
forall chunk a. FromSourceIO chunk a =&gt; SourceIO chunk -&gt; IO a
</span><span class="hs-identifier hs-var">Servant.fromSourceIO</span></span><span> </span><span class="annot"><span class="annottext">SourceIO (CBORStream chunk)
</span><a href="#local-6989586621681054174"><span class="hs-identifier hs-var">sourceT</span></a></span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr r) -&gt; IO (Either SyncErr r)
forall a. ResourceT IO a -&gt; IO a
</span><a href="#local-6989586621681054169"><span class="hs-identifier hs-var">runInIO</span></a></span><span> </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr r) -&gt; IO (Either SyncErr r))
-&gt; (StreamM r -&gt; ResourceT IO (Either SyncErr r))
-&gt; StreamM r
-&gt; IO (Either SyncErr r)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StreamM r -&gt; ResourceT IO (Either SyncErr r)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(StreamM r -&gt; IO (Either SyncErr r))
-&gt; StreamM r -&gt; IO (Either SyncErr r)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream () chunk -&gt; StreamM r
</span><a href="#local-6989586621681054166"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConduitT () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ()
</span><a href="#local-6989586621681054175"><span class="hs-identifier hs-var">conduit</span></a></span><span> </span><span class="annot"><span class="annottext">ConduitT () (CBORStream chunk) (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT
     (CBORStream chunk) chunk (ExceptT SyncErr (ResourceT IO)) ()
-&gt; Stream () chunk
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  (CBORStream chunk) chunk (ExceptT SyncErr (ResourceT IO)) ()
forall a. Serialise a =&gt; Stream (CBORStream a) a
</span><a href="Unison.Share.SyncV2.html#unpackCBORBytesStream"><span class="hs-identifier hs-var">unpackCBORBytesStream</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span id="local-6989586621681053287"><span class="annot"><a href="Unison.Share.SyncV2.html#unpackCBORBytesStream"><span class="hs-identifier hs-type">unpackCBORBytesStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBOR.Serialise</span></span><span> </span><span class="annot"><a href="#local-6989586621681053287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CBORStream</span></span><span> </span><span class="annot"><a href="#local-6989586621681053287"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681053287"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-472"></span><span id="unpackCBORBytesStream"><span class="annot"><span class="annottext">unpackCBORBytesStream :: forall a. Serialise a =&gt; Stream (CBORStream a) a
</span><a href="Unison.Share.SyncV2.html#unpackCBORBytesStream"><span class="hs-identifier hs-var hs-var">unpackCBORBytesStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-473"></span><span>  </span><span class="annot"><span class="annottext">(CBORStream a -&gt; ByteString)
-&gt; ConduitT
     (CBORStream a) ByteString (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; ConduitT a b m ()
</span><span class="hs-identifier hs-var">C.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BL.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (CBORStream a -&gt; ByteString) -&gt; CBORStream a -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Coercible a b =&gt; a -&gt; b
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConduitT
  (CBORStream a) ByteString (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT ByteString a (ExceptT SyncErr (ResourceT IO)) ()
-&gt; ConduitT (CBORStream a) a (ExceptT SyncErr (ResourceT IO)) ()
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT ByteString a (ExceptT SyncErr (ResourceT IO)) ()
forall a. Serialise a =&gt; Stream ByteString a
</span><a href="Unison.Share.SyncV2.html#decodeUnframedEntities"><span class="hs-identifier hs-var">decodeUnframedEntities</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="annot"><a href="Unison.Share.SyncV2.html#handleClientError"><span class="hs-identifier hs-type">handleClientError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Servant.ClientEnv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Servant.ClientError</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.Sync.Types.html#CodeserverTransportError"><span class="hs-identifier hs-type">CodeserverTransportError</span></a></span><span>
</span><span id="line-476"></span><span id="handleClientError"><span class="annot"><span class="annottext">handleClientError :: ClientEnv -&gt; ClientError -&gt; CodeserverTransportError
</span><a href="Unison.Share.SyncV2.html#handleClientError"><span class="hs-identifier hs-var hs-var">handleClientError</span></a></span></span><span> </span><span id="local-6989586621681054183"><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054183"><span class="hs-identifier hs-var">clientEnv</span></a></span></span><span> </span><span id="local-6989586621681054184"><span class="annot"><span class="annottext">ClientError
</span><a href="#local-6989586621681054184"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClientError
</span><a href="#local-6989586621681054184"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-478"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Servant.FailureResponse</span></span><span> </span><span id="local-6989586621681054186"><span class="annot"><span class="annottext">RequestF () (BaseUrl, ByteString)
</span><a href="#local-6989586621681054186"><span class="hs-identifier hs-var">_req</span></a></span></span><span> </span><span id="local-6989586621681054187"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054187"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-479"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Status -&gt; Int
</span><span class="hs-identifier hs-var">HTTP.statusCode</span></span><span> </span><span class="annot"><span class="annottext">(Status -&gt; Int) -&gt; Status -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Response -&gt; Status
forall a. ResponseF a -&gt; Status
</span><span class="hs-identifier hs-var">Servant.responseStatusCode</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054187"><span class="hs-identifier hs-var">resp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">401</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BaseUrl -&gt; CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#Unauthenticated"><span class="hs-identifier hs-var">Unauthenticated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientEnv -&gt; BaseUrl
</span><span class="hs-identifier hs-var">Servant.baseUrl</span></span><span> </span><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054183"><span class="hs-identifier hs-var">clientEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>        </span><span class="hs-comment">-- The server should provide semantically relevant permission-denied messages</span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-comment">-- when possible, but this should catch any we miss.</span><span>
</span><span id="line-483"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">403</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#PermissionDenied"><span class="hs-identifier hs-var">PermissionDenied</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">Text.Lazy.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (ByteString -&gt; Text) -&gt; ByteString -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">Text.Lazy.decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Text) -&gt; ByteString -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Response -&gt; ByteString
forall a. ResponseF a -&gt; a
</span><span class="hs-identifier hs-var">Servant.responseBody</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054187"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">408</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#Timeout"><span class="hs-identifier hs-var">Timeout</span></a></span><span>
</span><span id="line-485"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">429</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#RateLimitExceeded"><span class="hs-identifier hs-var">RateLimitExceeded</span></a></span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">504</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#Timeout"><span class="hs-identifier hs-var">Timeout</span></a></span><span>
</span><span id="line-487"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Response -&gt; CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#UnexpectedResponse"><span class="hs-identifier hs-var">UnexpectedResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054187"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Servant.DecodeFailure</span></span><span> </span><span id="local-6989586621681054200"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621681054200"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621681054201"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054201"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Response -&gt; CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#DecodeFailure"><span class="hs-identifier hs-var">DecodeFailure</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621681054200"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054201"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Servant.UnsupportedContentType</span></span><span> </span><span id="local-6989586621681054204"><span class="annot"><span class="annottext">MediaType
</span><a href="#local-6989586621681054204"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span id="local-6989586621681054205"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054205"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Response -&gt; CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#UnexpectedResponse"><span class="hs-identifier hs-var">UnexpectedResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054205"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-490"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Servant.InvalidContentTypeHeader</span></span><span> </span><span id="local-6989586621681054207"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054207"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Response -&gt; CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#UnexpectedResponse"><span class="hs-identifier hs-var">UnexpectedResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681054207"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-491"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Servant.ConnectionError</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BaseUrl -&gt; CodeserverTransportError
</span><a href="Unison.Share.Sync.Types.html#UnreachableCodeserver"><span class="hs-identifier hs-var">UnreachableCodeserver</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientEnv -&gt; BaseUrl
</span><span class="hs-identifier hs-var">Servant.baseUrl</span></span><span> </span><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054183"><span class="hs-identifier hs-var">clientEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="annot"><span class="hs-comment">-- | Stream entities from the codeserver.</span></span><span>
</span><span id="line-494"></span><span class="annot"><a href="Unison.Share.SyncV2.html#httpStreamEntities"><span class="hs-identifier hs-type">httpStreamEntities</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-495"></span><span>  </span><span class="annot"><a href="Unison.Auth.HTTPClient.html#AuthenticatedHttpClient"><span class="hs-identifier hs-type">Auth.AuthenticatedHttpClient</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-496"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Servant.BaseUrl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-497"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesRequest</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SyncV2.StreamInitInfo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-499"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span id="httpStreamEntities"><span class="annot"><span class="annottext">httpStreamEntities :: AuthenticatedHttpClient
-&gt; BaseUrl
-&gt; DownloadEntitiesRequest
-&gt; (StreamInitInfo
    -&gt; Stream () EntityChunk -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="Unison.Share.SyncV2.html#httpStreamEntities"><span class="hs-identifier hs-var hs-var">httpStreamEntities</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Auth.HTTPClient.html#AuthenticatedHttpClient"><span class="hs-identifier hs-type">Auth.AuthenticatedHttpClient</span></a></span><span> </span><span id="local-6989586621681054211"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621681054211"><span class="hs-identifier hs-var">httpClient</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681054212"><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054212"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span></span><span> </span><span id="local-6989586621681054213"><span class="annot"><span class="annottext">DownloadEntitiesRequest
</span><a href="#local-6989586621681054213"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621681054214"><span class="annot"><span class="annottext">StreamInitInfo
-&gt; Stream () EntityChunk -&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="#local-6989586621681054214"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681054215"><span class="annot"><span class="annottext">clientEnv :: ClientEnv
</span><a href="#local-6989586621681054215"><span class="hs-identifier hs-var hs-var">clientEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Manager -&gt; BaseUrl -&gt; ClientEnv
</span><span class="hs-identifier hs-var">Servant.mkClientEnv</span></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621681054211"><span class="hs-identifier hs-var">httpClient</span></a></span><span> </span><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054212"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">Servant.makeClientRequest</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054218"><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054218"><span class="hs-identifier hs-var">url</span></a></span></span><span> </span><span id="local-6989586621681054219"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054219"><span class="hs-identifier hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-504"></span><span>              </span><span class="hs-comment">-- Disable client-side timeouts</span><span>
</span><span id="line-505"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BaseUrl -&gt; Request -&gt; IO Request
</span><span class="hs-identifier hs-var">Servant.defaultMakeClientRequest</span></span><span> </span><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054218"><span class="hs-identifier hs-var">url</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054219"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>                </span><span class="annot"><span class="annottext">IO Request -&gt; (Request -&gt; Request) -&gt; IO Request
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054221"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054221"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-507"></span><span>                  </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054221"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-508"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">Http.Client.responseTimeout</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Http.Client.responseTimeoutNone</span></span><span>
</span><span id="line-509"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-510"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DownloadEntitiesRequest
-&gt; ClientM (SourceIO (CBORStream DownloadEntitiesChunk))
</span><a href="Unison.Share.SyncV2.html#downloadEntitiesStreamClientM"><span class="hs-identifier hs-var">downloadEntitiesStreamClientM</span></a></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesRequest
</span><a href="#local-6989586621681054213"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ClientM (SourceIO (CBORStream DownloadEntitiesChunk))
-&gt; (ClientM (SourceIO (CBORStream DownloadEntitiesChunk))
    -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">ClientEnv
-&gt; (Stream () DownloadEntitiesChunk
    -&gt; ExceptT SyncErr (ResourceT IO) ())
-&gt; ClientM (SourceIO (CBORStream DownloadEntitiesChunk))
-&gt; ExceptT SyncErr (ResourceT IO) ()
forall r chunk.
Serialise chunk =&gt;
ClientEnv
-&gt; (Stream () chunk -&gt; StreamM r)
-&gt; ClientM (SourceIO (CBORStream chunk))
-&gt; StreamM r
</span><a href="Unison.Share.SyncV2.html#withConduit"><span class="hs-identifier hs-var">withConduit</span></a></span><span> </span><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054215"><span class="hs-identifier hs-var">clientEnv</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054224"><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681054224"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681054225"><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681054225"><span class="hs-identifier hs-var">init</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681054226"><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681054226"><span class="hs-identifier hs-var">entityStream</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
</span><a href="Unison.Share.SyncV2.html#initializeStream"><span class="hs-identifier hs-var">initializeStream</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681054224"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-513"></span><span>    </span><span class="annot"><span class="annottext">StreamInitInfo
-&gt; Stream () EntityChunk -&gt; ExceptT SyncErr (ResourceT IO) ()
</span><a href="#local-6989586621681054214"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681054225"><span class="hs-identifier hs-var">init</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681054226"><span class="hs-identifier hs-var">entityStream</span></a></span><span>
</span><span id="line-514"></span><span>
</span><span id="line-515"></span><span class="annot"><span class="hs-comment">-- | Peel the header off the stream and parse the remaining entity chunks into EntityChunks</span></span><span>
</span><span id="line-516"></span><span class="annot"><a href="Unison.Share.SyncV2.html#initializeStream"><span class="hs-identifier hs-type">initializeStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SyncV2.StreamInitInfo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span id="initializeStream"><span class="annot"><span class="annottext">initializeStream :: Stream () DownloadEntitiesChunk
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
</span><a href="Unison.Share.SyncV2.html#initializeStream"><span class="hs-identifier hs-var hs-var">initializeStream</span></a></span></span><span> </span><span id="local-6989586621681054227"><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681054227"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681054228"><span class="annot"><span class="annottext">SealedConduitT
  () DownloadEntitiesChunk (ExceptT SyncErr (ResourceT IO)) ()
</span><a href="#local-6989586621681054228"><span class="hs-identifier hs-var">streamRemainder</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681054229"><span class="annot"><span class="annottext">Maybe DownloadEntitiesChunk
</span><a href="#local-6989586621681054229"><span class="hs-identifier hs-var">init</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
</span><a href="#local-6989586621681054227"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
-&gt; ConduitT
     DownloadEntitiesChunk
     Void
     (ExceptT SyncErr (ResourceT IO))
     (Maybe DownloadEntitiesChunk)
-&gt; ExceptT
     SyncErr
     (ResourceT IO)
     (SealedConduitT
        () DownloadEntitiesChunk (ExceptT SyncErr (ResourceT IO)) (),
      Maybe DownloadEntitiesChunk)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
ConduitT () a m ()
-&gt; ConduitT a Void m b -&gt; m (SealedConduitT () a m (), b)
</span><span class="hs-operator hs-var">C.$$+</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  DownloadEntitiesChunk
  Void
  (ExceptT SyncErr (ResourceT IO))
  (Maybe DownloadEntitiesChunk)
forall (m :: * -&gt; *) i o. Monad m =&gt; ConduitT i o m (Maybe i)
</span><span class="hs-identifier hs-var">C.headC</span></span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DownloadEntitiesChunk
</span><a href="#local-6989586621681054229"><span class="hs-identifier hs-var">init</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><span class="annottext">Maybe DownloadEntitiesChunk
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a. SyncErr -&gt; ExceptT SyncErr (ResourceT IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; StreamM (StreamInitInfo, Stream () EntityChunk))
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; StreamM (StreamInitInfo, Stream () EntityChunk))
-&gt; SyncError -&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorMissingInitialChunk</span></span><span>
</span><span id="line-521"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681054233"><span class="annot"><span class="annottext">DownloadEntitiesChunk
</span><a href="#local-6989586621681054233"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-522"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesChunk
</span><a href="#local-6989586621681054233"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-523"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.InitialC</span></span><span> </span><span id="local-6989586621681054234"><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681054234"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-524"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681054235"><span class="annot"><span class="annottext">entityStream :: Stream () EntityChunk
</span><a href="#local-6989586621681054235"><span class="hs-identifier hs-var hs-var">entityStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SealedConduitT
  () DownloadEntitiesChunk (ExceptT SyncErr (ResourceT IO)) ()
-&gt; Stream () DownloadEntitiesChunk
forall (m :: * -&gt; *) i o r.
Monad m =&gt;
SealedConduitT i o m r -&gt; ConduitT i o m r
</span><span class="hs-identifier hs-var">C.unsealConduitT</span></span><span> </span><span class="annot"><span class="annottext">SealedConduitT
  () DownloadEntitiesChunk (ExceptT SyncErr (ResourceT IO)) ()
</span><a href="#local-6989586621681054228"><span class="hs-identifier hs-var">streamRemainder</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () DownloadEntitiesChunk
-&gt; ConduitT
     DownloadEntitiesChunk
     EntityChunk
     (ExceptT SyncErr (ResourceT IO))
     ()
-&gt; Stream () EntityChunk
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">(DownloadEntitiesChunk
 -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk)
-&gt; ConduitT
     DownloadEntitiesChunk
     EntityChunk
     (ExceptT SyncErr (ResourceT IO))
     ()
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; ConduitT a b m ()
</span><span class="hs-identifier hs-var">C.mapM</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesChunk -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
</span><a href="#local-6989586621681054237"><span class="hs-identifier hs-var">parseEntity</span></a></span><span>
</span><span id="line-525"></span><span>          </span><span class="annot"><span class="annottext">(StreamInitInfo, Stream () EntityChunk)
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a. a -&gt; ExceptT SyncErr (ResourceT IO) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">((StreamInitInfo, Stream () EntityChunk)
 -&gt; StreamM (StreamInitInfo, Stream () EntityChunk))
-&gt; (StreamInitInfo, Stream () EntityChunk)
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamInitInfo
</span><a href="#local-6989586621681054234"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream () EntityChunk
</span><a href="#local-6989586621681054235"><span class="hs-identifier hs-var">entityStream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityC</span></span><span> </span><span class="annot"><span class="annottext">EntityChunk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>          </span><span class="annot"><span class="annottext">SyncErr -&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a. SyncErr -&gt; ExceptT SyncErr (ResourceT IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; StreamM (StreamInitInfo, Stream () EntityChunk))
-&gt; (SyncError -&gt; SyncErr)
-&gt; SyncError
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (SyncError -&gt; PullError) -&gt; SyncError -&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">(SyncError -&gt; StreamM (StreamInitInfo, Stream () EntityChunk))
-&gt; SyncError -&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorMissingInitialChunk</span></span><span>
</span><span id="line-528"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.ErrorC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SyncV2.ErrorChunk</span></span><span> </span><span id="local-6989586621681054240"><span class="annot"><span class="annottext">DownloadEntitiesError
</span><a href="#local-6989586621681054240"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a. SyncErr -&gt; ExceptT SyncErr (ResourceT IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; StreamM (StreamInitInfo, Stream () EntityChunk))
-&gt; (DownloadEntitiesError -&gt; SyncErr)
-&gt; DownloadEntitiesError
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; SyncErr)
-&gt; (DownloadEntitiesError -&gt; PullError)
-&gt; DownloadEntitiesError
-&gt; SyncErr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'DownloadEntities</span></span><span> </span><span class="annot"><span class="annottext">(DownloadEntitiesError
 -&gt; StreamM (StreamInitInfo, Stream () EntityChunk))
-&gt; DownloadEntitiesError
-&gt; StreamM (StreamInitInfo, Stream () EntityChunk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesError
</span><a href="#local-6989586621681054240"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-530"></span><span>    </span><span class="annot"><a href="#local-6989586621681054237"><span class="hs-identifier hs-type">parseEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.DownloadEntitiesChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityChunk</span></span><span>
</span><span id="line-531"></span><span>    </span><span id="local-6989586621681054237"><span class="annot"><span class="annottext">parseEntity :: DownloadEntitiesChunk -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
</span><a href="#local-6989586621681054237"><span class="hs-identifier hs-var hs-var">parseEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-532"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.EntityC</span></span><span> </span><span id="local-6989586621681054241"><span class="annot"><span class="annottext">EntityChunk
</span><a href="#local-6989586621681054241"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityChunk -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
forall a. a -&gt; ExceptT SyncErr (ResourceT IO) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EntityChunk
</span><a href="#local-6989586621681054241"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-533"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.ErrorC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SyncV2.ErrorChunk</span></span><span> </span><span id="local-6989586621681054242"><span class="annot"><span class="annottext">DownloadEntitiesError
</span><a href="#local-6989586621681054242"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
forall a. SyncErr -&gt; ExceptT SyncErr (ResourceT IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk)
-&gt; (PullError -&gt; SyncErr)
-&gt; PullError
-&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk)
-&gt; PullError -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'DownloadEntities</span></span><span> </span><span class="annot"><span class="annottext">DownloadEntitiesError
</span><a href="#local-6989586621681054242"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-534"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.InitialC</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyncErr -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
forall a. SyncErr -&gt; ExceptT SyncErr (ResourceT IO) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(SyncErr -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk)
-&gt; (PullError -&gt; SyncErr)
-&gt; PullError
-&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PullError -&gt; SyncErr
forall e. e -&gt; SyncError e
</span><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-var">SyncError</span></a></span><span> </span><span class="annot"><span class="annottext">(PullError -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk)
-&gt; PullError -&gt; ExceptT SyncErr (ResourceT IO) EntityChunk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SyncError -&gt; PullError
</span><span class="hs-identifier hs-var">SyncV2.PullError'Sync</span></span><span> </span><span class="annot"><span class="annottext">SyncError
</span><span class="hs-identifier hs-var">SyncV2.SyncErrorMisplacedInitialChunk</span></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-537"></span><span class="hs-comment">-- Causal Dependency negotiation</span><span>
</span><span id="line-538"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span class="annot"><a href="Unison.Share.SyncV2.html#httpStreamCausalDependencies"><span class="hs-identifier hs-type">httpStreamCausalDependencies</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681053311"><span class="annot"><a href="#local-6989586621681053311"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><a href="Unison.Auth.HTTPClient.html#AuthenticatedHttpClient"><span class="hs-identifier hs-type">Auth.AuthenticatedHttpClient</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Servant.BaseUrl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-544"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.CausalDependenciesRequest</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.CausalDependenciesChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053311"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-546"></span><span>  </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053311"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-547"></span><span id="httpStreamCausalDependencies"><span class="annot"><span class="annottext">httpStreamCausalDependencies :: forall r.
AuthenticatedHttpClient
-&gt; BaseUrl
-&gt; CausalDependenciesRequest
-&gt; (Stream () CausalDependenciesChunk -&gt; StreamM r)
-&gt; StreamM r
</span><a href="Unison.Share.SyncV2.html#httpStreamCausalDependencies"><span class="hs-identifier hs-var hs-var">httpStreamCausalDependencies</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Auth.HTTPClient.html#AuthenticatedHttpClient"><span class="hs-identifier hs-type">Auth.AuthenticatedHttpClient</span></a></span><span> </span><span id="local-6989586621681054248"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621681054248"><span class="hs-identifier hs-var">httpClient</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681054249"><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054249"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span></span><span> </span><span id="local-6989586621681054250"><span class="annot"><span class="annottext">CausalDependenciesRequest
</span><a href="#local-6989586621681054250"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621681054251"><span class="annot"><span class="annottext">Stream () CausalDependenciesChunk -&gt; StreamM r
</span><a href="#local-6989586621681054251"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681054252"><span class="annot"><span class="annottext">clientEnv :: ClientEnv
</span><a href="#local-6989586621681054252"><span class="hs-identifier hs-var hs-var">clientEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-549"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Manager -&gt; BaseUrl -&gt; ClientEnv
</span><span class="hs-identifier hs-var">Servant.mkClientEnv</span></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621681054248"><span class="hs-identifier hs-var">httpClient</span></a></span><span> </span><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054249"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">Servant.makeClientRequest</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054253"><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054253"><span class="hs-identifier hs-var">url</span></a></span></span><span> </span><span id="local-6989586621681054254"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054254"><span class="hs-identifier hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-551"></span><span>              </span><span class="hs-comment">-- Disable client-side timeouts</span><span>
</span><span id="line-552"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BaseUrl -&gt; Request -&gt; IO Request
</span><span class="hs-identifier hs-var">Servant.defaultMakeClientRequest</span></span><span> </span><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054253"><span class="hs-identifier hs-var">url</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054254"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>                </span><span class="annot"><span class="annottext">IO Request -&gt; (Request -&gt; Request) -&gt; IO Request
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054255"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054255"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-554"></span><span>                  </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681054255"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-555"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">Http.Client.responseTimeout</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Http.Client.responseTimeoutNone</span></span><span>
</span><span id="line-556"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-557"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalDependenciesRequest
-&gt; ClientM (SourceIO (CBORStream CausalDependenciesChunk))
</span><a href="Unison.Share.SyncV2.html#causalDependenciesStreamClientM"><span class="hs-identifier hs-var">causalDependenciesStreamClientM</span></a></span><span> </span><span class="annot"><span class="annottext">CausalDependenciesRequest
</span><a href="#local-6989586621681054250"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ClientM (SourceIO (CBORStream CausalDependenciesChunk))
-&gt; (ClientM (SourceIO (CBORStream CausalDependenciesChunk))
    -&gt; StreamM r)
-&gt; StreamM r
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">ClientEnv
-&gt; (Stream () CausalDependenciesChunk -&gt; StreamM r)
-&gt; ClientM (SourceIO (CBORStream CausalDependenciesChunk))
-&gt; StreamM r
forall r chunk.
Serialise chunk =&gt;
ClientEnv
-&gt; (Stream () chunk -&gt; StreamM r)
-&gt; ClientM (SourceIO (CBORStream chunk))
-&gt; StreamM r
</span><a href="Unison.Share.SyncV2.html#withConduit"><span class="hs-identifier hs-var">withConduit</span></a></span><span> </span><span class="annot"><span class="annottext">ClientEnv
</span><a href="#local-6989586621681054252"><span class="hs-identifier hs-var">clientEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () CausalDependenciesChunk -&gt; StreamM r
</span><a href="#local-6989586621681054251"><span class="hs-identifier hs-var">callback</span></a></span><span>
</span><span id="line-559"></span><span>
</span><span id="line-560"></span><span class="hs-comment">-- | Ask Share for the dependencies of a given hash jwt,</span><span>
</span><span id="line-561"></span><span class="hs-comment">-- then filter them to get the set of causals which we have and don't need sent.</span><span>
</span><span id="line-562"></span><span class="annot"><a href="Unison.Share.SyncV2.html#negotiateKnownCausals"><span class="hs-identifier hs-type">negotiateKnownCausals</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The Unison Share URL.</span></span><span>
</span><span id="line-564"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Servant.BaseUrl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-565"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The branch to download from.</span></span><span>
</span><span id="line-566"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.BranchRef</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-567"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The hash to download.</span></span><span>
</span><span id="line-568"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Share.HashJWT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-569"></span><span>  </span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier hs-type">Cli</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Share.Sync.Types.html#SyncError"><span class="hs-identifier hs-type">SyncError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.PullError</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span id="negotiateKnownCausals"><span class="annot"><span class="annottext">negotiateKnownCausals :: BaseUrl
-&gt; BranchRef -&gt; HashJWT -&gt; Cli (Either SyncErr (Set Hash32))
</span><a href="Unison.Share.SyncV2.html#negotiateKnownCausals"><span class="hs-identifier hs-var hs-var">negotiateKnownCausals</span></a></span></span><span> </span><span id="local-6989586621681054256"><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054256"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span></span><span> </span><span id="local-6989586621681054257"><span class="annot"><span class="annottext">BranchRef
</span><a href="#local-6989586621681054257"><span class="hs-identifier hs-var">branchRef</span></a></span></span><span> </span><span id="local-6989586621681054258"><span class="annot"><span class="annottext">HashJWT
</span><a href="#local-6989586621681054258"><span class="hs-identifier hs-var">hashJwt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
-&gt; Cli (Either SyncErr (Set Hash32))
-&gt; Cli (Either SyncErr (Set Hash32))
forall (m :: * -&gt; *) a. MonadIO m =&gt; FilePath -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Timing.time</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Causal Negotiation&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Cli (Either SyncErr (Set Hash32))
 -&gt; Cli (Either SyncErr (Set Hash32)))
-&gt; Cli (Either SyncErr (Set Hash32))
-&gt; Cli (Either SyncErr (Set Hash32))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><a href="Unison.Cli.Monad.html#Env"><span class="hs-identifier hs-type">Cli.Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621681054259"><span class="annot"><span class="annottext">AuthenticatedHttpClient
$sel:authHTTPClient:Env :: Env -&gt; AuthenticatedHttpClient
authHTTPClient :: AuthenticatedHttpClient
</span><a href="Unison.Cli.Monad.html#%24sel%3AauthHTTPClient%3AEnv"><span class="hs-identifier hs-var hs-var">authHTTPClient</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681054260"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
$sel:codebase:Env :: Env -&gt; Codebase IO Symbol Ann
codebase :: Codebase IO Symbol Ann
</span><a href="Unison.Cli.Monad.html#%24sel%3Acodebase%3AEnv"><span class="hs-identifier hs-var hs-var">codebase</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-572"></span><span>  </span><span class="annot"><span class="annottext">IO (Either SyncErr (Set Hash32))
-&gt; Cli (Either SyncErr (Set Hash32))
forall a. IO a -&gt; Cli a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SyncErr (Set Hash32))
 -&gt; Cli (Either SyncErr (Set Hash32)))
-&gt; IO (Either SyncErr (Set Hash32))
-&gt; Cli (Either SyncErr (Set Hash32))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either SyncErr (Set Hash32))
-&gt; IO (Either SyncErr (Set Hash32))
forall (m :: * -&gt; *) a. (MonadIO m, MonadMask m) =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Console.Regions.displayConsoleRegions</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-573"></span><span>    </span><span class="annot"><span class="annottext">RegionLayout
-&gt; (ConsoleRegion -&gt; IO (Either SyncErr (Set Hash32)))
-&gt; IO (Either SyncErr (Set Hash32))
forall (m :: * -&gt; *) a.
(MonadIO m, MonadMask m) =&gt;
RegionLayout -&gt; (ConsoleRegion -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">Console.Regions.withConsoleRegion</span></span><span> </span><span class="annot"><span class="annottext">RegionLayout
</span><span class="hs-identifier hs-var">Console.Regions.Linear</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054264"><span class="annot"><span class="annottext">ConsoleRegion
</span><a href="#local-6989586621681054264"><span class="hs-identifier hs-var">region</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-574"></span><span>      </span><span class="annot"><span class="annottext">forall v (m :: * -&gt; *).
(ToRegionContent v, LiftRegion m) =&gt;
ConsoleRegion -&gt; v -&gt; m ()
</span><span class="hs-identifier hs-var">Console.Regions.setConsoleRegion</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="annottext">ConsoleRegion
</span><a href="#local-6989586621681054264"><span class="hs-identifier hs-var">region</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; Text -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;  &#128270; Identifying missing entities...&quot;</span></span><span>
</span><span id="line-575"></span><span>      </span><span class="annot"><span class="annottext">ResourceT IO (Either SyncErr (Set Hash32))
-&gt; IO (Either SyncErr (Set Hash32))
forall (m :: * -&gt; *) a. MonadUnliftIO m =&gt; ResourceT m a -&gt; m a
</span><span class="hs-identifier hs-var">C.runResourceT</span></span><span>
</span><span id="line-576"></span><span>        </span><span class="annot"><span class="annottext">(ResourceT IO (Either SyncErr (Set Hash32))
 -&gt; IO (Either SyncErr (Set Hash32)))
-&gt; (ExceptT SyncErr (ResourceT IO) (Set Hash32)
    -&gt; ResourceT IO (Either SyncErr (Set Hash32)))
-&gt; ExceptT SyncErr (ResourceT IO) (Set Hash32)
-&gt; IO (Either SyncErr (Set Hash32))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT SyncErr (ResourceT IO) (Set Hash32)
-&gt; ResourceT IO (Either SyncErr (Set Hash32))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span>
</span><span id="line-577"></span><span>        </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ResourceT IO) (Set Hash32)
 -&gt; IO (Either SyncErr (Set Hash32)))
-&gt; ExceptT SyncErr (ResourceT IO) (Set Hash32)
-&gt; IO (Either SyncErr (Set Hash32))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AuthenticatedHttpClient
-&gt; BaseUrl
-&gt; CausalDependenciesRequest
-&gt; (Stream () CausalDependenciesChunk
    -&gt; ExceptT SyncErr (ResourceT IO) (Set Hash32))
-&gt; ExceptT SyncErr (ResourceT IO) (Set Hash32)
forall r.
AuthenticatedHttpClient
-&gt; BaseUrl
-&gt; CausalDependenciesRequest
-&gt; (Stream () CausalDependenciesChunk -&gt; StreamM r)
-&gt; StreamM r
</span><a href="Unison.Share.SyncV2.html#httpStreamCausalDependencies"><span class="hs-identifier hs-var">httpStreamCausalDependencies</span></a></span><span>
</span><span id="line-578"></span><span>          </span><span class="annot"><span class="annottext">AuthenticatedHttpClient
</span><a href="#local-6989586621681054259"><span class="hs-identifier hs-var">authHTTPClient</span></a></span><span>
</span><span id="line-579"></span><span>          </span><span class="annot"><span class="annottext">BaseUrl
</span><a href="#local-6989586621681054256"><span class="hs-identifier hs-var">unisonShareUrl</span></a></span><span>
</span><span id="line-580"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.CausalDependenciesRequest</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">BranchRef
branchRef :: BranchRef
$sel:branchRef:CausalDependenciesRequest :: BranchRef
</span><a href="#local-6989586621681054257"><span class="hs-identifier hs-var hs-var">branchRef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:rootCausal:CausalDependenciesRequest :: HashJWT
</span><span class="hs-identifier hs-var">rootCausal</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashJWT
</span><a href="#local-6989586621681054258"><span class="hs-identifier hs-var">hashJwt</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-581"></span><span>          </span><span class="hs-glyph">\</span><span id="local-6989586621681054269"><span class="annot"><span class="annottext">Stream () CausalDependenciesChunk
</span><a href="#local-6989586621681054269"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>            </span><span class="annot"><span class="annottext">[Hash32] -&gt; Set Hash32
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Hash32] -&gt; Set Hash32)
-&gt; ExceptT SyncErr (ResourceT IO) [Hash32]
-&gt; ExceptT SyncErr (ResourceT IO) (Set Hash32)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ConduitT () Void (ExceptT SyncErr (ResourceT IO)) [Hash32]
-&gt; ExceptT SyncErr (ResourceT IO) [Hash32]
forall (m :: * -&gt; *) r. Monad m =&gt; ConduitT () Void m r -&gt; m r
</span><span class="hs-identifier hs-var">C.runConduit</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream () CausalDependenciesChunk
</span><a href="#local-6989586621681054269"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">Stream () CausalDependenciesChunk
-&gt; ConduitT
     CausalDependenciesChunk
     Void
     (ExceptT SyncErr (ResourceT IO))
     [Hash32]
-&gt; ConduitT () Void (ExceptT SyncErr (ResourceT IO)) [Hash32]
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">(CausalDependenciesChunk -&gt; (Hash32, DependencyType))
-&gt; ConduitT
     CausalDependenciesChunk
     (Hash32, DependencyType)
     (ExceptT SyncErr (ResourceT IO))
     ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; ConduitT a b m ()
</span><span class="hs-identifier hs-var">C.map</span></span><span> </span><span class="annot"><span class="annottext">CausalDependenciesChunk -&gt; (Hash32, DependencyType)
</span><a href="#local-6989586621681054271"><span class="hs-identifier hs-var">unpack</span></a></span><span> </span><span class="annot"><span class="annottext">ConduitT
  CausalDependenciesChunk
  (Hash32, DependencyType)
  (ExceptT SyncErr (ResourceT IO))
  ()
-&gt; ConduitT
     (Hash32, DependencyType)
     Void
     (ExceptT SyncErr (ResourceT IO))
     [Hash32]
-&gt; ConduitT
     CausalDependenciesChunk
     Void
     (ExceptT SyncErr (ResourceT IO))
     [Hash32]
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann -&gt; Stream (Hash32, DependencyType) Hash32
forall v a.
Codebase IO v a -&gt; Stream (Hash32, DependencyType) Hash32
</span><a href="#local-6989586621681054272"><span class="hs-identifier hs-var">findKnownDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621681054260"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Stream (Hash32, DependencyType) Hash32
-&gt; ConduitT Hash32 Void (ExceptT SyncErr (ResourceT IO)) [Hash32]
-&gt; ConduitT
     (Hash32, DependencyType)
     Void
     (ExceptT SyncErr (ResourceT IO))
     [Hash32]
forall (m :: * -&gt; *) a b c r.
Monad m =&gt;
ConduitT a b m () -&gt; ConduitT b c m r -&gt; ConduitT a c m r
</span><span class="hs-operator hs-var">C..|</span></span><span> </span><span class="annot"><span class="annottext">ConduitT Hash32 Void (ExceptT SyncErr (ResourceT IO)) [Hash32]
forall (m :: * -&gt; *) a o. Monad m =&gt; ConduitT a o m [a]
</span><span class="hs-identifier hs-var">C.sinkList</span></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-584"></span><span>    </span><span class="hs-comment">-- Go through the dependencies of the remote root from top-down, yielding all causal hashes that we already</span><span>
</span><span id="line-585"></span><span>    </span><span class="hs-comment">-- have until we find one in the causal spine we already have, then yield that one and stop since we'll implicitly</span><span>
</span><span id="line-586"></span><span>    </span><span class="hs-comment">-- have all of its dependencies.</span><span>
</span><span id="line-587"></span><span>    </span><span id="local-6989586621681053323"><span id="local-6989586621681053324"><span class="annot"><a href="#local-6989586621681054272"><span class="hs-identifier hs-type">findKnownDeps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053323"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053324"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DependencyType</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span></span></span><span>
</span><span id="line-588"></span><span>    </span><span id="local-6989586621681054272"><span class="annot"><span class="annottext">findKnownDeps :: forall v a.
Codebase IO v a -&gt; Stream (Hash32, DependencyType) Hash32
</span><a href="#local-6989586621681054272"><span class="hs-identifier hs-var hs-var">findKnownDeps</span></a></span></span><span> </span><span id="local-6989586621681054286"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681054286"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-589"></span><span>      </span><span class="annot"><span class="annottext">ConduitT
  (Hash32, DependencyType)
  Hash32
  (ExceptT SyncErr (ResourceT IO))
  (Maybe (Hash32, DependencyType))
forall (m :: * -&gt; *) i o. Monad m =&gt; ConduitT i o m (Maybe i)
</span><span class="hs-identifier hs-var">C.await</span></span><span> </span><span class="annot"><span class="annottext">ConduitT
  (Hash32, DependencyType)
  Hash32
  (ExceptT SyncErr (ResourceT IO))
  (Maybe (Hash32, DependencyType))
-&gt; (Maybe (Hash32, DependencyType)
    -&gt; Stream (Hash32, DependencyType) Hash32)
-&gt; Stream (Hash32, DependencyType) Hash32
forall a b.
ConduitT
  (Hash32, DependencyType) Hash32 (ExceptT SyncErr (ResourceT IO)) a
-&gt; (a
    -&gt; ConduitT
         (Hash32, DependencyType) Hash32 (ExceptT SyncErr (ResourceT IO)) b)
-&gt; ConduitT
     (Hash32, DependencyType) Hash32 (ExceptT SyncErr (ResourceT IO)) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-590"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681054287"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054287"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DependencyType
</span><span class="hs-identifier hs-var">LibDependency</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>          </span><span class="hs-comment">-- We yield all lib dependencies we have, it's possible we don't have any of the causal spine in common, but _do_ have</span><span>
</span><span id="line-592"></span><span>          </span><span class="hs-comment">-- some of the libraries we can still save a lot of work.</span><span>
</span><span id="line-593"></span><span>          </span><span class="annot"><span class="annottext">ConduitT
  (Hash32, DependencyType)
  Hash32
  (ExceptT SyncErr (ResourceT IO))
  Bool
-&gt; Stream (Hash32, DependencyType) Hash32
-&gt; Stream (Hash32, DependencyType) Hash32
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">whenM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT SyncErr (ResourceT IO) Bool
-&gt; ConduitT
     (Hash32, DependencyType)
     Hash32
     (ExceptT SyncErr (ResourceT IO))
     Bool
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ConduitT (Hash32, DependencyType) Hash32 m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT SyncErr (ResourceT IO) Bool
 -&gt; ConduitT
      (Hash32, DependencyType)
      Hash32
      (ExceptT SyncErr (ResourceT IO))
      Bool)
-&gt; ExceptT SyncErr (ResourceT IO) Bool
-&gt; ConduitT
     (Hash32, DependencyType)
     Hash32
     (ExceptT SyncErr (ResourceT IO))
     Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr (ResourceT IO) Bool
forall v a.
Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr (ResourceT IO) Bool
</span><a href="#local-6989586621681054290"><span class="hs-identifier hs-var">haveCausalHash</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681054286"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054287"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32 -&gt; Stream (Hash32, DependencyType) Hash32
forall (m :: * -&gt; *) o i. Monad m =&gt; o -&gt; ConduitT i o m ()
</span><span class="hs-identifier hs-var">C.yield</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054287"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-594"></span><span>          </span><span class="hs-comment">-- We continue regardless.</span><span>
</span><span id="line-595"></span><span>          </span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Stream (Hash32, DependencyType) Hash32
forall v a.
Codebase IO v a -&gt; Stream (Hash32, DependencyType) Hash32
</span><a href="#local-6989586621681054272"><span class="hs-identifier hs-var">findKnownDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681054286"><span class="hs-identifier hs-var">codebase</span></a></span><span>
</span><span id="line-596"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681054291"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054291"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DependencyType
</span><span class="hs-identifier hs-var">CausalSpineDependency</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-597"></span><span>          </span><span class="annot"><span class="annottext">ExceptT SyncErr (ResourceT IO) Bool
-&gt; ConduitT
     (Hash32, DependencyType)
     Hash32
     (ExceptT SyncErr (ResourceT IO))
     Bool
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ConduitT (Hash32, DependencyType) Hash32 m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr (ResourceT IO) Bool
forall v a.
Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr (ResourceT IO) Bool
</span><a href="#local-6989586621681054290"><span class="hs-identifier hs-var">haveCausalHash</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681054286"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054291"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConduitT
  (Hash32, DependencyType)
  Hash32
  (ExceptT SyncErr (ResourceT IO))
  Bool
-&gt; (Bool -&gt; Stream (Hash32, DependencyType) Hash32)
-&gt; Stream (Hash32, DependencyType) Hash32
forall a b.
ConduitT
  (Hash32, DependencyType) Hash32 (ExceptT SyncErr (ResourceT IO)) a
-&gt; (a
    -&gt; ConduitT
         (Hash32, DependencyType) Hash32 (ExceptT SyncErr (ResourceT IO)) b)
-&gt; ConduitT
     (Hash32, DependencyType) Hash32 (ExceptT SyncErr (ResourceT IO)) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-598"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-599"></span><span>              </span><span class="hs-comment">-- If we find a causal hash we have in the spine, we don't need to look further,</span><span>
</span><span id="line-600"></span><span>              </span><span class="hs-comment">-- we can pass it on, then hang up the stream.</span><span>
</span><span id="line-601"></span><span>              </span><span class="annot"><span class="annottext">Hash32 -&gt; Stream (Hash32, DependencyType) Hash32
forall (m :: * -&gt; *) o i. Monad m =&gt; o -&gt; ConduitT i o m ()
</span><span class="hs-identifier hs-var">C.yield</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054291"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-602"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-603"></span><span>              </span><span class="hs-comment">-- Otherwise we keep looking, maybe we'll have one further in.</span><span>
</span><span id="line-604"></span><span>              </span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Stream (Hash32, DependencyType) Hash32
forall v a.
Codebase IO v a -&gt; Stream (Hash32, DependencyType) Hash32
</span><a href="#local-6989586621681054272"><span class="hs-identifier hs-var">findKnownDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681054286"><span class="hs-identifier hs-var">codebase</span></a></span><span>
</span><span id="line-605"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Hash32, DependencyType)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Stream (Hash32, DependencyType) Hash32
forall a.
a
-&gt; ConduitT
     (Hash32, DependencyType) Hash32 (ExceptT SyncErr (ResourceT IO)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>    </span><span class="annot"><a href="#local-6989586621681054271"><span class="hs-identifier hs-type">unpack</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.CausalDependenciesChunk</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DependencyType</span></span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>    </span><span id="local-6989586621681054271"><span class="annot"><span class="annottext">unpack :: CausalDependenciesChunk -&gt; (Hash32, DependencyType)
</span><a href="#local-6989586621681054271"><span class="hs-identifier hs-var hs-var">unpack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-608"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">SyncV2.CausalHashDepC</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621681054294"><span class="annot"><span class="annottext">Hash32
causalHash :: Hash32
$sel:causalHash:CausalHashDepC :: CausalDependenciesChunk -&gt; Hash32
</span><a href="#local-6989586621681054294"><span class="hs-identifier hs-var hs-var">causalHash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681054296"><span class="annot"><span class="annottext">DependencyType
dependencyType :: DependencyType
$sel:dependencyType:CausalHashDepC :: CausalDependenciesChunk -&gt; DependencyType
</span><a href="#local-6989586621681054296"><span class="hs-identifier hs-var hs-var">dependencyType</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054294"><span class="hs-identifier hs-var">causalHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DependencyType
</span><a href="#local-6989586621681054296"><span class="hs-identifier hs-var">dependencyType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>    </span><span id="local-6989586621681053331"><span id="local-6989586621681053332"><span class="annot"><a href="#local-6989586621681054290"><span class="hs-identifier hs-type">haveCausalHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codebase.Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053331"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053332"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Share.SyncV2.html#StreamM"><span class="hs-identifier hs-type">StreamM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-610"></span><span>    </span><span id="local-6989586621681054290"><span class="annot"><span class="annottext">haveCausalHash :: forall v a.
Codebase IO v a -&gt; Hash32 -&gt; ExceptT SyncErr (ResourceT IO) Bool
</span><a href="#local-6989586621681054290"><span class="hs-identifier hs-var hs-var">haveCausalHash</span></a></span></span><span> </span><span id="local-6989586621681054301"><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681054301"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621681054302"><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054302"><span class="hs-identifier hs-var">causalHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-611"></span><span>      </span><span class="annot"><span class="annottext">IO Bool -&gt; ExceptT SyncErr (ResourceT IO) Bool
forall a. IO a -&gt; ExceptT SyncErr (ResourceT IO) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; ExceptT SyncErr (ResourceT IO) Bool)
-&gt; IO Bool -&gt; ExceptT SyncErr (ResourceT IO) Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a -&gt; Transaction Bool -&gt; IO Bool
forall (m :: * -&gt; *) v a b.
MonadIO m =&gt;
Codebase m v a -&gt; Transaction b -&gt; m b
</span><span class="hs-identifier hs-var">Codebase.runTransaction</span></span><span> </span><span class="annot"><span class="annottext">Codebase IO v a
</span><a href="#local-6989586621681054301"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-612"></span><span>        </span><span class="annot"><span class="annottext">Hash32 -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Q.causalExistsByHash32</span></span><span> </span><span class="annot"><span class="annottext">Hash32
</span><a href="#local-6989586621681054302"><span class="hs-identifier hs-var">causalHash</span></a></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-615"></span><span class="hs-comment">-- Progress Tracking</span><span>
</span><span id="line-616"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span id="local-6989586621681053335"><span id="local-6989586621681053336"><span id="local-6989586621681053337"><span class="annot"><a href="Unison.Share.SyncV2.html#counterProgress"><span class="hs-identifier hs-type">counterProgress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053335"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadUnliftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053336"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053335"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053336"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053337"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053336"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053337"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-619"></span><span id="counterProgress"><span class="annot"><span class="annottext">counterProgress :: forall (m :: * -&gt; *) (n :: * -&gt; *) a.
(MonadIO m, MonadUnliftIO n) =&gt;
(Int -&gt; Text) -&gt; ((Int -&gt; m ()) -&gt; n a) -&gt; n a
</span><a href="Unison.Share.SyncV2.html#counterProgress"><span class="hs-identifier hs-var hs-var">counterProgress</span></a></span></span><span> </span><span id="local-6989586621681054326"><span class="annot"><span class="annottext">Int -&gt; Text
</span><a href="#local-6989586621681054326"><span class="hs-identifier hs-var">msgBuilder</span></a></span></span><span> </span><span id="local-6989586621681054327"><span class="annot"><span class="annottext">(Int -&gt; m ()) -&gt; n a
</span><a href="#local-6989586621681054327"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-620"></span><span>  </span><span id="local-6989586621681054328"><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621681054328"><span class="hs-identifier hs-var">counterVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; n (TVar Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">IO.newTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>  </span><span class="annot"><span class="annottext">((forall a. n a -&gt; IO a) -&gt; IO a) -&gt; n a
forall b. ((forall a. n a -&gt; IO a) -&gt; IO b) -&gt; n b
forall (m :: * -&gt; *) b.
MonadUnliftIO m =&gt;
((forall a. m a -&gt; IO a) -&gt; IO b) -&gt; m b
</span><span class="hs-identifier hs-var">IO.withRunInIO</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054330"><span class="annot"><span class="annottext">forall a. n a -&gt; IO a
</span><a href="#local-6989586621681054330"><span class="hs-identifier hs-var">toIO</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-622"></span><span>    </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall (m :: * -&gt; *) a. (MonadIO m, MonadMask m) =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">Console.Regions.displayConsoleRegions</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-623"></span><span>      </span><span class="annot"><span class="annottext">RegionLayout -&gt; (ConsoleRegion -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) a.
(MonadIO m, MonadMask m) =&gt;
RegionLayout -&gt; (ConsoleRegion -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">Console.Regions.withConsoleRegion</span></span><span> </span><span class="annot"><span class="annottext">RegionLayout
</span><span class="hs-identifier hs-var">Console.Regions.Linear</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054331"><span class="annot"><span class="annottext">ConsoleRegion
</span><a href="#local-6989586621681054331"><span class="hs-identifier hs-var">region</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-624"></span><span>        </span><span class="annot"><span class="annottext">ConsoleRegion -&gt; STM Text -&gt; IO ()
forall v (m :: * -&gt; *).
(ToRegionContent v, LiftRegion m) =&gt;
ConsoleRegion -&gt; v -&gt; m ()
</span><span class="hs-identifier hs-var">Console.Regions.setConsoleRegion</span></span><span> </span><span class="annot"><span class="annottext">ConsoleRegion
</span><a href="#local-6989586621681054331"><span class="hs-identifier hs-var">region</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-625"></span><span>          </span><span id="local-6989586621681054332"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054332"><span class="hs-identifier hs-var">num</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; STM Int
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">IO.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621681054328"><span class="hs-identifier hs-var">counterVar</span></a></span><span>
</span><span id="line-626"></span><span>          </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
</span><a href="#local-6989586621681054326"><span class="hs-identifier hs-var">msgBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054332"><span class="hs-identifier hs-var">num</span></a></span><span>
</span><span id="line-627"></span><span>        </span><span class="annot"><span class="annottext">n a -&gt; IO a
forall a. n a -&gt; IO a
</span><a href="#local-6989586621681054330"><span class="hs-identifier hs-var">toIO</span></a></span><span> </span><span class="annot"><span class="annottext">(n a -&gt; IO a) -&gt; n a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m ()) -&gt; n a
</span><a href="#local-6989586621681054327"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; m ()) -&gt; n a) -&gt; (Int -&gt; m ()) -&gt; n a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054334"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054334"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-628"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">IO.atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar Int -&gt; (Int -&gt; Int) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">IO.modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621681054328"><span class="hs-identifier hs-var">counterVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054334"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span class="annot"><span class="hs-comment">-- | Track how many entities have been downloaded using a counter stream.</span></span><span>
</span><span id="line-631"></span><span id="local-6989586621681052873"><span id="local-6989586621681052874"><span id="local-6989586621681052875"><span id="local-6989586621681052876"><span class="annot"><a href="Unison.Share.SyncV2.html#withStreamProgressCallback"><span class="hs-identifier hs-type">withStreamProgressCallback</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052873"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadUnliftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621681052874"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConduitT</span></span><span> </span><span class="annot"><a href="#local-6989586621681052875"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052875"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681052874"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052876"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681052874"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681052876"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-632"></span><span id="withStreamProgressCallback"><span class="annot"><span class="annottext">withStreamProgressCallback :: forall (m :: * -&gt; *) (n :: * -&gt; *) i a.
(MonadIO m, MonadUnliftIO n) =&gt;
Maybe Int -&gt; (ConduitT i i m () -&gt; n a) -&gt; n a
</span><a href="Unison.Share.SyncV2.html#withStreamProgressCallback"><span class="hs-identifier hs-var hs-var">withStreamProgressCallback</span></a></span></span><span> </span><span id="local-6989586621681054357"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621681054357"><span class="hs-identifier hs-var">total</span></a></span></span><span> </span><span id="local-6989586621681054358"><span class="annot"><span class="annottext">ConduitT i i m () -&gt; n a
</span><a href="#local-6989586621681054358"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681054359"><span class="annot"><span class="annottext">msg :: Int -&gt; Text
</span><a href="#local-6989586621681054359"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621681054360"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054360"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;\n  &#128230; Unpacked  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054360"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; (Int -&gt; Text) -&gt; Maybe Int -&gt; Text
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681054363"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054363"><span class="hs-identifier hs-var">total</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; / &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054363"><span class="hs-identifier hs-var">total</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621681054357"><span class="hs-identifier hs-var">total</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; entities...\n\n&quot;</span></span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681054364"><span class="annot"><span class="annottext">action' :: (Int -&gt; m ()) -&gt; n a
</span><a href="#local-6989586621681054364"><span class="hs-identifier hs-var hs-var">action'</span></a></span></span><span> </span><span id="local-6989586621681054365"><span class="annot"><span class="annottext">Int -&gt; m ()
</span><a href="#local-6989586621681054365"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConduitT i i m () -&gt; n a
</span><a href="#local-6989586621681054358"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(i -&gt; m ()) -&gt; ConduitT i i m ()
forall (m :: * -&gt; *) a. Monad m =&gt; (a -&gt; m ()) -&gt; ConduitT a a m ()
</span><span class="hs-identifier hs-var">C.iterM</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681054366"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621681054366"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m ()
</span><a href="#local-6989586621681054365"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Text) -&gt; ((Int -&gt; m ()) -&gt; n a) -&gt; n a
forall (m :: * -&gt; *) (n :: * -&gt; *) a.
(MonadIO m, MonadUnliftIO n) =&gt;
(Int -&gt; Text) -&gt; ((Int -&gt; m ()) -&gt; n a) -&gt; n a
</span><a href="Unison.Share.SyncV2.html#counterProgress"><span class="hs-identifier hs-var">counterProgress</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
</span><a href="#local-6989586621681054359"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m ()) -&gt; n a
</span><a href="#local-6989586621681054364"><span class="hs-identifier hs-var">action'</span></a></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span class="annot"><span class="hs-comment">-- | Track how many entities have been saved.</span></span><span>
</span><span id="line-638"></span><span id="local-6989586621681053026"><span id="local-6989586621681053027"><span class="annot"><a href="Unison.Share.SyncV2.html#withEntitySavingCallback"><span class="hs-identifier hs-type">withEntitySavingCallback</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadUnliftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053026"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053026"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053026"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053027"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053026"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053027"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-639"></span><span id="withEntitySavingCallback"><span class="annot"><span class="annottext">withEntitySavingCallback :: forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
Maybe Int -&gt; ((Int -&gt; m ()) -&gt; m a) -&gt; m a
</span><a href="Unison.Share.SyncV2.html#withEntitySavingCallback"><span class="hs-identifier hs-var hs-var">withEntitySavingCallback</span></a></span></span><span> </span><span id="local-6989586621681054381"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621681054381"><span class="hs-identifier hs-var">total</span></a></span></span><span> </span><span id="local-6989586621681054382"><span class="annot"><span class="annottext">(Int -&gt; m ()) -&gt; m a
</span><a href="#local-6989586621681054382"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-640"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681054383"><span class="annot"><span class="annottext">msg :: Int -&gt; Text
</span><a href="#local-6989586621681054383"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621681054384"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054384"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;\n  &#128190; Saved  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054384"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; (Int -&gt; Text) -&gt; Maybe Int -&gt; Text
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681054385"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054385"><span class="hs-identifier hs-var">total</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; / &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681054385"><span class="hs-identifier hs-var">total</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621681054381"><span class="hs-identifier hs-var">total</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; new entities...\n\n&quot;</span></span><span>
</span><span id="line-641"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Text) -&gt; ((Int -&gt; m ()) -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) (n :: * -&gt; *) a.
(MonadIO m, MonadUnliftIO n) =&gt;
(Int -&gt; Text) -&gt; ((Int -&gt; m ()) -&gt; n a) -&gt; n a
</span><a href="Unison.Share.SyncV2.html#counterProgress"><span class="hs-identifier hs-var">counterProgress</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
</span><a href="#local-6989586621681054383"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m ()) -&gt; m a
</span><a href="#local-6989586621681054382"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span class="annot"><span class="hs-comment">-- | Track how many entities have been loaded.</span></span><span>
</span><span id="line-644"></span><span id="local-6989586621681053124"><span id="local-6989586621681053125"><span class="annot"><a href="Unison.Share.SyncV2.html#withEntityLoadingCallback"><span class="hs-identifier hs-type">withEntityLoadingCallback</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadUnliftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621681053124"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053124"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053124"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053125"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681053124"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681053125"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-645"></span><span id="withEntityLoadingCallback"><span class="annot"><span class="annottext">withEntityLoadingCallback :: forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
((Int -&gt; m ()) -&gt; m a) -&gt; m a
</span><a href="Unison.Share.SyncV2.html#withEntityLoadingCallback"><span class="hs-identifier hs-var hs-var">withEntityLoadingCallback</span></a></span></span><span> </span><span id="local-6989586621681054391"><span class="annot"><span class="annottext">(Int -&gt; m ()) -&gt; m a
</span><a href="#local-6989586621681054391"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-646"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681054398"><span class="annot"><span class="annottext">msg :: a -&gt; Text
</span><a href="#local-6989586621681054398"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621681054399"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681054399"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;\n  &#128230; Unpacked  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681054399"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; entities...\n\n&quot;</span></span><span>
</span><span id="line-647"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Text) -&gt; ((Int -&gt; m ()) -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) (n :: * -&gt; *) a.
(MonadIO m, MonadUnliftIO n) =&gt;
(Int -&gt; Text) -&gt; ((Int -&gt; m ()) -&gt; n a) -&gt; n a
</span><a href="Unison.Share.SyncV2.html#counterProgress"><span class="hs-identifier hs-var">counterProgress</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><a href="#local-6989586621681054398"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m ()) -&gt; m a
</span><a href="#local-6989586621681054391"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-648"></span></pre></body></html>