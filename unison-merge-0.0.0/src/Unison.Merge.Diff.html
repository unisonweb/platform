<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Merge.Diff</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Merge.Diff.html#nameBasedNamespaceDiff"><span class="hs-identifier">nameBasedNamespaceDiff</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Unison.Merge.Diff.html#humanizeDiffs"><span class="hs-identifier">humanizeDiffs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either.Combinators</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapRight</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NEL</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NEList</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Semialign</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Unalign</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">alignWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set.NonEmpty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NESet</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.These</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">These</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Zip</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Zip</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decl</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DataDeclaration</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DeclNameLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DeclNameLookup</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DeclNameLookup</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DeclNameLookup</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html"><span class="hs-identifier">Unison.Merge.DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.HumanDiffOp.html"><span class="hs-identifier">Unison.Merge.HumanDiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp"><span class="hs-identifier">HumanDiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.PartialDeclNameLookup.html"><span class="hs-identifier">Unison.Merge.PartialDeclNameLookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.PartialDeclNameLookup.html#PartialDeclNameLookup"><span class="hs-identifier">PartialDeclNameLookup</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Synhash.html"><span class="hs-identifier">Unison.Merge.Synhash</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Synhash</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html"><span class="hs-identifier">Unison.Merge.Synhashed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier">Synhashed</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html"><span class="hs-identifier">Unison.Merge.Synhashed</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Synhashed</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.ThreeWay.html"><span class="hs-identifier">Unison.Merge.ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Internal.Types.html#ThreeWay"><span class="hs-identifier">ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.ThreeWay.html"><span class="hs-identifier">Unison.Merge.ThreeWay</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ThreeWay</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.TwoWay.html"><span class="hs-identifier">Unison.Merge.TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html"><span class="hs-identifier">Unison.Merge.Updated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier">Updated</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Names</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Names</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PrettyPrintEnv</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnv</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPE</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnvDecl</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPED</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Reference'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TermReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TermReferenceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TypeReferenceId</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Referent</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.Name</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.BiMultimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BiMultimap</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.BiMultimap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BiMultimap</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Defns</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DefnsF</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DefnsF2</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DefnsF3</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zipDefnsWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Defns</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Defns</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Relation</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Relation</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Relation</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rel</span></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- | @nameBasedNamespaceDiff db declNameLookups defns@ returns Alice's and Bob's name-based namespace diffs, each in the</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- form:</span><span>
</span><span id="line-56"></span><span class="hs-comment">--</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- &gt; terms :: Map Name (DiffOp (Synhashed Referent))</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- &gt; types :: Map Name (DiffOp (Synhashed TypeReference))</span><span>
</span><span id="line-59"></span><span class="hs-comment">--</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- where each name is paired with its diff-op (added, deleted, or updated), relative to the LCA between Alice and Bob's</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- branches. If the hash of a name did not change, it will not appear in the map.</span><span>
</span><span id="line-62"></span><span class="annot"><a href="Unison.Merge.Diff.html#nameBasedNamespaceDiff"><span class="hs-identifier hs-type">nameBasedNamespaceDiff</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DeclNameLookup</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><a href="Unison.Merge.PartialDeclNameLookup.html#PartialDeclNameLookup"><span class="hs-identifier hs-type">PartialDeclNameLookup</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><a href="Unison.Merge.Internal.Types.html#ThreeWay"><span class="hs-identifier hs-type">ThreeWay</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PPED.PrettyPrintEnvDecl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><a href="Unison.Merge.Internal.Types.html#ThreeWay"><span class="hs-identifier hs-type">ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- Core diffs, i.e. adds, deletes, and updates which have different synhashes.</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- Propagated updates, i.e. updates which have the same synhash but different Unison hashes.</span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span id="nameBasedNamespaceDiff"><span class="annot"><span class="annottext">nameBasedNamespaceDiff :: HasCallStack =&gt;
TwoWay DeclNameLookup
-&gt; PartialDeclNameLookup
-&gt; ThreeWay PrettyPrintEnvDecl
-&gt; ThreeWay
     (Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name))
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; (TwoWay
      (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference),
    TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference))
</span><a href="Unison.Merge.Diff.html#nameBasedNamespaceDiff"><span class="hs-identifier hs-var hs-var">nameBasedNamespaceDiff</span></a></span></span><span> </span><span id="local-6989586621679195134"><span class="annot"><span class="annottext">TwoWay DeclNameLookup
</span><a href="#local-6989586621679195134"><span class="hs-identifier hs-var">declNameLookups</span></a></span></span><span> </span><span id="local-6989586621679195135"><span class="annot"><span class="annottext">PartialDeclNameLookup
</span><a href="#local-6989586621679195135"><span class="hs-identifier hs-var">lcaDeclNameLookup</span></a></span></span><span> </span><span id="local-6989586621679195136"><span class="annot"><span class="annottext">ThreeWay PrettyPrintEnvDecl
</span><a href="#local-6989586621679195136"><span class="hs-identifier hs-var">ppeds</span></a></span></span><span> </span><span id="local-6989586621679195137"><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name))
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">defns</span></a></span></span><span> </span><span id="local-6989586621679195138"><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">hydratedDefns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195139"><span class="annot"><span class="annottext">lcaHashes :: DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="#local-6989586621679195139"><span class="hs-identifier hs-var hs-var">lcaHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
PrettyPrintEnv
-&gt; PartialDeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
PrettyPrintEnv
-&gt; PartialDeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="Unison.Merge.Diff.html#synhashLcaDefns"><span class="hs-identifier hs-var">synhashLcaDefns</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195141"><span class="hs-identifier hs-var">synhashPPE</span></a></span><span> </span><span class="annot"><span class="annottext">PartialDeclNameLookup
</span><a href="#local-6989586621679195135"><span class="hs-identifier hs-var">lcaDeclNameLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name))
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span> </span><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">hydratedDefns</span></a></span><span>
</span><span id="line-76"></span><span>      </span><span id="local-6989586621679195142"><span class="annot"><span class="annottext">aliceHashes :: DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var hs-var">aliceHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
PrettyPrintEnv
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
PrettyPrintEnv
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="Unison.Merge.Diff.html#synhashDefns"><span class="hs-identifier hs-var">synhashDefns</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195141"><span class="hs-identifier hs-var">synhashPPE</span></a></span><span> </span><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">hydratedDefns</span></a></span><span> </span><span class="annot"><span class="annottext">TwoWay DeclNameLookup
</span><a href="#local-6989586621679195134"><span class="hs-identifier hs-var">declNameLookups</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">alice</span><span> </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name))
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">alice</span><span>
</span><span id="line-77"></span><span>      </span><span id="local-6989586621679195144"><span class="annot"><span class="annottext">bobHashes :: DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="#local-6989586621679195144"><span class="hs-identifier hs-var hs-var">bobHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
PrettyPrintEnv
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
PrettyPrintEnv
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="Unison.Merge.Diff.html#synhashDefns"><span class="hs-identifier hs-var">synhashDefns</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195141"><span class="hs-identifier hs-var">synhashPPE</span></a></span><span> </span><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">hydratedDefns</span></a></span><span> </span><span class="annot"><span class="annottext">TwoWay DeclNameLookup
</span><a href="#local-6989586621679195134"><span class="hs-identifier hs-var">declNameLookups</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">bob</span><span> </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name))
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">bob</span><span>
</span><span id="line-78"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed Referent TypeReference
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
-&gt; (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference,
    DefnsF2 (Map Name) Updated Referent TypeReference)
forall term typ.
DefnsF2 (Map Name) Synhashed term typ
-&gt; DefnsF2 (Map Name) Synhashed term typ
-&gt; (DefnsF3 (Map Name) DiffOp Synhashed term typ,
    DefnsF2 (Map Name) Updated term typ)
</span><a href="Unison.Merge.Diff.html#diffHashedNamespaceDefns"><span class="hs-identifier hs-var">diffHashedNamespaceDefns</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="#local-6989586621679195139"><span class="hs-identifier hs-var">lcaHashes</span></a></span><span> </span><span class="annot"><span class="annottext">(DefnsF2 (Map Name) Synhashed Referent TypeReference
 -&gt; (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference,
     DefnsF2 (Map Name) Updated Referent TypeReference))
-&gt; TwoWay (DefnsF2 (Map Name) Synhashed Referent TypeReference)
-&gt; TwoWay
     (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference,
      DefnsF2 (Map Name) Updated Referent TypeReference)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:alice:TwoWay :: DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="Unison.Merge.TwoWay.html#%24sel%3Aalice%3ATwoWay"><span class="hs-identifier hs-var">alice</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var">aliceHashes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:bob:TwoWay :: DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="Unison.Merge.TwoWay.html#%24sel%3Abob%3ATwoWay"><span class="hs-identifier hs-var">bob</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="#local-6989586621679195144"><span class="hs-identifier hs-var">bobHashes</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><span class="annottext">TwoWay
  (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference,
   DefnsF2 (Map Name) Updated Referent TypeReference)
-&gt; (TwoWay
      (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference,
       DefnsF2 (Map Name) Updated Referent TypeReference)
    -&gt; (TwoWay
          (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference),
        TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference)))
-&gt; (TwoWay
      (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference),
    TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">TwoWay
  (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference,
   DefnsF2 (Map Name) Updated Referent TypeReference)
-&gt; (TwoWay
      (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference),
    TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference))
forall a b. TwoWay (a, b) -&gt; (TwoWay a, TwoWay b)
forall (f :: * -&gt; *) a b. Unzip f =&gt; f (a, b) -&gt; (f a, f b)
</span><span class="hs-identifier hs-var">Zip.unzip</span></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><a href="#local-6989586621679195141"><span class="hs-identifier hs-type">synhashPPE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PPE.PrettyPrintEnv</span></span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621679195141"><span class="annot"><span class="annottext">synhashPPE :: PrettyPrintEnv
</span><a href="#local-6989586621679195141"><span class="hs-identifier hs-var hs-var">synhashPPE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Unison.Merge.Internal.Types.html#ThreeWay"><span class="hs-identifier hs-type">ThreeWay</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:lca:ThreeWay :: forall a. ThreeWay a -&gt; a
</span><a href="Unison.Merge.Internal.Types.html#%24sel%3Alca%3AThreeWay"><span class="hs-identifier hs-var">lca</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679195154"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195154"><span class="hs-identifier hs-var">lcaPPE</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:alice:ThreeWay :: forall a. ThreeWay a -&gt; a
</span><a href="Unison.Merge.Internal.Types.html#%24sel%3Aalice%3AThreeWay"><span class="hs-identifier hs-var">alice</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679195156"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195156"><span class="hs-identifier hs-var">alicePPE</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:bob:ThreeWay :: forall a. ThreeWay a -&gt; a
</span><a href="Unison.Merge.Internal.Types.html#%24sel%3Abob%3AThreeWay"><span class="hs-identifier hs-var">bob</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679195158"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195158"><span class="hs-identifier hs-var">bobPPE</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl -&gt; PrettyPrintEnv
</span><span class="hs-identifier hs-var">PPED.unsuffixifiedPPE</span></span><span> </span><span class="annot"><span class="annottext">(PrettyPrintEnvDecl -&gt; PrettyPrintEnv)
-&gt; ThreeWay PrettyPrintEnvDecl -&gt; ThreeWay PrettyPrintEnv
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ThreeWay PrettyPrintEnvDecl
</span><a href="#local-6989586621679195136"><span class="hs-identifier hs-var">ppeds</span></a></span><span>
</span><span id="line-84"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195156"><span class="hs-identifier hs-var">alicePPE</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv -&gt; PrettyPrintEnv -&gt; PrettyPrintEnv
</span><span class="hs-operator hs-var">`PPE.addFallback`</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195158"><span class="hs-identifier hs-var">bobPPE</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv -&gt; PrettyPrintEnv -&gt; PrettyPrintEnv
</span><span class="hs-operator hs-var">`PPE.addFallback`</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195154"><span class="hs-identifier hs-var">lcaPPE</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span id="local-6989586621679194905"><span id="local-6989586621679194906"><span class="annot"><a href="Unison.Merge.Diff.html#diffHashedNamespaceDefns"><span class="hs-identifier hs-type">diffHashedNamespaceDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194905"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194906"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194905"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194906"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- Core diffs, i.e. adds, deletes, and updates which have different synhashes.</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DefnsF3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194905"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194906"><span class="hs-identifier hs-type">typ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">-- Propagated updates, i.e. updates which have the same synhash but different Unison hashes.</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194905"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194906"><span class="hs-identifier hs-type">typ</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">)</span></span></span><span>
</span><span id="line-94"></span><span id="diffHashedNamespaceDefns"><span class="annot"><span class="annottext">diffHashedNamespaceDefns :: forall term typ.
DefnsF2 (Map Name) Synhashed term typ
-&gt; DefnsF2 (Map Name) Synhashed term typ
-&gt; (DefnsF3 (Map Name) DiffOp Synhashed term typ,
    DefnsF2 (Map Name) Updated term typ)
</span><a href="Unison.Merge.Diff.html#diffHashedNamespaceDefns"><span class="hs-identifier hs-var hs-var">diffHashedNamespaceDefns</span></a></span></span><span> </span><span id="local-6989586621679195161"><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed term typ
</span><a href="#local-6989586621679195161"><span class="hs-identifier hs-var">d1</span></a></span></span><span> </span><span id="local-6989586621679195162"><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed term typ
</span><a href="#local-6989586621679195162"><span class="hs-identifier hs-var">d2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><span class="annottext">(Map Name (Synhashed term)
 -&gt; Map Name (Synhashed term)
 -&gt; (Map Name (DiffOp (Synhashed term)), Map Name (Updated term)))
-&gt; (Map Name (Synhashed typ)
    -&gt; Map Name (Synhashed typ)
    -&gt; (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ)))
-&gt; DefnsF2 (Map Name) Synhashed term typ
-&gt; DefnsF2 (Map Name) Synhashed term typ
-&gt; Defns
     (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
     (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
forall tm1 tm2 tm3 ty1 ty2 ty3.
(tm1 -&gt; tm2 -&gt; tm3)
-&gt; (ty1 -&gt; ty2 -&gt; ty3)
-&gt; Defns tm1 ty1
-&gt; Defns tm2 ty2
-&gt; Defns tm3 ty3
</span><span class="hs-identifier hs-var">zipDefnsWith</span></span><span> </span><span class="annot"><span class="annottext">Map Name (Synhashed term)
-&gt; Map Name (Synhashed term)
-&gt; (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
forall ref.
Map Name (Synhashed ref)
-&gt; Map Name (Synhashed ref)
-&gt; (Map Name (DiffOp (Synhashed ref)), Map Name (Updated ref))
</span><a href="#local-6989586621679195163"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (Synhashed typ)
-&gt; Map Name (Synhashed typ)
-&gt; (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
forall ref.
Map Name (Synhashed ref)
-&gt; Map Name (Synhashed ref)
-&gt; (Map Name (DiffOp (Synhashed ref)), Map Name (Updated ref))
</span><a href="#local-6989586621679195163"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed term typ
</span><a href="#local-6989586621679195161"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed term typ
</span><a href="#local-6989586621679195162"><span class="hs-identifier hs-var">d2</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="annottext">Defns
  (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
  (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
-&gt; (Defns
      (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
      (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
    -&gt; (DefnsF3 (Map Name) DiffOp Synhashed term typ,
        DefnsF2 (Map Name) Updated term typ))
-&gt; (DefnsF3 (Map Name) DiffOp Synhashed term typ,
    DefnsF2 (Map Name) Updated term typ)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Defns
  (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
  (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
-&gt; (DefnsF3 (Map Name) DiffOp Synhashed term typ,
    DefnsF2 (Map Name) Updated term typ)
forall term typ.
Defns
  (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
  (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
-&gt; (DefnsF3 (Map Name) DiffOp Synhashed term typ,
    DefnsF2 (Map Name) Updated term typ)
</span><a href="#local-6989586621679195164"><span class="hs-identifier hs-var">splitPropagated</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-98"></span><span>    </span><span id="local-6989586621679194924"><span class="annot"><a href="#local-6989586621679195163"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-99"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194924"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194924"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194924"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194924"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-102"></span><span>    </span><span id="local-6989586621679195163"><span class="annot"><span class="annottext">f :: forall ref.
Map Name (Synhashed ref)
-&gt; Map Name (Synhashed ref)
-&gt; (Map Name (DiffOp (Synhashed ref)), Map Name (Updated ref))
</span><a href="#local-6989586621679195163"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679195177"><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679195177"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679195178"><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679195178"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><span class="annottext">Map Name (These (DiffOp (Synhashed ref)) (Updated ref))
-&gt; (Map Name (DiffOp (Synhashed ref)), Map Name (Updated ref))
forall a b. Map Name (These a b) -&gt; (Map Name a, Map Name b)
forall (f :: * -&gt; *) a b. Unalign f =&gt; f (These a b) -&gt; (f a, f b)
</span><span class="hs-identifier hs-var">unalign</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either (DiffOp (Synhashed ref)) (Updated ref)
-&gt; These (DiffOp (Synhashed ref)) (Updated ref)
forall a b. Either a b -&gt; These a b
</span><span class="hs-identifier hs-var">eitherToThese</span></span><span> </span><span class="annot"><span class="annottext">(Either (DiffOp (Synhashed ref)) (Updated ref)
 -&gt; These (DiffOp (Synhashed ref)) (Updated ref))
-&gt; (Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref))
    -&gt; Either (DiffOp (Synhashed ref)) (Updated ref))
-&gt; Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref))
-&gt; These (DiffOp (Synhashed ref)) (Updated ref)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Updated (Synhashed ref) -&gt; Updated ref)
-&gt; Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref))
-&gt; Either (DiffOp (Synhashed ref)) (Updated ref)
forall b c a. (b -&gt; c) -&gt; Either a b -&gt; Either a c
</span><span class="hs-identifier hs-var">mapRight</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Synhashed ref -&gt; ref) -&gt; Updated (Synhashed ref) -&gt; Updated ref
forall a b. (a -&gt; b) -&gt; Updated a -&gt; Updated b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Synhashed ref -&gt; ref
forall a. Synhashed a -&gt; a
</span><a href="Unison.Merge.Synhashed.html#%24sel%3Avalue%3ASynhashed"><span class="hs-identifier hs-var">Synhashed.value</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref))
 -&gt; These (DiffOp (Synhashed ref)) (Updated ref))
-&gt; Map
     Name (Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref)))
-&gt; Map Name (These (DiffOp (Synhashed ref)) (Updated ref))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(These (Synhashed ref) (Synhashed ref)
 -&gt; Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref)))
-&gt; Map Name (Synhashed ref)
-&gt; Map Name (Synhashed ref)
-&gt; Map
     Name (Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref)))
forall a b c.
(These a b -&gt; c) -&gt; Map Name a -&gt; Map Name b -&gt; Map Name c
forall (f :: * -&gt; *) a b c.
Semialign f =&gt;
(These a b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">alignWith</span></span><span> </span><span class="annot"><span class="annottext">These (Synhashed ref) (Synhashed ref)
-&gt; Either (DiffOp (Synhashed ref)) (Updated (Synhashed ref))
forall x. Eq x =&gt; These x x -&gt; Either (DiffOp x) (Updated x)
</span><a href="#local-6989586621679195183"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679195177"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679195178"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span>    </span><span id="local-6989586621679194954"><span class="annot"><a href="#local-6989586621679195183"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679194954"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span class="annot"><a href="#local-6989586621679194954"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194954"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194954"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194954"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621679195183"><span class="annot"><span class="annottext">g :: forall x. Eq x =&gt; These x x -&gt; Either (DiffOp x) (Updated x)
</span><a href="#local-6989586621679195183"><span class="hs-identifier hs-var hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">This</span></span><span> </span><span id="local-6989586621679195187"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195187"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiffOp x -&gt; Either (DiffOp x) (Updated x)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; DiffOp x
forall a. a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Delete"><span class="hs-identifier hs-var">DiffOp'Delete</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195187"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">That</span></span><span> </span><span id="local-6989586621679195190"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195190"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiffOp x -&gt; Either (DiffOp x) (Updated x)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; DiffOp x
forall a. a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Add"><span class="hs-identifier hs-var">DiffOp'Add</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195190"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span id="local-6989586621679195193"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195193"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679195194"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195194"><span class="hs-identifier hs-var">new</span></a></span></span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195193"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679195194"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Updated x -&gt; Either (DiffOp x) (Updated x)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">x
old :: x
$sel:old:Updated :: x
</span><a href="#local-6989586621679195193"><span class="hs-identifier hs-var hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">x
new :: x
$sel:new:Updated :: x
</span><a href="#local-6989586621679195194"><span class="hs-identifier hs-var hs-var">new</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-111"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiffOp x -&gt; Either (DiffOp x) (Updated x)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Updated x -&gt; DiffOp x
forall a. Updated a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Update"><span class="hs-identifier hs-var">DiffOp'Update</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">x
old :: x
$sel:old:Updated :: x
</span><a href="#local-6989586621679195193"><span class="hs-identifier hs-var hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">x
new :: x
$sel:new:Updated :: x
</span><a href="#local-6989586621679195194"><span class="hs-identifier hs-var hs-var">new</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621679194925"><span id="local-6989586621679194926"><span class="annot"><a href="#local-6989586621679195164"><span class="hs-identifier hs-type">splitPropagated</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-114"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194925"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-116"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194925"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194926"><span class="hs-identifier hs-type">typ</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194926"><span class="hs-identifier hs-type">typ</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194925"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194926"><span class="hs-identifier hs-type">typ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194925"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194926"><span class="hs-identifier hs-type">typ</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621679195164"><span class="annot"><span class="annottext">splitPropagated :: forall term typ.
Defns
  (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
  (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
-&gt; (DefnsF3 (Map Name) DiffOp Synhashed term typ,
    DefnsF2 (Map Name) Updated term typ)
</span><a href="#local-6989586621679195164"><span class="hs-identifier hs-var hs-var">splitPropagated</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679195200"><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
terms :: (Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
$sel:terms:Defns :: forall terms types. Defns terms types -&gt; terms
</span><a href="#local-6989586621679195200"><span class="hs-identifier hs-var hs-var">terms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195202"><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
types :: (Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
$sel:types:Defns :: forall terms types. Defns terms types -&gt; types
</span><a href="#local-6989586621679195202"><span class="hs-identifier hs-var hs-var">types</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:terms:Defns :: Map Name (DiffOp (Synhashed term))
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
-&gt; Map Name (DiffOp (Synhashed term))
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
</span><a href="#local-6989586621679195200"><span class="hs-identifier hs-var">terms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:types:Defns :: Map Name (DiffOp (Synhashed typ))
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
-&gt; Map Name (DiffOp (Synhashed typ))
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
</span><a href="#local-6989586621679195202"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:terms:Defns :: Map Name (Updated term)
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
-&gt; Map Name (Updated term)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed term)), Map Name (Updated term))
</span><a href="#local-6989586621679195200"><span class="hs-identifier hs-var">terms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:types:Defns :: Map Name (Updated typ)
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
-&gt; Map Name (Updated typ)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Map Name (DiffOp (Synhashed typ)), Map Name (Updated typ))
</span><a href="#local-6989586621679195202"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">-- | Post-process a diff to identify relationships humans might care about, such as whether a given addition could be</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- interpreted as an alias of an existing definition, or whether an add and deletion could be a rename.</span><span>
</span><span id="line-125"></span><span class="annot"><a href="Unison.Merge.Diff.html#humanizeDiffs"><span class="hs-identifier hs-type">humanizeDiffs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="Unison.Merge.Internal.Types.html#ThreeWay"><span class="hs-identifier hs-type">ThreeWay</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp"><span class="hs-identifier hs-type">HumanDiffOp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span id="humanizeDiffs"><span class="annot"><span class="annottext">humanizeDiffs :: ThreeWay Names
-&gt; TwoWay
     (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference)
-&gt; TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference)
-&gt; TwoWay (DefnsF2 (Map Name) HumanDiffOp Referent TypeReference)
</span><a href="Unison.Merge.Diff.html#humanizeDiffs"><span class="hs-identifier hs-var hs-var">humanizeDiffs</span></a></span></span><span> </span><span id="local-6989586621679195206"><span class="annot"><span class="annottext">ThreeWay Names
</span><a href="#local-6989586621679195206"><span class="hs-identifier hs-var">names3</span></a></span></span><span> </span><span id="local-6989586621679195207"><span class="annot"><span class="annottext">TwoWay (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference)
</span><a href="#local-6989586621679195207"><span class="hs-identifier hs-var">diffs</span></a></span></span><span> </span><span id="local-6989586621679195208"><span class="annot"><span class="annottext">TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference)
</span><a href="#local-6989586621679195208"><span class="hs-identifier hs-var">propagatedUpdates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">TwoWay (DefnsF (Relation Name) Referent TypeReference)
-&gt; TwoWay
     (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference)
-&gt; TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference)
-&gt; (DefnsF (Relation Name) Referent TypeReference
    -&gt; DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference
    -&gt; DefnsF2 (Map Name) Updated Referent TypeReference
    -&gt; DefnsF2 (Map Name) HumanDiffOp Referent TypeReference)
-&gt; TwoWay (DefnsF2 (Map Name) HumanDiffOp Referent TypeReference)
forall (f :: * -&gt; *) a b c d.
Zip f =&gt;
f a -&gt; f b -&gt; f c -&gt; (a -&gt; b -&gt; c -&gt; d) -&gt; f d
</span><a href="#local-6989586621679195209"><span class="hs-identifier hs-var">zipWithF3</span></a></span><span> </span><span class="annot"><span class="annottext">TwoWay (DefnsF (Relation Name) Referent TypeReference)
</span><a href="#local-6989586621679195210"><span class="hs-identifier hs-var">nameRelations</span></a></span><span> </span><span class="annot"><span class="annottext">TwoWay (DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference)
</span><a href="#local-6989586621679195207"><span class="hs-identifier hs-var">diffs</span></a></span><span> </span><span class="annot"><span class="annottext">TwoWay (DefnsF2 (Map Name) Updated Referent TypeReference)
</span><a href="#local-6989586621679195208"><span class="hs-identifier hs-var">propagatedUpdates</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679195211"><span class="annot"><span class="annottext">DefnsF (Relation Name) Referent TypeReference
</span><a href="#local-6989586621679195211"><span class="hs-identifier hs-var">relation</span></a></span></span><span> </span><span id="local-6989586621679195212"><span class="annot"><span class="annottext">DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference
</span><a href="#local-6989586621679195212"><span class="hs-identifier hs-var">diffOps</span></a></span></span><span> </span><span id="local-6989586621679195213"><span class="annot"><span class="annottext">DefnsF2 (Map Name) Updated Referent TypeReference
</span><a href="#local-6989586621679195213"><span class="hs-identifier hs-var">propagatedUpdates</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-132"></span><span>    </span><span class="annot"><span class="annottext">(Relation Name Referent
 -&gt; Relation Name Referent
 -&gt; Map Name (DiffOp (Synhashed Referent))
 -&gt; Map Name (Updated Referent)
 -&gt; Map Name (HumanDiffOp Referent))
-&gt; (Relation Name TypeReference
    -&gt; Relation Name TypeReference
    -&gt; Map Name (DiffOp (Synhashed TypeReference))
    -&gt; Map Name (Updated TypeReference)
    -&gt; Map Name (HumanDiffOp TypeReference))
-&gt; DefnsF (Relation Name) Referent TypeReference
-&gt; DefnsF (Relation Name) Referent TypeReference
-&gt; DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference
-&gt; DefnsF2 (Map Name) Updated Referent TypeReference
-&gt; DefnsF2 (Map Name) HumanDiffOp Referent TypeReference
forall tm1 tm2 tm3 tm4 tm5 ty1 ty2 ty3 ty4 ty5.
(tm1 -&gt; tm2 -&gt; tm3 -&gt; tm4 -&gt; tm5)
-&gt; (ty1 -&gt; ty2 -&gt; ty3 -&gt; ty4 -&gt; ty5)
-&gt; Defns tm1 ty1
-&gt; Defns tm2 ty2
-&gt; Defns tm3 ty3
-&gt; Defns tm4 ty4
-&gt; Defns tm5 ty5
</span><span class="hs-identifier hs-var">Defns.zipDefnsWith4</span></span><span> </span><span class="annot"><span class="annottext">Relation Name Referent
-&gt; Relation Name Referent
-&gt; Map Name (DiffOp (Synhashed Referent))
-&gt; Map Name (Updated Referent)
-&gt; Map Name (HumanDiffOp Referent)
forall ref.
(Show ref, Ord ref) =&gt;
Relation Name ref
-&gt; Relation Name ref
-&gt; Map Name (DiffOp (Synhashed ref))
-&gt; Map Name (Updated ref)
-&gt; Map Name (HumanDiffOp ref)
</span><a href="#local-6989586621679195215"><span class="hs-identifier hs-var">computeHumanDiffOp</span></a></span><span> </span><span class="annot"><span class="annottext">Relation Name TypeReference
-&gt; Relation Name TypeReference
-&gt; Map Name (DiffOp (Synhashed TypeReference))
-&gt; Map Name (Updated TypeReference)
-&gt; Map Name (HumanDiffOp TypeReference)
forall ref.
(Show ref, Ord ref) =&gt;
Relation Name ref
-&gt; Relation Name ref
-&gt; Map Name (DiffOp (Synhashed ref))
-&gt; Map Name (Updated ref)
-&gt; Map Name (HumanDiffOp ref)
</span><a href="#local-6989586621679195215"><span class="hs-identifier hs-var">computeHumanDiffOp</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF (Relation Name) Referent TypeReference
</span><a href="#local-6989586621679195216"><span class="hs-identifier hs-var">lcaRelation</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF (Relation Name) Referent TypeReference
</span><a href="#local-6989586621679195211"><span class="hs-identifier hs-var">relation</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF3 (Map Name) DiffOp Synhashed Referent TypeReference
</span><a href="#local-6989586621679195212"><span class="hs-identifier hs-var">diffOps</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Updated Referent TypeReference
</span><a href="#local-6989586621679195213"><span class="hs-identifier hs-var">propagatedUpdates</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-134"></span><span>    </span><span id="local-6989586621679194973"><span id="local-6989586621679194974"><span id="local-6989586621679194975"><span id="local-6989586621679194976"><span id="local-6989586621679194977"><span class="annot"><a href="#local-6989586621679195209"><span class="hs-identifier hs-type">zipWithF3</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Zip.Zip</span></span><span> </span><span class="annot"><a href="#local-6989586621679194973"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194973"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194974"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194973"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194975"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194973"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194976"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679194974"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194975"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194976"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194977"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194973"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194977"><span class="hs-identifier hs-type">d</span></a></span></span></span></span></span></span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621679195209"><span class="annot"><span class="annottext">zipWithF3 :: forall (f :: * -&gt; *) a b c d.
Zip f =&gt;
f a -&gt; f b -&gt; f c -&gt; (a -&gt; b -&gt; c -&gt; d) -&gt; f d
</span><a href="#local-6989586621679195209"><span class="hs-identifier hs-var hs-var">zipWithF3</span></a></span></span><span> </span><span id="local-6989586621679195220"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679195220"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679195221"><span class="annot"><span class="annottext">f b
</span><a href="#local-6989586621679195221"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679195222"><span class="annot"><span class="annottext">f c
</span><a href="#local-6989586621679195222"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679195223"><span class="annot"><span class="annottext">a -&gt; b -&gt; c -&gt; d
</span><a href="#local-6989586621679195223"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((a, b) -&gt; c -&gt; d) -&gt; f (a, b) -&gt; f c -&gt; f d
forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
forall (f :: * -&gt; *) a b c.
Zip f =&gt;
(a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">Zip.zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679195225"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679195225"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195226"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679195226"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679195227"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679195227"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; c -&gt; d
</span><a href="#local-6989586621679195223"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679195225"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679195226"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679195227"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f a -&gt; f b -&gt; f (a, b)
forall a b. f a -&gt; f b -&gt; f (a, b)
forall (f :: * -&gt; *) a b. Zip f =&gt; f a -&gt; f b -&gt; f (a, b)
</span><span class="hs-identifier hs-var">Zip.zip</span></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679195220"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">f b
</span><a href="#local-6989586621679195221"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f c
</span><a href="#local-6989586621679195222"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><a href="#local-6989586621679195229"><span class="hs-identifier hs-type">namesToRelations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Relation</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>    </span><span id="local-6989586621679195229"><span class="annot"><span class="annottext">namesToRelations :: Names -&gt; DefnsF (Relation Name) Referent TypeReference
</span><a href="#local-6989586621679195229"><span class="hs-identifier hs-var hs-var">namesToRelations</span></a></span></span><span> </span><span id="local-6989586621679195230"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679195230"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:terms:Defns :: Relation Name Referent
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Relation Name Referent
</span><span class="hs-identifier hs-var">Names.terms</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679195230"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:types:Defns :: Relation Name TypeReference
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Relation Name TypeReference
</span><span class="hs-identifier hs-var">Names.types</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621679195230"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><a href="#local-6989586621679195216"><span class="hs-identifier hs-type">lcaRelation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Relation</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span>
</span><span id="line-141"></span><span>    </span><span id="local-6989586621679195216"><span class="annot"><span class="annottext">lcaRelation :: DefnsF (Relation Name) Referent TypeReference
</span><a href="#local-6989586621679195216"><span class="hs-identifier hs-var hs-var">lcaRelation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; DefnsF (Relation Name) Referent TypeReference
</span><a href="#local-6989586621679195229"><span class="hs-identifier hs-var">namesToRelations</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay Names
</span><a href="#local-6989586621679195206"><span class="hs-identifier hs-var">names3</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><a href="#local-6989586621679195210"><span class="hs-identifier hs-type">nameRelations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Relation</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621679195210"><span class="annot"><span class="annottext">nameRelations :: TwoWay (DefnsF (Relation Name) Referent TypeReference)
</span><a href="#local-6989586621679195210"><span class="hs-identifier hs-var hs-var">nameRelations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; DefnsF (Relation Name) Referent TypeReference
</span><a href="#local-6989586621679195229"><span class="hs-identifier hs-var">namesToRelations</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; DefnsF (Relation Name) Referent TypeReference)
-&gt; TwoWay Names
-&gt; TwoWay (DefnsF (Relation Name) Referent TypeReference)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ThreeWay Names -&gt; TwoWay Names
forall a. ThreeWay a -&gt; TwoWay a
</span><a href="Unison.Merge.ThreeWay.html#forgetLca"><span class="hs-identifier hs-var">ThreeWay.forgetLca</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay Names
</span><a href="#local-6989586621679195206"><span class="hs-identifier hs-var">names3</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><a href="#local-6989586621679195215"><span class="hs-identifier hs-type">computeHumanDiffOp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679194988"><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Relation</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Relation</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp"><span class="hs-identifier hs-type">HumanDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>    </span><span id="local-6989586621679195215"><span class="annot"><span class="annottext">computeHumanDiffOp :: forall ref.
(Show ref, Ord ref) =&gt;
Relation Name ref
-&gt; Relation Name ref
-&gt; Map Name (DiffOp (Synhashed ref))
-&gt; Map Name (Updated ref)
-&gt; Map Name (HumanDiffOp ref)
</span><a href="#local-6989586621679195215"><span class="hs-identifier hs-var hs-var">computeHumanDiffOp</span></a></span></span><span> </span><span id="local-6989586621679195259"><span class="annot"><span class="annottext">Relation Name ref
</span><a href="#local-6989586621679195259"><span class="hs-identifier hs-var">oldRelation</span></a></span></span><span> </span><span id="local-6989586621679195260"><span class="annot"><span class="annottext">Relation Name ref
</span><a href="#local-6989586621679195260"><span class="hs-identifier hs-var">newRelation</span></a></span></span><span> </span><span id="local-6989586621679195261"><span class="annot"><span class="annottext">Map Name (DiffOp (Synhashed ref))
</span><a href="#local-6989586621679195261"><span class="hs-identifier hs-var">diffs</span></a></span></span><span> </span><span id="local-6989586621679195262"><span class="annot"><span class="annottext">Map Name (Updated ref)
</span><a href="#local-6989586621679195262"><span class="hs-identifier hs-var">propagatedUpdates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(These (DiffOp (Synhashed ref)) (Updated ref) -&gt; HumanDiffOp ref)
-&gt; Map Name (DiffOp (Synhashed ref))
-&gt; Map Name (Updated ref)
-&gt; Map Name (HumanDiffOp ref)
forall a b c.
(These a b -&gt; c) -&gt; Map Name a -&gt; Map Name b -&gt; Map Name c
forall (f :: * -&gt; *) a b c.
Semialign f =&gt;
(These a b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">alignWith</span></span><span> </span><span class="annot"><span class="annottext">These (DiffOp (Synhashed ref)) (Updated ref) -&gt; HumanDiffOp ref
</span><a href="#local-6989586621679195263"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (DiffOp (Synhashed ref))
</span><a href="#local-6989586621679195261"><span class="hs-identifier hs-var">diffs</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (Updated ref)
</span><a href="#local-6989586621679195262"><span class="hs-identifier hs-var">propagatedUpdates</span></a></span><span>
</span><span id="line-155"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><a href="#local-6989586621679195263"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp"><span class="hs-identifier hs-type">HumanDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>        </span><span id="local-6989586621679195263"><span class="annot"><span class="annottext">go :: These (DiffOp (Synhashed ref)) (Updated ref) -&gt; HumanDiffOp ref
</span><a href="#local-6989586621679195263"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-158"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">This</span></span><span> </span><span id="local-6989586621679195264"><span class="annot"><span class="annottext">DiffOp (Synhashed ref)
</span><a href="#local-6989586621679195264"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiffOp ref -&gt; HumanDiffOp ref
</span><a href="#local-6989586621679195265"><span class="hs-identifier hs-var">humanizeDiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Synhashed ref -&gt; ref
forall a. Synhashed a -&gt; a
</span><a href="Unison.Merge.Synhashed.html#%24sel%3Avalue%3ASynhashed"><span class="hs-identifier hs-var">Synhashed.value</span></a></span><span> </span><span class="annot"><span class="annottext">(Synhashed ref -&gt; ref) -&gt; DiffOp (Synhashed ref) -&gt; DiffOp ref
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DiffOp (Synhashed ref)
</span><a href="#local-6989586621679195264"><span class="hs-identifier hs-var">diff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">That</span></span><span> </span><span id="local-6989586621679195266"><span class="annot"><span class="annottext">Updated ref
</span><a href="#local-6989586621679195266"><span class="hs-identifier hs-var">updated</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Updated ref -&gt; HumanDiffOp ref
forall ref. Updated ref -&gt; HumanDiffOp ref
</span><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp%27PropagatedUpdate"><span class="hs-identifier hs-var">HumanDiffOp'PropagatedUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Updated ref
</span><a href="#local-6989586621679195266"><span class="hs-identifier hs-var">updated</span></a></span><span>
</span><span id="line-160"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span id="local-6989586621679195268"><span class="annot"><span class="annottext">DiffOp (Synhashed ref)
</span><a href="#local-6989586621679195268"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span id="local-6989586621679195269"><span class="annot"><span class="annottext">Updated ref
</span><a href="#local-6989586621679195269"><span class="hs-identifier hs-var">updated</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; HumanDiffOp ref
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E488729&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;The impossible happened, an update in merge was detected as both a propagated AND core update &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DiffOp (Synhashed ref) -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DiffOp (Synhashed ref)
</span><a href="#local-6989586621679195268"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; and &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Updated ref -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Updated ref
</span><a href="#local-6989586621679195269"><span class="hs-identifier hs-var">updated</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><a href="#local-6989586621679195265"><span class="hs-identifier hs-type">humanizeDiffOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp"><span class="hs-identifier hs-type">HumanDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194988"><span class="hs-identifier hs-type">ref</span></a></span><span>
</span><span id="line-163"></span><span>        </span><span id="local-6989586621679195265"><span class="annot"><span class="annottext">humanizeDiffOp :: DiffOp ref -&gt; HumanDiffOp ref
</span><a href="#local-6989586621679195265"><span class="hs-identifier hs-var hs-var">humanizeDiffOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-164"></span><span>          </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp%27Add"><span class="hs-identifier hs-type">DiffOp'Add</span></a></span><span> </span><span id="local-6989586621679195273"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-165"></span><span>            </span><span class="hs-comment">-- This name is newly added. We need to check if it's a new definition, an alias, or a rename.</span><span>
</span><span id="line-166"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; [Name]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ref -&gt; Relation Name ref -&gt; Set Name
forall b a. Ord b =&gt; b -&gt; Relation a b -&gt; Set a
</span><span class="hs-identifier hs-var">Rel.lookupRan</span></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Relation Name ref
</span><a href="#local-6989586621679195259"><span class="hs-identifier hs-var">oldRelation</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-167"></span><span>              </span><span class="hs-comment">-- No old names for this ref, so it's a new addition not an alias</span><span>
</span><span id="line-168"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref -&gt; HumanDiffOp ref
forall ref. ref -&gt; HumanDiffOp ref
</span><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp%27Add"><span class="hs-identifier hs-var">HumanDiffOp'Add</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-169"></span><span>              </span><span class="hs-comment">-- There are old names for this ref, but not old refs for this name, so it's</span><span>
</span><span id="line-170"></span><span>              </span><span class="hs-comment">-- either a new alias or a rename.</span><span>
</span><span id="line-171"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-172"></span><span>              </span><span class="hs-comment">-- If at least one old name for this ref no longer exists, we treat it like a</span><span>
</span><span id="line-173"></span><span>              </span><span class="hs-comment">-- rename.</span><span>
</span><span id="line-174"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621679195277"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195277"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679195278"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679195278"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195279"><span class="annot"><span class="annottext">existingNames :: NESet Name
</span><a href="#local-6989586621679195279"><span class="hs-identifier hs-var hs-var">existingNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty Name -&gt; NESet Name
forall a. Ord a =&gt; NonEmpty a -&gt; NESet a
</span><span class="hs-identifier hs-var">NESet.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195277"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Name] -&gt; NonEmpty Name
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">NEList.:|</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679195278"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Maybe (NESet Name)
forall a. Set a -&gt; Maybe (NESet a)
</span><span class="hs-identifier hs-var">NESet.nonEmptySet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ref -&gt; Relation Name ref -&gt; Set Name
forall b a. Ord b =&gt; b -&gt; Relation a b -&gt; Set a
</span><span class="hs-identifier hs-var">Rel.lookupRan</span></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Relation Name ref
</span><a href="#local-6989586621679195260"><span class="hs-identifier hs-var">newRelation</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-177"></span><span>                  </span><span class="annot"><span class="annottext">Maybe (NESet Name)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; HumanDiffOp ref
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E458329&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected to find at least one name for ref in new namespace, since we found the ref by the name.&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195283"><span class="annot"><span class="annottext">NESet Name
</span><a href="#local-6989586621679195283"><span class="hs-identifier hs-var">allNewNames</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Maybe (NESet Name)
forall a. Set a -&gt; Maybe (NESet a)
</span><span class="hs-identifier hs-var">NESet.nonEmptySet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NESet Name -&gt; NESet Name -&gt; Set Name
forall a. Ord a =&gt; NESet a -&gt; NESet a -&gt; Set a
</span><span class="hs-identifier hs-var">NESet.difference</span></span><span> </span><span class="annot"><span class="annottext">NESet Name
</span><a href="#local-6989586621679195279"><span class="hs-identifier hs-var">existingNames</span></a></span><span> </span><span class="annot"><span class="annottext">NESet Name
</span><a href="#local-6989586621679195283"><span class="hs-identifier hs-var">allNewNames</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-180"></span><span>                      </span><span class="hs-comment">-- If all the old names still exist in the new namespace, it's a new alias.</span><span>
</span><span id="line-181"></span><span>                      </span><span class="annot"><span class="annottext">Maybe (NESet Name)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref -&gt; NESet Name -&gt; HumanDiffOp ref
forall ref. ref -&gt; NESet Name -&gt; HumanDiffOp ref
</span><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp%27AliasOf"><span class="hs-identifier hs-var">HumanDiffOp'AliasOf</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">NESet Name
</span><a href="#local-6989586621679195279"><span class="hs-identifier hs-var">existingNames</span></a></span><span>
</span><span id="line-182"></span><span>                      </span><span class="hs-comment">-- Otherwise, treat it as a rename.</span><span>
</span><span id="line-183"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195286"><span class="annot"><span class="annottext">NESet Name
</span><a href="#local-6989586621679195286"><span class="hs-identifier hs-var">namesWhichDisappeared</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-184"></span><span>                        </span><span class="annot"><span class="annottext">ref -&gt; NESet Name -&gt; HumanDiffOp ref
forall ref. ref -&gt; NESet Name -&gt; HumanDiffOp ref
</span><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp%27RenamedFrom"><span class="hs-identifier hs-var">HumanDiffOp'RenamedFrom</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">NESet Name
</span><a href="#local-6989586621679195286"><span class="hs-identifier hs-var">namesWhichDisappeared</span></a></span><span>
</span><span id="line-185"></span><span>          </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp%27Delete"><span class="hs-identifier hs-type">DiffOp'Delete</span></a></span><span> </span><span id="local-6989586621679195288"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195288"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Maybe (NonEmpty Name)
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">NEL.nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; Maybe (NonEmpty Name))
-&gt; [Name] -&gt; Maybe (NonEmpty Name)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; [Name]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ref -&gt; Relation Name ref -&gt; Set Name
forall b a. Ord b =&gt; b -&gt; Relation a b -&gt; Set a
</span><span class="hs-identifier hs-var">Rel.lookupRan</span></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195288"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Relation Name ref
</span><a href="#local-6989586621679195260"><span class="hs-identifier hs-var">newRelation</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-187"></span><span>              </span><span class="hs-comment">-- No names for this ref, it was removed.</span><span>
</span><span id="line-188"></span><span>              </span><span class="annot"><span class="annottext">Maybe (NonEmpty Name)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref -&gt; HumanDiffOp ref
forall ref. ref -&gt; HumanDiffOp ref
</span><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp%27Delete"><span class="hs-identifier hs-var">HumanDiffOp'Delete</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195288"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-189"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195291"><span class="annot"><span class="annottext">NonEmpty Name
</span><a href="#local-6989586621679195291"><span class="hs-identifier hs-var">newNames</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref -&gt; NESet Name -&gt; HumanDiffOp ref
forall ref. ref -&gt; NESet Name -&gt; HumanDiffOp ref
</span><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp%27RenamedTo"><span class="hs-identifier hs-var">HumanDiffOp'RenamedTo</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679195288"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty Name -&gt; NESet Name
forall a. Ord a =&gt; NonEmpty a -&gt; NESet a
</span><span class="hs-identifier hs-var">NESet.fromList</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty Name
</span><a href="#local-6989586621679195291"><span class="hs-identifier hs-var">newNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>          </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp%27Update"><span class="hs-identifier hs-type">DiffOp'Update</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679195293"><span class="annot"><span class="annottext">ref
$sel:old:Updated :: forall a. Updated a -&gt; a
old :: ref
</span><a href="Unison.Merge.Updated.html#%24sel%3Aold%3AUpdated"><span class="hs-identifier hs-var hs-var">old</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195294"><span class="annot"><span class="annottext">ref
$sel:new:Updated :: forall a. Updated a -&gt; a
new :: ref
</span><a href="Unison.Merge.Updated.html#%24sel%3Anew%3AUpdated"><span class="hs-identifier hs-var hs-var">new</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Updated ref -&gt; HumanDiffOp ref
forall ref. Updated ref -&gt; HumanDiffOp ref
</span><a href="Unison.Merge.HumanDiffOp.html#HumanDiffOp%27Update"><span class="hs-identifier hs-var">HumanDiffOp'Update</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ref
$sel:old:Updated :: ref
old :: ref
</span><a href="Unison.Merge.Updated.html#%24sel%3Aold%3AUpdated"><span class="hs-identifier hs-var hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ref
$sel:new:Updated :: ref
new :: ref
</span><a href="Unison.Merge.Updated.html#%24sel%3Anew%3AUpdated"><span class="hs-identifier hs-var hs-var">new</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- Syntactic hashing</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="annot"><a href="Unison.Merge.Diff.html#synhashLcaDefns"><span class="hs-identifier hs-type">synhashLcaDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PrettyPrintEnv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="Unison.Merge.PartialDeclNameLookup.html#PartialDeclNameLookup"><span class="hs-identifier hs-type">PartialDeclNameLookup</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span>
</span><span id="line-202"></span><span id="synhashLcaDefns"><span class="annot"><span class="annottext">synhashLcaDefns :: HasCallStack =&gt;
PrettyPrintEnv
-&gt; PartialDeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="Unison.Merge.Diff.html#synhashLcaDefns"><span class="hs-identifier hs-var hs-var">synhashLcaDefns</span></a></span></span><span> </span><span id="local-6989586621679195316"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195316"><span class="hs-identifier hs-var">ppe</span></a></span></span><span> </span><span id="local-6989586621679195317"><span class="annot"><span class="annottext">PartialDeclNameLookup
</span><a href="#local-6989586621679195317"><span class="hs-identifier hs-var">declNameLookup</span></a></span></span><span> </span><span id="local-6989586621679195318"><span class="annot"><span class="annottext">Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
</span><a href="#local-6989586621679195318"><span class="hs-identifier hs-var">defns</span></a></span></span><span> </span><span id="local-6989586621679195319"><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195319"><span class="hs-identifier hs-var">hydratedDefns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><span class="annottext">(Name -&gt; Referent -&gt; Hash)
-&gt; (Name -&gt; TypeReference -&gt; Hash)
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
forall term typ.
HasCallStack =&gt;
(Name -&gt; term -&gt; Hash)
-&gt; (Name -&gt; typ -&gt; Hash)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
-&gt; DefnsF2 (Map Name) Synhashed term typ
</span><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-var">synhashDefnsWith</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Referent -&gt; Hash
</span><a href="#local-6989586621679195321"><span class="hs-identifier hs-var">hashReferent</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TypeReference -&gt; Hash
</span><a href="#local-6989586621679195322"><span class="hs-identifier hs-var">hashType</span></a></span><span> </span><span class="annot"><span class="annottext">Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
</span><a href="#local-6989586621679195318"><span class="hs-identifier hs-var">defns</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-comment">-- For the LCA only, if we don't have a name for every constructor, or we don't have a name for a decl, that's okay,</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-comment">-- just use a dummy syntactic hash (e.g. where we return `Hash mempty` below in two places).</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- This is safe and correct; Alice/Bob can't have such a decl (it violates a merge precondition), so there's no risk</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- that we accidentally get an equal hash and classify a real update as unchanged.</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="#local-6989586621679195321"><span class="hs-identifier hs-type">hashReferent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-212"></span><span>    </span><span id="local-6989586621679195321"><span class="annot"><span class="annottext">hashReferent :: Name -&gt; Referent -&gt; Hash
</span><a href="#local-6989586621679195321"><span class="hs-identifier hs-var hs-var">hashReferent</span></a></span></span><span> </span><span id="local-6989586621679195323"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195323"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-213"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Referent.Con</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference</span></span><span> </span><span id="local-6989586621679195326"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195326"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Map Name Name -&gt; Maybe Name
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195323"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PartialDeclNameLookup
</span><a href="#local-6989586621679195317"><span class="hs-identifier hs-var">declNameLookup</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">constructorToDecl</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-215"></span><span>          </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ShortByteString -&gt; Hash
</span><span class="hs-identifier hs-var">Hash</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-comment">-- see note above</span><span>
</span><span id="line-216"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195328"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195328"><span class="hs-identifier hs-var">declName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TypeReference -&gt; Hash
</span><a href="#local-6989586621679195322"><span class="hs-identifier hs-var">hashType</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195328"><span class="hs-identifier hs-var">declName</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195326"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-217"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Referent.Ref</span></span><span> </span><span id="local-6989586621679195330"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195330"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
PrettyPrintEnv
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; TypeReference -&gt; Hash
PrettyPrintEnv
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; TypeReference -&gt; Hash
</span><a href="Unison.Merge.Diff.html#synhashTermReference"><span class="hs-identifier hs-var">synhashTermReference</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195316"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195319"><span class="hs-identifier hs-var">hydratedDefns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">terms</span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195330"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><a href="#local-6989586621679195322"><span class="hs-identifier hs-type">hashType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621679195322"><span class="annot"><span class="annottext">hashType :: Name -&gt; TypeReference -&gt; Hash
</span><a href="#local-6989586621679195322"><span class="hs-identifier hs-var hs-var">hashType</span></a></span></span><span> </span><span id="local-6989586621679195332"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195332"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ReferenceBuiltin</span></span><span> </span><span id="local-6989586621679195334"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679195334"><span class="hs-identifier hs-var">builtin</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashBuiltinDecl"><span class="hs-identifier hs-var">Synhash.synhashBuiltinDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679195334"><span class="hs-identifier hs-var">builtin</span></a></span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ReferenceDerived</span></span><span> </span><span id="local-6989586621679195337"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195337"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Maybe Name] -&gt; Maybe [Name]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
forall (m :: * -&gt; *) a. Monad m =&gt; [m a] -&gt; m [a]
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PartialDeclNameLookup
</span><a href="#local-6989586621679195317"><span class="hs-identifier hs-var">declNameLookup</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">declToConstructors</span><span> </span><span class="annot"><span class="annottext">Map Name [Maybe Name] -&gt; Name -&gt; [Maybe Name]
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">Map.!</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195332"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-224"></span><span>          </span><span class="annot"><span class="annottext">Maybe [Name]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ShortByteString -&gt; Hash
</span><span class="hs-identifier hs-var">Hash</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-comment">-- see note above</span><span>
</span><span id="line-225"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195340"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679195340"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
PrettyPrintEnv
-&gt; Map TermReferenceId (Decl Symbol Ann)
-&gt; [Name]
-&gt; Name
-&gt; TermReferenceId
-&gt; Hash
PrettyPrintEnv
-&gt; Map TermReferenceId (Decl Symbol Ann)
-&gt; [Name]
-&gt; Name
-&gt; TermReferenceId
-&gt; Hash
</span><a href="Unison.Merge.Diff.html#synhashDerivedDecl"><span class="hs-identifier hs-var">synhashDerivedDecl</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195316"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195319"><span class="hs-identifier hs-var">hydratedDefns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">types</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679195340"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195332"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195337"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="annot"><a href="Unison.Merge.Diff.html#synhashDefns"><span class="hs-identifier hs-type">synhashDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PrettyPrintEnv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DeclNameLookup</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span>
</span><span id="line-234"></span><span id="synhashDefns"><span class="annot"><span class="annottext">synhashDefns :: HasCallStack =&gt;
PrettyPrintEnv
-&gt; Defns
     (Map TermReferenceId (Term Symbol Ann))
     (Map TermReferenceId (Decl Symbol Ann))
-&gt; DeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
</span><a href="Unison.Merge.Diff.html#synhashDefns"><span class="hs-identifier hs-var hs-var">synhashDefns</span></a></span></span><span> </span><span id="local-6989586621679195355"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195355"><span class="hs-identifier hs-var">ppe</span></a></span></span><span> </span><span id="local-6989586621679195356"><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195356"><span class="hs-identifier hs-var">hydratedDefns</span></a></span></span><span> </span><span id="local-6989586621679195357"><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621679195357"><span class="hs-identifier hs-var">declNameLookup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><span class="annottext">(Name -&gt; Referent -&gt; Hash)
-&gt; (Name -&gt; TypeReference -&gt; Hash)
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; DefnsF2 (Map Name) Synhashed Referent TypeReference
forall term typ.
HasCallStack =&gt;
(Name -&gt; term -&gt; Hash)
-&gt; (Name -&gt; typ -&gt; Hash)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
-&gt; DefnsF2 (Map Name) Synhashed term typ
</span><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-var">synhashDefnsWith</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Referent -&gt; Hash
</span><a href="#local-6989586621679195358"><span class="hs-identifier hs-var">hashReferent</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TypeReference -&gt; Hash
</span><a href="#local-6989586621679195359"><span class="hs-identifier hs-var">hashType</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><a href="#local-6989586621679195358"><span class="hs-identifier hs-type">hashReferent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-238"></span><span>    </span><span id="local-6989586621679195358"><span class="annot"><span class="annottext">hashReferent :: Name -&gt; Referent -&gt; Hash
</span><a href="#local-6989586621679195358"><span class="hs-identifier hs-var hs-var">hashReferent</span></a></span></span><span> </span><span id="local-6989586621679195360"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195360"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-comment">-- We say that a referent constructor *in the namespace* (distinct from a referent that is in a term body) has a</span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-comment">-- synhash that is simply equal to the synhash of its type declaration. This is because the type declaration and</span><span>
</span><span id="line-241"></span><span>      </span><span class="hs-comment">-- constructors are changed in lock-step: it is not possible to change one, but not the other.</span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-comment">-- For example, if Alice updates `type Foo = Bar Nat` to `type Foo = Bar Nat Nat`, we want different synhashes on</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-comment">-- both the type (Foo) and the constructor (Foo.Bar).</span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Referent.Con</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference</span></span><span> </span><span id="local-6989586621679195361"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195361"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TypeReference -&gt; Hash
</span><a href="#local-6989586621679195359"><span class="hs-identifier hs-var">hashType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; DeclNameLookup -&gt; Name -&gt; Name
DeclNameLookup -&gt; Name -&gt; Name
</span><span class="hs-identifier hs-var">DeclNameLookup.expectDeclName</span></span><span> </span><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621679195357"><span class="hs-identifier hs-var">declNameLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195360"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195361"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-246"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Referent.Ref</span></span><span> </span><span id="local-6989586621679195363"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195363"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
PrettyPrintEnv
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; TypeReference -&gt; Hash
PrettyPrintEnv
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; TypeReference -&gt; Hash
</span><a href="Unison.Merge.Diff.html#synhashTermReference"><span class="hs-identifier hs-var">synhashTermReference</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195355"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195356"><span class="hs-identifier hs-var">hydratedDefns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">terms</span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621679195363"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><a href="#local-6989586621679195359"><span class="hs-identifier hs-type">hashType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-249"></span><span>    </span><span id="local-6989586621679195359"><span class="annot"><span class="annottext">hashType :: Name -&gt; TypeReference -&gt; Hash
</span><a href="#local-6989586621679195359"><span class="hs-identifier hs-var hs-var">hashType</span></a></span></span><span> </span><span id="local-6989586621679195364"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195364"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-250"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ReferenceBuiltin</span></span><span> </span><span id="local-6989586621679195365"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679195365"><span class="hs-identifier hs-var">builtin</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashBuiltinDecl"><span class="hs-identifier hs-var">Synhash.synhashBuiltinDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679195365"><span class="hs-identifier hs-var">builtin</span></a></span><span>
</span><span id="line-251"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ReferenceDerived</span></span><span> </span><span id="local-6989586621679195366"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195366"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
PrettyPrintEnv
-&gt; Map TermReferenceId (Decl Symbol Ann)
-&gt; [Name]
-&gt; Name
-&gt; TermReferenceId
-&gt; Hash
PrettyPrintEnv
-&gt; Map TermReferenceId (Decl Symbol Ann)
-&gt; [Name]
-&gt; Name
-&gt; TermReferenceId
-&gt; Hash
</span><a href="Unison.Merge.Diff.html#synhashDerivedDecl"><span class="hs-identifier hs-var">synhashDerivedDecl</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195355"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">Defns
  (Map TermReferenceId (Term Symbol Ann))
  (Map TermReferenceId (Decl Symbol Ann))
</span><a href="#local-6989586621679195356"><span class="hs-identifier hs-var">hydratedDefns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">types</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; DeclNameLookup -&gt; Name -&gt; [Name]
DeclNameLookup -&gt; Name -&gt; [Name]
</span><span class="hs-identifier hs-var">DeclNameLookup.expectConstructorNames</span></span><span> </span><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621679195357"><span class="hs-identifier hs-var">declNameLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195364"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195364"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195366"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="annot"><a href="Unison.Merge.Diff.html#synhashDerivedDecl"><span class="hs-identifier hs-type">synhashDerivedDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PrettyPrintEnv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-262"></span><span id="synhashDerivedDecl"><span class="annot"><span class="annottext">synhashDerivedDecl :: HasCallStack =&gt;
PrettyPrintEnv
-&gt; Map TermReferenceId (Decl Symbol Ann)
-&gt; [Name]
-&gt; Name
-&gt; TermReferenceId
-&gt; Hash
</span><a href="Unison.Merge.Diff.html#synhashDerivedDecl"><span class="hs-identifier hs-var hs-var">synhashDerivedDecl</span></a></span></span><span> </span><span id="local-6989586621679195374"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195374"><span class="hs-identifier hs-var">ppe</span></a></span></span><span> </span><span id="local-6989586621679195375"><span class="annot"><span class="annottext">Map TermReferenceId (Decl Symbol Ann)
</span><a href="#local-6989586621679195375"><span class="hs-identifier hs-var">declsById</span></a></span></span><span> </span><span id="local-6989586621679195376"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679195376"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621679195377"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195377"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679195378"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195378"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><span class="annottext">Map TermReferenceId (Decl Symbol Ann)
</span><a href="#local-6989586621679195375"><span class="hs-identifier hs-var">declsById</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">Map TermReferenceId (Decl Symbol Ann)
-&gt; (Map TermReferenceId (Decl Symbol Ann) -&gt; Decl Symbol Ann)
-&gt; Decl Symbol Ann
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
TermReferenceId
-&gt; Map TermReferenceId (Decl Symbol Ann) -&gt; Decl Symbol Ann
TermReferenceId
-&gt; Map TermReferenceId (Decl Symbol Ann) -&gt; Decl Symbol Ann
</span><a href="Unison.Merge.Diff.html#expectDecl"><span class="hs-identifier hs-var">expectDecl</span></a></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195378"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">Decl Symbol Ann
-&gt; (Decl Symbol Ann -&gt; Decl Symbol Ann) -&gt; Decl Symbol Ann
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Symbol] -&gt; Decl Symbol Ann -&gt; Decl Symbol Ann
forall v a. [v] -&gt; Decl v a -&gt; Decl v a
</span><span class="hs-identifier hs-var">DataDeclaration.setConstructorNames</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Symbol) -&gt; [Name] -&gt; [Symbol]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Symbol
forall v. Var v =&gt; Name -&gt; v
</span><span class="hs-identifier hs-var">Name.toVar</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679195376"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">Decl Symbol Ann -&gt; (Decl Symbol Ann -&gt; Hash) -&gt; Hash
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv -&gt; Name -&gt; Decl Symbol Ann -&gt; Hash
forall v a. Var v =&gt; PrettyPrintEnv -&gt; Name -&gt; Decl v a -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashDerivedDecl"><span class="hs-identifier hs-var">Synhash.synhashDerivedDecl</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195374"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195377"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="annot"><a href="Unison.Merge.Diff.html#synhashTermReference"><span class="hs-identifier hs-type">synhashTermReference</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PrettyPrintEnv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-269"></span><span id="synhashTermReference"><span class="annot"><span class="annottext">synhashTermReference :: HasCallStack =&gt;
PrettyPrintEnv
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; TypeReference -&gt; Hash
</span><a href="Unison.Merge.Diff.html#synhashTermReference"><span class="hs-identifier hs-var hs-var">synhashTermReference</span></a></span></span><span> </span><span id="local-6989586621679195387"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">ppe</span></a></span></span><span> </span><span id="local-6989586621679195388"><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
</span><a href="#local-6989586621679195388"><span class="hs-identifier hs-var">termsById</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ReferenceBuiltin</span></span><span> </span><span id="local-6989586621679195389"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679195389"><span class="hs-identifier hs-var">builtin</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashBuiltinTerm"><span class="hs-identifier hs-var">Synhash.synhashBuiltinTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679195389"><span class="hs-identifier hs-var">builtin</span></a></span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ReferenceDerived</span></span><span> </span><span id="local-6989586621679195391"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195391"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv -&gt; Term Symbol Ann -&gt; Hash
forall v a. Var v =&gt; PrettyPrintEnv -&gt; Term v a -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashDerivedTerm"><span class="hs-identifier hs-var">Synhash.synhashDerivedTerm</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt;
TermReferenceId
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; Term Symbol Ann
TermReferenceId
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; Term Symbol Ann
</span><a href="Unison.Merge.Diff.html#expectTerm"><span class="hs-identifier hs-var">expectTerm</span></a></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195391"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
</span><a href="#local-6989586621679195388"><span class="hs-identifier hs-var">termsById</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span id="local-6989586621679195029"><span id="local-6989586621679195030"><span class="annot"><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-type">synhashDefnsWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679195029"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679195030"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-277"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><a href="#local-6989586621679195029"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><a href="#local-6989586621679195030"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679195029"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679195030"><span class="hs-identifier hs-type">typ</span></a></span></span></span><span>
</span><span id="line-279"></span><span id="synhashDefnsWith"><span class="annot"><span class="annottext">synhashDefnsWith :: forall term typ.
HasCallStack =&gt;
(Name -&gt; term -&gt; Hash)
-&gt; (Name -&gt; typ -&gt; Hash)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
-&gt; DefnsF2 (Map Name) Synhashed term typ
</span><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-var hs-var">synhashDefnsWith</span></a></span></span><span> </span><span id="local-6989586621679195397"><span class="annot"><span class="annottext">Name -&gt; term -&gt; Hash
</span><a href="#local-6989586621679195397"><span class="hs-identifier hs-var">hashTerm</span></a></span></span><span> </span><span id="local-6989586621679195398"><span class="annot"><span class="annottext">Name -&gt; typ -&gt; Hash
</span><a href="#local-6989586621679195398"><span class="hs-identifier hs-var">hashType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="annottext">(BiMultimap term Name -&gt; Map Name (Synhashed term))
-&gt; (BiMultimap typ Name -&gt; Map Name (Synhashed typ))
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
-&gt; DefnsF2 (Map Name) Synhashed term typ
forall a b c d. (a -&gt; b) -&gt; (c -&gt; d) -&gt; Defns a c -&gt; Defns b d
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; term -&gt; Synhashed term)
-&gt; Map Name term -&gt; Map Name (Synhashed term)
forall k a b. (k -&gt; a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.mapWithKey</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; term -&gt; Synhashed term
</span><a href="#local-6989586621679195401"><span class="hs-identifier hs-var">hashTerm1</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name term -&gt; Map Name (Synhashed term))
-&gt; (BiMultimap term Name -&gt; Map Name term)
-&gt; BiMultimap term Name
-&gt; Map Name (Synhashed term)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BiMultimap term Name -&gt; Map Name term
forall a b. BiMultimap a b -&gt; Map b a
</span><span class="hs-identifier hs-var">BiMultimap.range</span></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; typ -&gt; Synhashed typ)
-&gt; Map Name typ -&gt; Map Name (Synhashed typ)
forall k a b. (k -&gt; a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.mapWithKey</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; typ -&gt; Synhashed typ
</span><a href="#local-6989586621679195403"><span class="hs-identifier hs-var">hashType1</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name typ -&gt; Map Name (Synhashed typ))
-&gt; (BiMultimap typ Name -&gt; Map Name typ)
-&gt; BiMultimap typ Name
-&gt; Map Name (Synhashed typ)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BiMultimap typ Name -&gt; Map Name typ
forall a b. BiMultimap a b -&gt; Map b a
</span><span class="hs-identifier hs-var">BiMultimap.range</span></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621679195401"><span class="annot"><span class="annottext">hashTerm1 :: Name -&gt; term -&gt; Synhashed term
</span><a href="#local-6989586621679195401"><span class="hs-identifier hs-var hs-var">hashTerm1</span></a></span></span><span> </span><span id="local-6989586621679195404"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195404"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679195405"><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621679195405"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">Hash -&gt; term -&gt; Synhashed term
forall a. Hash -&gt; a -&gt; Synhashed a
</span><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-var">Synhashed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; term -&gt; Hash
</span><a href="#local-6989586621679195397"><span class="hs-identifier hs-var">hashTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195404"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621679195405"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621679195405"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621679195403"><span class="annot"><span class="annottext">hashType1 :: Name -&gt; typ -&gt; Synhashed typ
</span><a href="#local-6989586621679195403"><span class="hs-identifier hs-var hs-var">hashType1</span></a></span></span><span> </span><span id="local-6989586621679195407"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195407"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679195408"><span class="annot"><span class="annottext">typ
</span><a href="#local-6989586621679195408"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">Hash -&gt; typ -&gt; Synhashed typ
forall a. Hash -&gt; a -&gt; Synhashed a
</span><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-var">Synhashed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; typ -&gt; Hash
</span><a href="#local-6989586621679195398"><span class="hs-identifier hs-var">hashType</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679195407"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">typ
</span><a href="#local-6989586621679195408"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">typ
</span><a href="#local-6989586621679195408"><span class="hs-identifier hs-var">typ</span></a></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- Looking up terms and decls that we expect to be there</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="annot"><a href="Unison.Merge.Diff.html#expectTerm"><span class="hs-identifier hs-type">expectTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span>
</span><span id="line-294"></span><span id="expectTerm"><span class="annot"><span class="annottext">expectTerm :: HasCallStack =&gt;
TermReferenceId
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; Term Symbol Ann
</span><a href="Unison.Merge.Diff.html#expectTerm"><span class="hs-identifier hs-var hs-var">expectTerm</span></a></span></span><span> </span><span id="local-6989586621679195426"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195426"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621679195427"><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
</span><a href="#local-6989586621679195427"><span class="hs-identifier hs-var">termsById</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TermReferenceId
-&gt; Map TermReferenceId (Term Symbol Ann) -&gt; Maybe (Term Symbol Ann)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195426"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
</span><a href="#local-6989586621679195427"><span class="hs-identifier hs-var">termsById</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Term Symbol Ann
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E488229&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;term ref &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195426"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; not found in map &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann) -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Term Symbol Ann)
</span><a href="#local-6989586621679195427"><span class="hs-identifier hs-var">termsById</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195428"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679195428"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621679195428"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="annot"><a href="Unison.Merge.Diff.html#expectDecl"><span class="hs-identifier hs-type">expectDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span>
</span><span id="line-300"></span><span id="expectDecl"><span class="annot"><span class="annottext">expectDecl :: HasCallStack =&gt;
TermReferenceId
-&gt; Map TermReferenceId (Decl Symbol Ann) -&gt; Decl Symbol Ann
</span><a href="Unison.Merge.Diff.html#expectDecl"><span class="hs-identifier hs-var hs-var">expectDecl</span></a></span></span><span> </span><span id="local-6989586621679195447"><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195447"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621679195448"><span class="annot"><span class="annottext">Map TermReferenceId (Decl Symbol Ann)
</span><a href="#local-6989586621679195448"><span class="hs-identifier hs-var">declsById</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TermReferenceId
-&gt; Map TermReferenceId (Decl Symbol Ann) -&gt; Maybe (Decl Symbol Ann)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195447"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Decl Symbol Ann)
</span><a href="#local-6989586621679195448"><span class="hs-identifier hs-var">declsById</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Decl Symbol Ann)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Decl Symbol Ann
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;E663160&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;type ref &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId
</span><a href="#local-6989586621679195447"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; not found in map &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Decl Symbol Ann) -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map TermReferenceId (Decl Symbol Ann)
</span><a href="#local-6989586621679195448"><span class="hs-identifier hs-var">declsById</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195449"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621679195449"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621679195449"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-304"></span></pre></body></html>